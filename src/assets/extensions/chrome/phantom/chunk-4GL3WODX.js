import{a as W}from"./chunk-QQJPKFTO.js";import{b as q,m as ge}from"./chunk-5NEPC5CX.js";import{a as R,b as M}from"./chunk-JQE54VLJ.js";import{Na as he,d as H}from"./chunk-KWNEQJE2.js";import{j as k}from"./chunk-HGG2EQ5O.js";import{a as T}from"./chunk-ZGQB4B3Z.js";import{a as de}from"./chunk-OJPBMZQC.js";import{a as K}from"./chunk-CYENH7PC.js";import{H as re,Ka as me,Q as D,Ta as n,Z as ae,fa as oe,ga as ie,ha as ne,la as ce}from"./chunk-F236ETGH.js";import{Za as le}from"./chunk-QF7OLC35.js";import{Fc as Y,Gc as O,Hc as E,Kc as p,Rc as J,Re as se,Sc as X,Uc as Q,Xc as Z,_d as V,de as ee,ed as L,he as te,je as I}from"./chunk-LPV5DSV2.js";import{y as w}from"./chunk-JYKVQ4NC.js";import{a,g as v,i as c,j as d,n as m}from"./chunk-TSHWMJEM.js";c();m();var u=v(K());c();m();var be=a(t=>typeof t=="object"&&t!==null&&"localVersion"in t&&"remoteVersion"in t&&"remoteState"in t&&"eventVersions"in t,"isNamespaceState"),P=a(t=>be(t)?t:{localVersion:0,remoteVersion:0,remoteState:null,eventVersions:{change:0,idle:0}},"parseNamespaceState");var U=a(t=>typeof t=="object"&&t!==null?t:{},"parseNamespaceItems");var B="mmkv:state:",F="mmkv:items:",ve="mmkv:",_=a(t=>`${B}${t}`,"namespaceStateKey"),N=a(t=>`${F}${t}`,"namespaceItemsKey"),Oe=a(t=>t.startsWith(B),"isNamespaceStateKey"),Ke=a(t=>t.startsWith(F),"isNamespaceItemsKey"),_e=a(t=>typeof t=="object"&&t!==null&&"method"in t&&typeof t.method=="string"&&t.method.startsWith(ve),"isMMKVMessage"),x=class{static{a(this,"ExtensionBackingStore")}stateCache={};itemsCache={};callbacks={};config;constructor(e={isWriter:!1}){this.config=e}async init(e){let r=await u.default.storage.local.get([...e.map(s=>_(s.key)),...e.map(s=>N(s.key))]);for(let s of e){let o=s.key,i=_(o),h=N(o);this.stateCache[o]=P(r[i]),this.itemsCache[o]=U(r[h])}u.default.storage.local.onChanged.addListener(s=>{let o=[];for(let[i,h]of Object.entries(s))if(Oe(i)){let l=i.slice(B.length);this.stateCache[l]=P(h.newValue),o.push(l)}else if(Ke(i)){let l=i.slice(F.length);this.itemsCache[l]=U(h.newValue)}for(let i of o)this.callbacks[i]?.forEach(l=>l(this.stateCache[i]))}),this.config.isWriter&&this.setupWriterMessageHandler()}setupWriterMessageHandler(){if(!this.config.onRegisterMessageHandler)throw new Error("ExtensionBackingStore: onRegisterMessageHandler callback is required for writer mode. The service worker should route MMKV messages to the handler to avoid race conditions from multiple browser.runtime.onMessage.addListener calls.");let e=a(r=>{let s;if(typeof r=="string")try{s=M(r)}catch{return}else s=r;if(_e(s))return this.handleWriteMessage(s)},"handler");this.config.onRegisterMessageHandler(e)}async handleWriteMessage(e){try{switch(e.method){case"mmkv:setNamespace":await this.performSetNamespace(e.params.namespace,e.params.value);break;case"mmkv:setItem":await this.performSetItem(e.params.namespace,e.params.schema,e.params.item,e.params.value);break;case"mmkv:deleteItem":await this.performDeleteItem(e.params.namespace,e.params.schema,e.params.item);break;case"mmkv:clear":await this.performClear();break}return{success:!0}}catch(r){let s=r instanceof Error?r.message:String(r);return console.error("[MMKV] Write operation failed:",s),{success:!1,error:s}}}async sendWriteMessage(e){let r=await u.default.runtime.sendMessage(R(e)),s=this.extractWriteResponse(r);if(!s.success)throw new Error(s.error)}extractWriteResponse(e){let r=typeof e=="string"?M(e):e;if(typeof r=="object"&&r!==null&&"result"in r&&r.jsonrpc==="2.0"){let s=r.result;if(this.isMMKVWriteResponse(s))return s;throw new Error(`Invalid MMKV response in RPC result: ${JSON.stringify(s)}`)}if(this.isMMKVWriteResponse(r))return r;if(typeof r=="object"&&r!==null&&"error"in r&&r.jsonrpc==="2.0"){let s=r.error;throw new Error(`RPC error: ${s.message??"Unknown error"}`)}throw new Error(`Invalid response from writer: ${JSON.stringify(e)}`)}isMMKVWriteResponse(e){if(typeof e!="object"||e===null)return!1;let r=e;return r.success===!0||r.success===!1&&typeof r.error=="string"}onNamespaceChange(e,r){let s=r,o=this.callbacks[e]??(this.callbacks[e]=[]);return o.push(s),()=>{o.splice(o.indexOf(s),1)}}getNamespace(e){return this.stateCache[e]??null}async setNamespace(e,r){if(this.config.isWriter)await this.performSetNamespace(e,r);else{let s=this.stateCache[e];this.stateCache[e]=r;try{await this.sendWriteMessage({method:"mmkv:setNamespace",params:{namespace:e,value:r}})}catch(o){throw s!==void 0?this.stateCache[e]=s:delete this.stateCache[e],o}}}async performSetNamespace(e,r){this.stateCache[e]=r,await u.default.storage.local.set({[_(e)]:r})}getItem(e,r,s){let o=`${r}:${s}`;return(this.itemsCache[e]??{})[o]??null}async setItem(e,r,s,o){let i=`${r}:${s}`;if(this.config.isWriter)await this.performSetItem(e,r,s,o);else{let h=e in this.itemsCache,l=this.itemsCache[e]?.[i];this.itemsCache[e]||(this.itemsCache[e]={}),this.itemsCache[e][i]=o;try{await this.sendWriteMessage({method:"mmkv:setItem",params:{namespace:e,schema:r,item:s,value:o}})}catch(z){throw h?l!==void 0?this.itemsCache[e][i]=l:delete this.itemsCache[e][i]:delete this.itemsCache[e],z}}}async performSetItem(e,r,s,o){let i=`${r}:${s}`;this.itemsCache[e]||(this.itemsCache[e]={}),this.itemsCache[e][i]=o,await u.default.storage.local.set({[N(e)]:this.itemsCache[e]})}async deleteItem(e,r,s){let o=`${r}:${s}`;if(this.config.isWriter)await this.performDeleteItem(e,r,s);else{let i=this.itemsCache[e]?.[o];this.itemsCache[e]&&delete this.itemsCache[e][o];try{await this.sendWriteMessage({method:"mmkv:deleteItem",params:{namespace:e,schema:r,item:s}})}catch(h){throw i!==void 0&&(this.itemsCache[e]||(this.itemsCache[e]={}),this.itemsCache[e][o]=i),h}}}async performDeleteItem(e,r,s){let o=`${r}:${s}`;this.itemsCache[e]&&delete this.itemsCache[e][o],await u.default.storage.local.set({[N(e)]:this.itemsCache[e]})}async clear(){if(this.config.isWriter)await this.performClear();else{let e={...this.stateCache},r={...this.itemsCache},s={...this.callbacks};this.stateCache={},this.itemsCache={},this.callbacks={};try{await this.sendWriteMessage({method:"mmkv:clear"})}catch(o){throw this.stateCache=e,this.itemsCache=r,this.callbacks=s,o}}}async performClear(){await Promise.all([...Object.keys(this.stateCache).map(e=>u.default.storage.local.remove(_(e))),...Object.keys(this.itemsCache).map(e=>u.default.storage.local.remove(N(e)))]),this.stateCache={},this.itemsCache={},this.callbacks={}}};c();m();c();m();var S={Accounts:`${D}.accounts`,SecretIdentifiers:`${D}.secrets`},pe=[{legacyKeys:[n.AccountsMetadata],targetSchema:"accounts",targetKey:n.AccountsMetadata,migrate:a(t=>t[n.AccountsMetadata],"migrate")}],ue=[{legacyKeys:[n.DeveloperMode],targetSchema:"accounts",targetKey:n.DeveloperMode,migrate:a(t=>t[n.DeveloperMode],"migrate")},{legacyKeys:[n.NetworkSetting],targetSchema:"accounts",targetKey:n.NetworkSetting,migrate:a(t=>t[n.NetworkSetting],"migrate")},{legacyKeys:[n.SelectedAccount],targetSchema:"accounts",targetKey:n.SelectedAccount,migrate:a(t=>t[n.SelectedAccount],"migrate")},{legacyKeys:[n.AccountsBalanceMetadata],targetSchema:"accounts",targetKey:n.AccountsBalanceMetadata,migrate:a(t=>t[n.AccountsBalanceMetadata],"migrate")},{legacyKeys:[n.MigratedWithInvalidChecksum],targetSchema:"accounts",targetKey:n.MigratedWithInvalidChecksum,migrate:a(t=>t[n.MigratedWithInvalidChecksum],"migrate")},{legacyKeys:[n.TermsHaveBeenAcknowledgedLastSeenVersion],targetSchema:"accounts",targetKey:n.TermsHaveBeenAcknowledgedLastSeenVersion,migrate:a(t=>t[n.TermsHaveBeenAcknowledgedLastSeenVersion],"migrate")},{legacyKeys:[n.NotificationsHaveBeenAcknowledgedLastSeenVersion],targetSchema:"accounts",targetKey:n.NotificationsHaveBeenAcknowledgedLastSeenVersion,migrate:a(t=>t[n.NotificationsHaveBeenAcknowledgedLastSeenVersion],"migrate")}],fe=[{legacyKeys:[S.Accounts],targetSchema:"vault",targetKey:S.Accounts,migrate:a(t=>t[S.Accounts],"migrate")},{legacyKeys:[S.SecretIdentifiers],targetSchema:"vault",targetKey:S.SecretIdentifiers,migrate:a(t=>t[S.SecretIdentifiers],"migrate")}];c();m();c();m();var g;(function(t){t.DismissedActionBanners="dismissedActionBanners",t.AppLaunchTimes="appLaunchTimes",t.LastOnboardedAt="lastOnboardedAt",t.DismissedContentCards=".phantom.interstitials.contentCards.dismissed"})(g||(g={}));var ye=[{legacyKeys:[g.DismissedActionBanners],targetSchema:"interstitials",targetKey:k.DismissedActionBanners,migrate:a(t=>t[g.DismissedActionBanners],"migrate")},{legacyKeys:[g.AppLaunchTimes],targetSchema:"interstitials",targetKey:k.AppLaunchTimes,migrate:a(t=>t[g.AppLaunchTimes],"migrate")},{legacyKeys:[g.LastOnboardedAt],targetSchema:"interstitials",targetKey:k.LastOnboardedAt,migrate:a(t=>t[g.LastOnboardedAt],"migrate")},{legacyKeys:[g.DismissedContentCards],targetSchema:"interstitials",targetKey:k.DismissedContentCards,migrate:a(t=>t[g.DismissedContentCards],"migrate")}];c();m();var xe={enabled:!0,clientToken:d.DATADOG_CLIENT_TOKEN,applicationId:"3f3bc3b0-8d80-4b31-b4b9-9909de4d243a",service:"browser-ext-frontend",traceSampleRate:1,sessionSampleRate:1},Le={enabled:!0,dsn:"https://pub5df2cf131c51c4215f2ca3aa32d4e4b7@sentry-intake.datadoghq.com/1",sampleRate:.1,tracesSampleRate:0,initialScope:{tags:{service:"browser-ext-background",version:w}}};async function G(t,e){await p.init({appVersion:w,sentry:t==="frontend"?{enabled:!1}:Le,datadog:t==="frontend"?xe:{enabled:!1}}),e&&await p.setUser({id:e})}a(G,"initTelemetry");c();m();var $=class{static{a(this,"NetworkLogger")}requests=[];maxRequests=0;allowedDomains=["phantom.app","phantom.com"];ignoredHosts=new Set;ignoredUrls=new Set;ignoredPatterns;init(e={maxRequests:20,ignoredUrls:[],ignoredHosts:[]}){this.maxRequests=e.maxRequests,this.ignoredUrls=new Set(e.ignoredUrls),this.ignoredHosts=new Set(e.ignoredHosts);let r=self.fetch;self.fetch=async(...s)=>{let[o,i]=s,h=i?.method||"GET",l={};if(i?.headers instanceof Headers?i.headers.forEach((C,A)=>{l[A]=C}):Array.isArray(i?.headers)?i.headers.forEach(([C,A])=>{l[C]=A}):l=i?.headers||{},this.shouldIgnoreRequest(o.toString()))return r(...s);let y={id:`${Date.now()}-${Math.random()}`,method:h,url:o.toString(),requestHeaders:l,startTime:Date.now()};this.requests.length>=this.maxRequests&&this.requests.pop(),this.requests.unshift(y);let b=await r(...s),Ne=await b.clone().text();return y.status=b.status,y.responseHeaders={},b.headers.forEach((C,A)=>{y.responseHeaders[A]=C}),y.endTime=Date.now(),y.response=Ne,b}}shouldIgnoreRequest(e){try{let r=new URL(e).hostname;return this.ignoredHosts&&this.ignoredHosts.has(r)||this.ignoredUrls&&this.ignoredUrls.has(e)||!this.allowedDomains.some(s=>r.includes(s))?!0:!!(this.ignoredPatterns&&this.ignoredPatterns.some(s=>s.test(e)))}catch{return!0}}getRequests(){return this.requests}clearRequests(){this.requests=[]}setIgnoredHosts(e){this.ignoredHosts=new Set(e)}setIgnoredUrls(e){this.ignoredUrls=new Set(e)}setIgnoredPatterns(e){this.ignoredPatterns=e}clearIgnoredHosts(){this.ignoredHosts=new Set}clearIgnoredUrls(){this.ignoredUrls=new Set}clearIgnoredPatterns(){this.ignoredPatterns=void 0}},Ve=new $,Se=Ve;var f,Ae,qt=a(t=>Ae?.(t),"handleMMKVMessage"),Pt=a(t=>{f?.sendEvent(t)},"sendMMKVUpdateEvent"),Ce=a(()=>f?.getNamespace(V),"getFlagNamespace"),Ut=a(async()=>{if(f)try{await f.getNamespace(L).refreshRemoteState()}catch(t){p.addBreadcrumb(E.Storage,"[MMKV] Failed to refresh synced storage",O.Error,{error:String(t)})}},"refreshSyncedStorage"),we=se(t=>{Ce()?.updateRemoteState(e=>({overrides:e?.overrides??{},eppoConfig:e?.eppoConfig??{},userId:t})),Ce()?.invalidate()}),De=a(async(t,e,r)=>{if(f)return;let s={apiKey:te,deviceId:e,subjectAttributes:{appVersion:w,platform:"browser-ext",deviceId:e},pollingEnabled:t==="background",analytics:T,logTelemetry:a(i=>{p.addBreadcrumb(E.FeatureFlags,i,O.Info,{skipFileLogger:!0})},"logTelemetry"),telemetry:p},o=t==="background";f=await Y({backingStore:new x({isWriter:o,onRegisterMessageHandler:o?i=>Ae=i:void 0}),namespaces:[V.withDeps(s),X.withDeps({legacyStorage:W,migrations:[...ye,...ue,...fe,...le]}),L.withDeps({authRepository:r,legacyStorage:W,migrations:[...H,...pe]})],initDeadline:t==="frontend"?0:5e3}),t==="background"&&f.sendEvent("idle")},"initializeMMKV"),Bt=a(async()=>{f&&await f.reset()},"resetMMKV"),Ft=a(async(t,e)=>{try{let r=await T.getDeviceId();await G(t,r),await De(t,r,e),await We(),Q(r),Z({getSampleRate:a(()=>ee("http-error-reporting-sample-rate"),"getSampleRate"),addBreadcrumb:a((s,o,i,h)=>p.addBreadcrumb(E.Network,o,O.Info,h),"addBreadcrumb")})}catch(r){await G(t),p.captureError(r,E.StartUp)}},"telemetryInitializeFeatureFlags"),We=a(()=>{let t=I.getMultivariateAssignment("network-logger-config-json");if(t)try{let e=JSON.parse(t),r=J.parse(e);Se.init({ignoredHosts:r.ignoredHosts,maxRequests:r.maxRequests,ignoredUrls:r.ignoredUrls})}catch(e){console.error("Error initializing network logger",e)}},"initializeNetworkLogging");c();m();c();m();var Ee=v(K());c();m();var Re=v(K());var He=a(()=>{if(d.ENVIRONMENT!=="e2e")return null;let t=globalThis.__PHANTOM_E2E_SEEDLESS_AUTH_CODE__;return typeof t=="string"&&t.length>0?t:null},"getE2ESeedlessAuthCode"),Me=a(async(t,e,r)=>{let s=He();if(s)return s;let o=await Re.default.identity.launchWebAuthFlow({interactive:r,url:e});if(!ne(t,o))return ie(t,o);throw new Error("Error fetching auth code")},"fetchExtensionAuthCode");var Ie={getClientID:ce,redirectURL:Ee.default.identity.getRedirectURL(),fetchAuthorizationCode:a((t,e,r)=>Me(t,e,r),"fetchAuthorizationCode")};c();m();var j=v(K(),1);var qe=a(async()=>{let t=q("serviceWorkerMutexAcquire",void 0),e=M(await j.default.runtime.sendMessage(R(t)));if("error"in e)throw new Error(e.error.message);return()=>{let r=q("serviceWorkerMutexRelease",void 0);j.default.runtime.sendMessage(R(r))}},"acquire"),ke=a(async t=>{let e=await qe();try{return await t()}finally{e()}},"runExclusiveWithServiceWorker");var Te=ge(),Pe={storage:new de,signer:{sign:a((t,e)=>re(Te,t,e),"sign"),getAuthenticationPublicKey:a(t=>Te.getAuthenticationPublicKey(t),"getAuthenticationPublicKey"),getAllSecretIdentifiers:me},authConfig:Ie,queryClient:he,runExclusive:ke,isLocalTokenValidityCheckEnabled:a(()=>!I.isFeatureEnabled("kill-frontend-local-check"),"isLocalTokenValidityCheckEnabled"),isServerTimeEnabled:a(()=>!I.isFeatureEnabled("kill-frontend-server-time"),"isServerTimeEnabled")},Ue=oe(Pe);Ue.subscribe(ae.UserID,t=>{T.addUserProperties({authUserId:t}),we(t)});export{ve as a,Se as b,qt as c,Pt as d,Ut as e,Bt as f,Ft as g,Ie as h,Ue as i};
//# sourceMappingURL=chunk-4GL3WODX.js.map
