import{i as w}from"./chunk-4GL3WODX.js";import{Na as F}from"./chunk-KWNEQJE2.js";import{a as E}from"./chunk-ZGQB4B3Z.js";import{Yb as W,ab as M}from"./chunk-F236ETGH.js";import{a as n,i as d,n as l}from"./chunk-TSHWMJEM.js";d();l();var I=W({authRepository:w,queryClient:F});d();l();var P=new M(E,w,I);d();l();d();l();d();l();var h=n(o=>`sq:doc:value:${o}`,"valueKeyFor"),v=n(o=>`sq:doc:refCount:${o}`,"refCountKeyFor"),g=n(o=>`sq:doc:refIds:${o}`,"refIdsKeyFor"),y=n(o=>`sq:doc:updatedAt:${o}`,"updatedAtKeyFor"),p=n(o=>`sq:doc:streamOrphanRefs:${o}`,"streamOrphanRefsKeyFor"),A=n(o=>`sq:doc:optimisticInsertRefs:${o}`,"optimisticInsertRefsKeyFor"),Q=n(o=>`sq:doc:queue:${o}`,"queueKeyFor"),b=50,S=1e3*60*60*24;var R=class{static{n(this,"AsyncQueryStore")}isWriter;delegate;sendMessage;messageQueue=[];queues=new Map;queueProcessorPromise;resolveQueueWait;constructor(e){this.isWriter=e.isWriter,this.delegate=e.delegate;let{sendMessage:s}=e.connect(this.handleMessage.bind(this));if(this.sendMessage=s,this.isWriter){if(!this.delegate)throw new Error("Writer must have a delegate");this.startQueueProcessor()}}handleMessage(e){this.isWriter&&this.enqueueMessage(e)}enqueueMessage(e){this.messageQueue.push(e),this.resolveQueueWait&&(this.resolveQueueWait(),this.resolveQueueWait=void 0)}startQueueProcessor(){this.queueProcessorPromise=this.processQueue()}async processQueue(){for(;;){for(;this.messageQueue.length===0;)await new Promise(s=>{this.resolveQueueWait=s});let e=this.messageQueue.shift();try{await this.processMessage(e)}catch(s){console.error("Error processing message:",s)}}}async processMessage(e){switch(e.type){case"saveQuery":await this.writerSaveQuery(e.queryDefId,e.queryKey,e.value,e.updatedAt,e.refIds,e.extra);break;case"saveEntity":await this.writerSaveEntity(e.entityKey,e.value,e.refIds);break;case"activateQuery":await this.writerActivateQuery(e.queryDefId,e.queryKey);break;case"deleteQuery":await this.writerDeleteValue(e.queryKey);break}}async loadQuery(e,s,t){if(!this.delegate)return;let i=await this.delegate.getNumber(y(s));if(i===void 0||i<Date.now()-(e.cache?.gcTime??S))return;let r=await this.delegate.getString(h(s));if(r===void 0)return;let a=await this.delegate.getBuffer(g(s));a!==void 0&&await this.preloadEntities(a,t);let u=await this.delegate.getBuffer(p(s)),c=await this.delegate.getBuffer(A(s));u!==void 0&&await this.preloadEntities(u,t),c!==void 0&&await this.preloadEntities(c,t);let f;return(u!==void 0||c!==void 0)&&(f={},u!==void 0&&(f.streamOrphanRefs=Array.from(u)),c!==void 0&&(f.optimisticInsertRefs=Array.from(c))),this.activateQuery(e,s),{value:JSON.parse(r),refIds:a===void 0?void 0:new Set(a??[]),updatedAt:i,extra:f}}async preloadEntities(e,s){if(this.delegate)for(let t of e){let i=await this.delegate.getString(h(t));if(i===void 0)continue;let r=JSON.parse(i);s.setPreloadedEntity(t,r);let a=await this.delegate.getBuffer(g(t));a!==void 0&&await this.preloadEntities(a,s)}}saveQuery(e,s,t,i,r,a){let u={type:"saveQuery",queryDefId:e.id,queryKey:s,value:t,updatedAt:i,refIds:r?Array.from(r):void 0,extra:a};this.isWriter?this.enqueueMessage(u):this.sendMessage(u)}saveEntity(e,s,t){let i={type:"saveEntity",entityKey:e,value:s,refIds:t?Array.from(t):void 0};this.isWriter?this.enqueueMessage(i):this.sendMessage(i)}activateQuery(e,s){let t={type:"activateQuery",queryDefId:e.id,queryKey:s};this.isWriter?this.enqueueMessage(t):this.sendMessage(t)}deleteQuery(e){let s={type:"deleteQuery",queryKey:e};this.isWriter?this.enqueueMessage(s):this.sendMessage(s)}async writerSaveQuery(e,s,t,i,r,a){await this.setValue(s,t,r?new Set(r):void 0),await this.delegate.setNumber(y(s),i),a?.streamOrphanRefs!==void 0&&a.streamOrphanRefs.length>0?await this.delegate.setBuffer(p(s),new Uint32Array(a.streamOrphanRefs)):await this.delegate.delete(p(s)),a?.optimisticInsertRefs!==void 0&&a.optimisticInsertRefs.length>0?await this.delegate.setBuffer(A(s),new Uint32Array(a.optimisticInsertRefs)):await this.delegate.delete(A(s)),await this.writerActivateQuery(e,s)}async writerSaveEntity(e,s,t){await this.setValue(e,s,t?new Set(t):void 0)}async writerActivateQuery(e,s){if(!await this.delegate.has(h(s)))return;let t=this.queues.get(e);if(t===void 0){let a=b;t=await this.delegate.getBuffer(Q(e)),t===void 0?(t=new Uint32Array(a),await this.delegate.setBuffer(Q(e),t)):t.length!==a&&(t=new Uint32Array(t.buffer,0,a),await this.delegate.setBuffer(Q(e),t)),this.queues.set(e,t)}let i=t.indexOf(s);if(i>=0){if(i===0)return;t.copyWithin(1,0,i),t[0]=s;return}let r=t[t.length-1];t.copyWithin(1,0,t.length-1),t[0]=s,r!==0&&(await this.writerDeleteValue(r),await this.delegate.delete(y(r)))}async setValue(e,s,t){let i=this.delegate;await i.setString(h(e),JSON.stringify(s));let r=g(e),a=await i.getBuffer(r);if(t===void 0||t.size===0){if(await i.delete(r),a!==void 0)for(let u=0;u<a.length;u++){let c=a[u];await this.decrementRefCount(c)}}else{let u=new Uint32Array([...t]);if(a!==void 0)for(let c=0;c<a.length;c++){let f=a[c];t.has(f)?t.delete(f):await this.decrementRefCount(f)}for(let c of t)await this.incrementRefCount(c);await i.setBuffer(r,u)}}async writerDeleteValue(e){let s=this.delegate;await s.delete(h(e)),await s.delete(v(e));let t=await s.getBuffer(g(e));if(await s.delete(g(e)),t!==void 0)for(let i of t)i!==0&&await this.decrementRefCount(i)}async incrementRefCount(e){let s=this.delegate,t=v(e),r=(await s.getNumber(t)??0)+1;await s.setNumber(t,r)}async decrementRefCount(e){let s=this.delegate,t=v(e),i=await s.getNumber(t);if(i===void 0)return;let r=i-1;r===0?await this.writerDeleteValue(e):await s.setNumber(t,r)}};var C=class{static{n(this,"ChromeExtensionPersistentStore")}async has(e){let s=await chrome.storage.local.get(e);return e in s}async getString(e){let t=(await chrome.storage.local.get(e))[e];return t===void 0?void 0:String(t)}async setString(e,s){await chrome.storage.local.set({[e]:s})}async getNumber(e){let t=(await chrome.storage.local.get(e))[e];return t===void 0?void 0:Number(t)}async setNumber(e,s){await chrome.storage.local.set({[e]:s})}async getBuffer(e){let t=(await chrome.storage.local.get(e))[e];if(t!==void 0&&Array.isArray(t))return new Uint32Array(t)}async setBuffer(e,s){await chrome.storage.local.set({[e]:Array.from(s)})}async delete(e){await chrome.storage.local.remove(e)}};function N(o){let e=o.portName??"signalium-query-store";return s=>{if(o.isWriter)return chrome.runtime.onConnect.addListener(t=>{t.name===e&&t.onMessage.addListener(i=>{s(i)})}),{sendMessage:n(()=>{},"sendMessage")};{let t=chrome.runtime.connect({name:e});return{sendMessage:n(i=>{try{t.postMessage(i)}catch(r){console.error("Failed to send message to background:",r)}},"sendMessage")}}}}n(N,"createChromeExtensionConnection");var se=n((o={isWriter:!1})=>new R({isWriter:o?.isWriter??!1,connect:N(o),delegate:o.isWriter?new C:void 0}),"createChromeStorageStore");export{I as a,P as b,se as c};
//# sourceMappingURL=chunk-4Q7PWTAO.js.map
