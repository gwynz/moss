LavaPack.loadBundle([[333,{"../../../shared/lib/snaps/snaps":6294,"@metamask/rpc-errors":3026,"@metamask/snaps-sdk":3265},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.default=function({allowedOrigins:e,errorMessage:t="Cannot process requests at this time",state:r}){return function(s,a,l,c){if(!r.isBlocked)return l();const{origin:d}=s;if(!d)return c(new i.InternalError(`No origin specified for request with method ${s.method}`));return e.includes(d)||(0,o.isSnapPreinstalled)(d)?l():c(n.rpcErrors.resourceUnavailable(t))}};var n=e("@metamask/rpc-errors"),i=e("@metamask/snaps-sdk"),o=e("../../../shared/lib/snaps/snaps")}}},{package:"$root$",file:"app/scripts/lib/rpcBlockingMiddleware.ts"}],[334,{"./operation-safener":310,loglevel:5247,"webextension-polyfill":6163},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.getRequestSafeReload=function(e){const t=new o.OperationSafener({op:async t=>{try{if("data"===e.storageKind){if(!t)throw new Error("State must be provided for 'data' storageKind");await e.set(t)}else await e.persist()}catch(e){i.default.error("MetaMask - Persistence failed",e),null==a||a.captureException(e)}},wait:1e3});return{safePersist:async(...e)=>t.execute(...e),requestSafeReload:async()=>{await t.evacuate(),n.default.runtime.reload()},evacuate:()=>t.evacuate()}};var n=s(e("webextension-polyfill")),i=s(e("loglevel")),o=e("./operation-safener");function s(e){return e&&e.__esModule?e:{default:e}}const{sentry:a}=global}}},{package:"$root$",file:"app/scripts/lib/safe-reload.ts"}],[339,{"../../../../shared/lib/trace":6299},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.addPersonalMessage=async function({signatureParams:e,signatureController:t}){return i(e,t,"newUnsignedPersonalMessage")},r.addTypedMessage=async function({signatureParams:e,signatureController:t}){return i(e,t,"newUnsignedTypedMessage")};var n=e("../../../../shared/lib/trace");async function i(e,t,r){const[i,o,s,a]=e,{id:l,method:c,params:d}=o,u={id:l,method:c,params:d,origin:s.get("origin"),networkClientId:s.get("networkClientId"),securityAlertResponse:s.get("securityAlertResponse")},p=null==l?void 0:l.toString();(0,n.endTrace)({name:n.TraceName.Middleware,id:p});const h=await t[r](i,u,a);return(0,n.endTrace)({name:n.TraceName.Signature,id:p}),h}}}},{package:"$root$",file:"app/scripts/lib/signature/util.ts"}],[34,{"./claims-controller-init":32,"./claims-service-init":33},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"ClaimsControllerInit",{enumerable:!0,get:function(){return n.ClaimsControllerInit}}),Object.defineProperty(r,"ClaimsServiceInit",{enumerable:!0,get:function(){return i.ClaimsServiceInit}});var n=e("./claims-controller-init"),i=e("./claims-service-init")}}},{package:"$root$",file:"app/scripts/controller-init/claims/index.ts"}],[340,{"../../../../shared/constants/app":6175,"../../../../shared/constants/smartTransactions":6204,"../../../../shared/modules/conversion.utils":6315,"../../../../shared/modules/selectors":6333,"../../../../shared/modules/selectors/networks":6335,"../../../../shared/modules/transaction.utils":6348,"../transaction/util":374,"./utils":341,"@metamask/smart-transactions-controller":3071,"@metamask/transaction-controller":3473,loglevel:5247},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.getSmartTransactionCommonParams=function(e,t){const r=function(e){return{metamask:e}}(e),n=t??(0,u.getCurrentChainId)(r),i=(0,d.getIsSmartTransaction)(r,t),o=(0,d.getSmartTransactionsFeatureFlagsForChain)(r,n),s=(0,d.isHardwareWallet)(r);return{isSmartTransaction:i,featureFlags:o,isHardwareWalletAccount:s}},r.submitSmartTransactionHook=r.submitBatchSmartTransactionHook=void 0;var n,i=e("@metamask/smart-transactions-controller"),o=e("@metamask/transaction-controller"),s=(n=e("loglevel"))&&n.__esModule?n:{default:n},a=e("../../../../shared/constants/app"),l=e("../../../../shared/constants/smartTransactions"),c=e("../../../../shared/modules/conversion.utils"),d=e("../../../../shared/modules/selectors"),u=e("../../../../shared/modules/selectors/networks"),p=e("../../../../shared/modules/transaction.utils"),h=e("../transaction/util"),m=e("./utils");function g(e,t,r){f(e,t),t.set(e,r)}function f(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function y(e,t){return e.get(b(e,t))}function C(e,t,r){return e.set(b(e,t),r),r}function b(e,t,r){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:r;throw new TypeError("Private element is not present on this object")}var v=new WeakMap,w=new WeakMap,S=new WeakMap,T=new WeakMap,k=new WeakMap,A=new WeakMap,M=new WeakMap,P=new WeakMap,E=new WeakMap,I=new WeakMap,_=new WeakMap,O=new WeakMap,R=new WeakMap,N=new WeakMap,D=new WeakSet;class F{constructor(e){!function(e,t){f(e,t),t.add(e)}(this,D),g(this,v,void 0),g(this,w,void 0),g(this,S,void 0),g(this,T,void 0),g(this,k,void 0),g(this,A,void 0),g(this,M,void 0),g(this,P,void 0),g(this,E,void 0),g(this,I,void 0),g(this,_,void 0),g(this,O,void 0),g(this,R,void 0),g(this,N,void 0);const{transactionMeta:t,signedTransactionInHex:r,smartTransactionsController:n,transactionController:i,isSmartTransaction:l,controllerMessenger:c,featureFlags:d,transactions:u}=e;C(w,this,""),C(v,this,!1),C(I,this,t),C(_,this,r),C(P,this,n),C(E,this,i),C(M,this,l),C(T,this,c),C(k,this,d),C(A,this,t.origin!==a.ORIGIN_METAMASK),C(S,this,t.chainId),C(R,this,t.txParams),C(O,this,u);const p=null==d?void 0:d.extensionSkipSmartTransactionStatusPage;C(N,this,!p&&Boolean(t.type!==o.TransactionType.bridge&&t.type!==o.TransactionType.shieldSubscriptionApprove||y(O,this)&&y(O,this).length>0)),s.default.info("[SmartTransaction] shouldShowStatusPage:",y(N,this))}async submit(){const e=!!y(I,this).type&&[o.TransactionType.swapAndSend,o.TransactionType.swapApproval,o.TransactionType.bridgeApproval].includes(y(I,this).type),t={transactionHash:undefined};if(!y(M,this)||e||(0,p.isLegacyTransaction)(y(I,this)))return t;let r;if(y(N,this)&&await b(D,this,B).call(this),!y(_,this)||!y(I,this).isGasFeeSponsored)try{r=await y(P,this).getFees({...y(R,this),chainId:y(S,this)},undefined,{networkClientId:y(I,this).networkClientId})}catch(e){return s.default.error("Error in smart transaction publish hook, falling back to regular transaction submission",e),b(D,this,L).call(this),t}try{var n;const e=await b(D,this,H).call(this,{getFeesResponse:r}),t=null==e?void 0:e.uuid;if(!t)throw new Error("No smart transaction UUID");await b(D,this,U).call(this,t);let i;if(i=(null===(n=y(k,this))||void 0===n?void 0:n.extensionReturnTxHashAsap)&&null!=e&&e.txHash?e.txHash:await b(D,this,q).call(this,{uuid:t}),null===i)throw new Error("Transaction does not have a transaction hash, there was a problem");return{transactionHash:i}}catch(e){throw s.default.error("Error in smart transaction publish hook",e),b(D,this,L).call(this),e}}async submitBatch(){if(!y(M,this))throw new Error("submitBatch: Smart Transaction is required for batch submissions");y(N,this)&&await b(D,this,B).call(this);try{var e,t;const r=await b(D,this,H).call(this),n=null==r?void 0:r.uuid;if(!n)throw new Error("submitBatch: No smart transaction UUID");let i;await b(D,this,U).call(this,n),i=null!=r&&r.txHashes?{results:r.txHashes.map(e=>({transactionHash:e}))}:{results:[]};if((null===(e=y(k,this))||void 0===e?void 0:e.extensionReturnTxHashAsapBatch)&&(null===(t=i)||void 0===t||null===(t=t.results)||void 0===t?void 0:t.length)>0)return i;if(null===await b(D,this,q).call(this,{uuid:n}))throw new Error("submitBatch: Transaction does not have a transaction hash, there was a problem");return i}catch(e){throw s.default.error("submitBatch: Error in smart transaction publish batch hook",e),b(D,this,L).call(this),e}}}async function x(e){try{await y(T,this).call("ApprovalController:endFlow",{id:e})}catch(e){}}async function j(e){try{await b(D,this,x).call(this,e),await y(T,this).call("ApprovalController:acceptRequest",e),Y._=""}catch(e){s.default.error("Error ending existing approval flow",e)}}async function B(){Y._&&await b(D,this,j).call(this,Y._);const{id:e}=await y(T,this).call("ApprovalController:startFlow");C(w,this,e),Y._=e}async function U(e){y(N,this)&&(b(D,this,G).call(this,{uuid:e}),b(D,this,$).call(this,{uuid:e}))}function L(){y(N,this)&&!y(v,this)&&(C(v,this,!0),b(D,this,x).call(this,y(w,this)),Y._===y(w,this)&&(Y._=""))}function G({uuid:e}){const t=()=>{b(D,this,L).call(this)};y(T,this).call("ApprovalController:addRequest",{id:y(w,this),origin:origin,type:a.SMART_TRANSACTION_CONFIRMATION_TYPES.showSmartTransactionStatusPage,requestState:{smartTransaction:{status:i.SmartTransactionStatuses.PENDING,creationTime:Date.now(),uuid:e,chainId:y(S,this)},isDapp:y(A,this),txId:y(I,this).id}},!0).then(t,t)}async function K({smartTransaction:e}){return await y(T,this).call("ApprovalController:updateRequestState",{id:y(w,this),requestState:{smartTransaction:e,isDapp:y(A,this),txId:y(I,this).id}})}async function $({uuid:e}){y(T,this).subscribe("SmartTransactionsController:smartTransaction",async t=>{if(t.uuid===e){const{status:e}=t;if(!e||e===i.SmartTransactionStatuses.PENDING)return;y(v,this)||await b(D,this,K).call(this,{smartTransaction:t})}})}function q({uuid:e}){return new Promise(t=>{y(T,this).subscribe("SmartTransactionsController:smartTransaction",async r=>{if(r.uuid===e){const{status:e,statusMetadata:n}=r;if(!e||e===i.SmartTransactionStatuses.PENDING)return;s.default.debug("Smart Transaction: ",r),null!=n&&n.minedHash?(s.default.debug("Smart Transaction - Received tx hash: ",null==n?void 0:n.minedHash),t(n.minedHash)):t(null)}})})}async function H({getFeesResponse:e}={}){let t=[],r=[];if(y(O,this)&&Array.isArray(y(O,this))&&y(O,this).length>0)t=y(O,this).filter(e=>null==e?void 0:e.signedTx).map(e=>{const t=(0,h.getTransactionById)(e.id??"",y(E,this)),r={tx:e.signedTx};return t&&(r.metadata={txType:t.type,client:(0,m.getClientForTransactionMetadata)(),origin:(0,m.sanitizeOrigin)(t.origin)}),r});else if(y(_,this))t=[{tx:y(_,this),metadata:{txType:y(I,this).type,client:(0,m.getClientForTransactionMetadata)(),origin:(0,m.sanitizeOrigin)(y(I,this).origin)}}];else if(e){var n;t=(await b(D,this,V).call(this,(null===(n=e.tradeTxFees)||void 0===n?void 0:n.fees)??[],!1)).map(e=>({tx:e,metadata:{txType:y(I,this).type,client:(0,m.getClientForTransactionMetadata)(),origin:(0,m.sanitizeOrigin)(y(I,this).origin)}}))}return r=t.map(e=>e.tx),await y(P,this).submitSignedTransactions({signedTransactions:r,signedTransactionsWithMetadata:t,signedCanceledTransactions:[],txParams:y(R,this),transactionMeta:y(I,this),networkClientId:y(I,this).networkClientId})}function W(e,t){if(!y(R,this))throw new Error("Transaction params are required");const r={...y(R,this),maxFeePerGas:`0x${(0,c.decimalToHex)(e.maxFeePerGas)}`,maxPriorityFeePerGas:`0x${(0,c.decimalToHex)(e.maxPriorityFeePerGas)}`,gas:t?`0x${(0,c.decimalToHex)(l.CANCEL_GAS_LIMIT_DEC)}`:y(R,this).gas};return t&&(r.to=r.from,r.data="0x"),r}async function V(e,t){if(!y(R,this)||!y(S,this))throw new Error("Transaction params and chainId are required");const r=e.map(e=>b(D,this,W).call(this,e,t)).map(e=>({...e,chainId:e.chainId||y(S,this)}));return await y(E,this).approveTransactionsWithSameNonce(r,{hasNonce:!0})}var Y={_:""};r.submitSmartTransactionHook=e=>new F(e).submit();r.submitBatchSmartTransactionHook=e=>new F(e).submitBatch()}}},{package:"$root$",file:"app/scripts/lib/smart-transaction/smart-transactions.ts"}],[3403,{"./types.cjs":3406},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n,i=this&&this.__classPrivateFieldSet||function(e,t,r,n,i){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?i.call(e,r):i?i.value=r:t.set(e,r),r},o=this&&this.__classPrivateFieldGet||function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};Object.defineProperty(r,"__esModule",{value:!0}),r.InMemoryStorageAdapter=void 0;const s=e("./types.cjs");r.InMemoryStorageAdapter=class{constructor(e){if(n.set(this,void 0),i(this,n,new Map,"f"),e)for(const[t,r]of Object.entries(e))for(const[e,i]of Object.entries(r)){const r=`${s.STORAGE_KEY_PREFIX}${t}:${e}`;o(this,n,"f").set(r,JSON.stringify(i))}}async getItem(e,t){const r=`${s.STORAGE_KEY_PREFIX}${e}:${t}`,i=o(this,n,"f").get(r);if(i===undefined)return{};try{return{result:JSON.parse(i)}}catch(e){return console.error(`Failed to parse stored data for ${r}:`,e),{error:e}}}async setItem(e,t,r){const i=`${s.STORAGE_KEY_PREFIX}${e}:${t}`;o(this,n,"f").set(i,JSON.stringify(r))}async removeItem(e,t){const r=`${s.STORAGE_KEY_PREFIX}${e}:${t}`;o(this,n,"f").delete(r)}async getAllKeys(e){const t=`${s.STORAGE_KEY_PREFIX}${e}:`;return Array.from(o(this,n,"f").keys()).filter(e=>e.startsWith(t)).map(e=>e.slice(t.length))}async clear(e){const t=`${s.STORAGE_KEY_PREFIX}${e}:`;Array.from(o(this,n,"f").keys()).filter(e=>e.startsWith(t)).forEach(e=>o(this,n,"f").delete(e))}},n=new WeakMap}}},{package:"@metamask/storage-service",file:"node_modules/@metamask/storage-service/dist/InMemoryStorageAdapter.cjs"}],[3404,{"./InMemoryStorageAdapter.cjs":3403,"./types.cjs":3406},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n,i,o=this&&this.__classPrivateFieldSet||function(e,t,r,n,i){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?i.call(e,r):i?i.value=r:t.set(e,r),r},s=this&&this.__classPrivateFieldGet||function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};Object.defineProperty(r,"__esModule",{value:!0}),r.StorageService=void 0;const a=e("./InMemoryStorageAdapter.cjs"),l=e("./types.cjs"),c=["setItem","getItem","removeItem","getAllKeys","clear"];r.StorageService=class{constructor({messenger:e,storage:t}){n.set(this,void 0),i.set(this,void 0),this.name=l.SERVICE_NAME,o(this,n,e,"f"),o(this,i,t??new a.InMemoryStorageAdapter,"f"),t||console.warn(`${l.SERVICE_NAME}: No storage adapter provided. Using in-memory storage. Data will be lost on restart. Provide a storage adapter for persistence.`),s(this,n,"f").registerMethodActionHandlers(this,c)}async setItem(e,t,r){await s(this,i,"f").setItem(e,t,r),s(this,n,"f").publish(`${l.SERVICE_NAME}:itemSet:${e}`,t,r)}async getItem(e,t){return await s(this,i,"f").getItem(e,t)}async removeItem(e,t){await s(this,i,"f").removeItem(e,t)}async getAllKeys(e){return await s(this,i,"f").getAllKeys(e)}async clear(e){await s(this,i,"f").clear(e)}},n=new WeakMap,i=new WeakMap}}},{package:"@metamask/storage-service",file:"node_modules/@metamask/storage-service/dist/StorageService.cjs"}],[3405,{"./InMemoryStorageAdapter.cjs":3403,"./StorageService.cjs":3404,"./types.cjs":3406},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.STORAGE_KEY_PREFIX=r.SERVICE_NAME=r.InMemoryStorageAdapter=r.StorageService=void 0;var n=e("./StorageService.cjs");Object.defineProperty(r,"StorageService",{enumerable:!0,get:function(){return n.StorageService}});var i=e("./InMemoryStorageAdapter.cjs");Object.defineProperty(r,"InMemoryStorageAdapter",{enumerable:!0,get:function(){return i.InMemoryStorageAdapter}});var o=e("./types.cjs");Object.defineProperty(r,"SERVICE_NAME",{enumerable:!0,get:function(){return o.SERVICE_NAME}}),Object.defineProperty(r,"STORAGE_KEY_PREFIX",{enumerable:!0,get:function(){return o.STORAGE_KEY_PREFIX}})}}},{package:"@metamask/storage-service",file:"node_modules/@metamask/storage-service/dist/index.cjs"}],[3406,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.STORAGE_KEY_PREFIX=r.SERVICE_NAME=void 0,r.SERVICE_NAME="StorageService",r.STORAGE_KEY_PREFIX="storageService:"}}},{package:"@metamask/storage-service",file:"node_modules/@metamask/storage-service/dist/types.cjs"}],[341,{"../../../../shared/constants/app":6175,"../../../../shared/constants/smartTransactions":6204,"../util":380},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.sanitizeOrigin=r.getClientForTransactionMetadata=void 0;var n=e("../../../../shared/constants/app"),i=e("../../../../shared/constants/smartTransactions"),o=e("../util");r.getClientForTransactionMetadata=()=>(0,o.getPlatform)()===n.PLATFORM_FIREFOX?i.CLIENT_ID_EXTENSION_FIREFOX:i.CLIENT_ID_EXTENSION_CHROME;r.sanitizeOrigin=e=>{if(!e)return undefined;try{return new URL(e).hostname||e}catch{return e}}}}},{package:"$root$",file:"app/scripts/lib/smart-transaction/utils.ts"}],[342,{"./snap-keyring":345,"./utils":346},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"getAccountsBySnapId",{enumerable:!0,get:function(){return i.getAccountsBySnapId}}),Object.defineProperty(r,"snapKeyringBuilder",{enumerable:!0,get:function(){return n.snapKeyringBuilder}});var n=e("./snap-keyring"),i=e("./utils")}}},{package:"$root$",file:"app/scripts/lib/snap-keyring/index.ts"}],[343,{"@metamask/keyring-api":2510,"@metamask/permission-controller":2862},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.isProtocolAllowed=d,r.keyringSnapPermissionsBuilder=function(e,t){return()=>{if("metamask"===t)return s;if(o.includes(t))return l;const r=e.getSubjectMetadata(t);return(null==r?void 0:r.subjectType)===i.SubjectType.Website&&d(t)?a:[]}};var n=e("@metamask/keyring-api"),i=e("@metamask/permission-controller");const o=["https://app.metamask.io"],s=[n.KeyringRpcMethod.ListAccounts,n.KeyringRpcMethod.GetAccount,n.KeyringRpcMethod.FilterAccountChains,n.KeyringRpcMethod.DeleteAccount,n.KeyringRpcMethod.ListRequests,n.KeyringRpcMethod.GetRequest,n.KeyringRpcMethod.SubmitRequest,n.KeyringRpcMethod.RejectRequest],a=[n.KeyringRpcMethod.ListAccounts,n.KeyringRpcMethod.GetAccount,n.KeyringRpcMethod.CreateAccount,n.KeyringRpcMethod.FilterAccountChains,n.KeyringRpcMethod.UpdateAccount,n.KeyringRpcMethod.DeleteAccount,n.KeyringRpcMethod.ExportAccount,n.KeyringRpcMethod.ListRequests,n.KeyringRpcMethod.GetRequest,n.KeyringRpcMethod.ApproveRequest,n.KeyringRpcMethod.RejectRequest],l=[n.KeyringRpcMethod.ListAccounts,n.KeyringRpcMethod.GetAccount,n.KeyringRpcMethod.GetAccountBalances,n.KeyringRpcMethod.SubmitRequest],c=["https:"];function d(e){try{const t=new URL(e);return c.includes(t.protocol)}catch(e){return!1}}}}},{package:"$root$",file:"app/scripts/lib/snap-keyring/keyring-snaps-permissions.ts"}],[344,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.getSnapAndHardwareInfoForMetrics=async function(e,t,r,n){var i,o,s;if(!n)return{};const a=n.call("AccountsController:getSelectedAccount"),l=a.address;let c;var d;null!==(i=a.metadata.snap)&&void 0!==i&&i.id&&(c=n.call("SnapController:get",null===(d=a.metadata.snap)||void 0===d?void 0:d.id));let u={};const{isUnlocked:p}=n.call("KeyringController:getState");if(p){u={account_type:await e(l),device_model:await t(l)};const n=await r(l);n&&(u={...u,account_hardware_type:n})}return{...u,account_snap_type:null===(o=c)||void 0===o?void 0:o.id,account_snap_version:null===(s=c)||void 0===s?void 0:s.version}}}}},{package:"$root$",file:"app/scripts/lib/snap-keyring/metrics.ts"}],[345,{"../../../../shared/constants/app":6175,"../../../../shared/constants/metametrics":6190,"../../../../shared/lib/accounts/snaps":6221,"../../../../shared/lib/snaps/snaps":6294,"../../../../shared/lib/translate":6304,"../../../../ui/components/component-library/icon":6950,"./utils/isBlockedUrl":347,"./utils/showResult":348,"@metamask/eth-snap-keyring":2284,"@metamask/snaps-utils":3382,"webextension-polyfill":6163},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.showAccountCreationDialog=v,r.snapKeyringBuilder=function(e,t){const r=()=>new i.SnapKeyring({messenger:e,callbacks:new M(e,t)});return r.state=null,r.type=i.SnapKeyring.type,r};var n,i=e("@metamask/eth-snap-keyring"),o=(n=e("webextension-polyfill"))&&n.__esModule?n:{default:n},s=e("@metamask/snaps-utils"),a=e("../../../../shared/constants/metametrics"),l=e("../../../../shared/constants/app"),c=e("../../../../shared/lib/translate"),d=e("../../../../ui/components/component-library/icon"),u=e("../../../../shared/lib/snaps/snaps"),p=e("../../../../shared/lib/accounts/snaps"),h=e("./utils/isBlockedUrl"),m=e("./utils/showResult");function g(e,t,r){f(e,t),t.set(e,r)}function f(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function y(e,t){return e.get(b(e,t))}function C(e,t,r){return e.set(b(e,t),r),r}function b(e,t,r){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:r;throw new TypeError("Private element is not present on this object")}async function v(e,t){try{return Boolean(await t.call("ApprovalController:addRequest",{origin:e,type:l.SNAP_MANAGE_ACCOUNTS_CONFIRMATION_TYPES.confirmAccountCreation},!0))}catch(e){throw new Error(`Error occurred while showing account creation dialog.\n${e}`)}}var w=new WeakMap,S=new WeakMap,T=new WeakMap,k=new WeakMap,A=new WeakSet;class M{constructor(e,{trackEvent:t,persistKeyringHelper:r,removeAccountHelper:n}){!function(e,t){f(e,t),t.add(e)}(this,A),g(this,w,void 0),g(this,S,void 0),g(this,T,void 0),g(this,k,void 0),C(w,this,e),C(S,this,t),C(T,this,r),C(k,this,n)}async addressExists(e){return(await y(w,this).call("KeyringController:getAccounts")).includes(e.toLowerCase())}async redirectUser(e,t,r){if(t.length>0||r.length>0){const n=await(0,h.isBlockedUrl)(t,async()=>await y(w,this).call("PhishingController:maybeUpdateState"),e=>y(w,this).call("PhishingController:testOrigin",e)),i=await y(w,this).call("ApprovalController:addRequest",{origin:e,requestData:{url:t,message:r,isBlockedUrl:n},type:l.SNAP_MANAGE_ACCOUNTS_CONFIRMATION_TYPES.showSnapAccountRedirect},!0);Boolean(i)&&t.length>0?o.default.tabs.create({url:t}):console.log("User refused snap account redirection to:",t)}else console.log("Error occurred when redirecting snap account. url or message must be defined")}async saveState(){await y(T,this).call(this)}async addAccount(e,t,r,n,o,{displayConfirmation:a,setSelectedAccount:l}=(0,i.getDefaultInternalOptions)()){(0,s.assertIsValidSnapId)(t);const c=(0,u.isSnapPreinstalled)(t);let d=c&&(0,p.isMultichainWalletSnap)(t);const h=d||c&&!a,m=d||c&&!l,g=h;await b(A,this,E).call(this,{snapId:t,skipConfirmationDialog:h,skipApprovalFlow:g,handleUserInput:r}),b(A,this,I).call(this,{address:e,snapId:t,skipConfirmationDialog:h,skipSetSelectedAccountStep:m,skipApprovalFlow:g,onceSaved:n})}async removeAccount(e,t,r){(0,s.assertIsValidSnapId)(t);const n=(0,p.getSnapName)(t,y(w,this)),{id:i}=y(w,this).call("ApprovalController:startFlow"),o="https://support.metamask.io/managing-my-wallet/accounts-and-addresses/how-to-remove-an-account-from-your-metamask-wallet/",u=e=>{y(S,this).call(this,{event:e,category:a.MetaMetricsEventCategory.Accounts,properties:{account_type:a.MetaMetricsEventAccountType.Snap,snap_id:t,snap_name:n}})};let h=!1;try{if(h=Boolean(await y(w,this).call("ApprovalController:addRequest",{origin:t,type:l.SNAP_MANAGE_ACCOUNTS_CONFIRMATION_TYPES.confirmAccountRemoval,requestData:{publicAddress:e}},!0)),!h)throw await r(h),new Error("User denied account removal");try{await y(k,this).call(this,e),await r(h),await this.saveState(),u(a.MetaMetricsEventName.RemoveSnapAccountSuccessViewed),await(0,m.showError)(y(w,this),t,{icon:d.IconName.UserCircleRemove,title:(0,c.t)("snapAccountRemoved")},{message:(0,c.t)("snapAccountRemovedDescription"),learnMoreLink:o}),u(a.MetaMetricsEventName.RemoveSnapAccountSuccessClicked)}catch(e){const r=e.message;throw await(0,m.showError)(y(w,this),t,{icon:d.IconName.UserCircleRemove,title:(0,c.t)("snapAccountRemovalFailed")},{message:(0,c.t)("snapAccountRemovalFailedDescription",n),learnMoreLink:o,error:r}),u(a.MetaMetricsEventName.AccountRemoveFailed),new Error(`Error occurred while removing snap account: ${r}`)}}finally{h&&u(a.MetaMetricsEventName.AccountRemoved),y(w,this).call("ApprovalController:endFlow",{id:i})}}}async function P(e){const{id:t}=y(w,this).call("ApprovalController:startFlow");try{return await e(t)}finally{y(w,this).call("ApprovalController:endFlow",{id:t})}}async function E({snapId:e,skipConfirmationDialog:t,skipApprovalFlow:r,handleUserInput:n}){return r?await n(!0):await b(A,this,P).call(this,async r=>{const i=t||await v(e,y(w,this));if(await n(i),!i)throw new Error("User denied account creation")})}async function I({address:e,snapId:t,skipConfirmationDialog:r,skipSetSelectedAccountStep:n,skipApprovalFlow:i,onceSaved:o}){const s="https://support.metamask.io/managing-my-wallet/accounts-and-addresses/how-to-add-accounts-in-your-wallet/",l=(0,p.getSnapName)(t,y(w,this)),u=e=>{y(S,this).call(this,{event:e,category:a.MetaMetricsEventCategory.Accounts,properties:{account_type:a.MetaMetricsEventAccountType.Snap,snap_id:t,snap_name:l,...e===a.MetaMetricsEventName.AccountAdded&&{is_suggested_name:!1}}})},h=async()=>{try{const i=await o;n||y(w,this).call("AccountsController:setSelectedAccount",i),r||(u(a.MetaMetricsEventName.AddSnapAccountSuccessViewed),await(0,m.showSuccess)(y(w,this),t,{icon:d.IconName.UserCircleAdd,title:(0,c.t)("snapAccountCreated")},{message:(0,c.t)("snapAccountCreatedDescription"),address:e,learnMoreLink:s}),u(a.MetaMetricsEventName.AddSnapAccountSuccessClicked)),u(a.MetaMetricsEventName.AccountAdded)}catch(e){const r=e.message;await(0,m.showError)(y(w,this),t,{icon:d.IconName.UserCircleAdd,title:(0,c.t)("snapAccountCreationFailed")},{message:(0,c.t)("snapAccountCreationFailedDescription",l),learnMoreLink:s,error:r}),console.error("Error occurred while creating snap account:",r)}};i?await h():await b(A,this,P).call(this,h)}}}},{package:"$root$",file:"app/scripts/lib/snap-keyring/snap-keyring.ts"}],[346,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.getAccountsBySnapId=void 0;r.getAccountsBySnapId=async(e,t)=>{const r=await e();return await r.getAccountsBySnapId(t)}}}},{package:"$root$",file:"app/scripts/lib/snap-keyring/utils.ts"}],[347,{"../keyring-snaps-permissions":343},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.isBlockedUrl=void 0;var n=e("../keyring-snaps-permissions");r.isBlockedUrl=async(e,t,r)=>{try{return!(0,n.isProtocolAllowed)(e)||(await t(),r(e).result)}catch(e){return console.error("Invalid URL passed into snap-keyring:",e),!1}}}}},{package:"$root$",file:"app/scripts/lib/snap-keyring/utils/isBlockedUrl.ts"}],[348,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.showSuccess=r.showError=void 0;const n=e=>({name:"SnapAuthorshipHeader",key:"snapHeader",properties:{snapId:e}});r.showError=(e,t,r,i)=>e.call("ApprovalController:showError",{header:[n(t)],title:r.title,icon:r.icon,error:{key:"snapAccountErrorMessage",name:"SnapAccountErrorMessage",properties:i}});r.showSuccess=(e,t,r,i)=>e.call("ApprovalController:showSuccess",{header:[n(t)],title:r.title,icon:r.icon,message:{key:"snapAccountSuccessMessage",name:"SnapAccountSuccessMessage",properties:i}})}}},{package:"$root$",file:"app/scripts/lib/snap-keyring/utils/showResult.ts"}],[349,{loglevel:5247},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.tryPostMessage=function(e,t,r){const n={data:{method:t,params:r}};try{return e.postMessage(n),!0}catch(e){return i.default.error("MetaMask - Failed to message to port",e,n),!1}};var n,i=(n=e("loglevel"))&&n.__esModule?n:{default:n}}}},{package:"$root$",file:"app/scripts/lib/start-up-errors/start-up-errors.ts"}],[35,{"@metamask/address-book-controller":1354},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.AddressBookControllerInit=void 0;var n=e("@metamask/address-book-controller");r.AddressBookControllerInit=({controllerMessenger:e,persistedState:t})=>({controller:new n.AddressBookController({messenger:e,state:t.AddressBookController})})}}},{package:"$root$",file:"app/scripts/controller-init/confirmations/address-book-controller-init.ts"}],[350,{"../../../../shared/constants/metametrics":6190,"../../../../shared/constants/start-up-errors":6206,"../../../../shared/constants/state-corruption":6207,"../start-up-errors/start-up-errors":349,"../stores/persistence-manager":357,"./track-vault-corruption":351,"@metamask/utils":3554},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.CorruptionHandler=void 0,r.hasVault=u;var n=e("@metamask/utils"),i=e("../../../../shared/constants/state-corruption"),o=e("../stores/persistence-manager"),s=e("../start-up-errors/start-up-errors"),a=e("../../../../shared/constants/start-up-errors"),l=e("../../../../shared/constants/metametrics"),c=e("./track-vault-corruption");function d(e,t,r){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function u(e){if((0,n.isObject)(e)&&(0,n.hasProperty)(e,"KeyringController")){const t=e.KeyringController;if((0,n.isObject)(t)&&(0,n.hasProperty)(t,"vault"))return Boolean(t.vault)}return!1}r.CorruptionHandler=class{constructor(){d(this,"connectedPorts",new Set)}async handleStateCorruptionError({port:e,error:t,database:r,repairCallback:d}){const{connectedPorts:p}=this,h=await async function(e,t){let r=(0,n.isObject)(e)&&(0,n.hasProperty)(e,"getBackup")&&"function"==typeof e.getBackup?e.getBackup()??null:null;if(!r)try{r=await t.getBackup()??null}catch{r=null}return r}(t,r),m=function(e){if((0,n.isObject)(e)&&(0,n.hasProperty)(e,"PreferencesController")){const t=e.PreferencesController;if((0,n.isObject)(t)&&(0,n.hasProperty)(t,"currentLocale")&&"string"==typeof t.currentLocale)return t.currentLocale}return null}(h),g=Boolean(u(h)),f=function(e){return e instanceof o.PersistenceError&&e.cause instanceof Error&&e.cause.message?e.cause.message:null}(t);if(!(0,s.tryPostMessage)(e,i.METHOD_DISPLAY_STATE_CORRUPTION_ERROR,{error:{message:t.message,name:t.name,stack:t.stack,causeMessage:f},currentLocale:m,hasBackup:g}))return Promise.resolve();const y=function(e){return e instanceof o.PersistenceError?e.corruptionType:i.VaultCorruptionType.Unknown}(t);return(0,c.trackVaultCorruptionEvent)(h,l.MetaMetricsEventName.VaultCorruptionRestoreWalletScreenViewed,y),new Promise((t,r)=>{p.add(e),e.onDisconnect.addListener(function(){p.delete(e),t()}),e.onMessage.addListener(async function e(n){var o;if((null==n||null===(o=n.data)||void 0===o?void 0:o.method)===i.METHOD_REPAIR_DATABASE){p.forEach(t=>t.onMessage.removeListener(e)),(0,c.trackVaultCorruptionEvent)(h,l.MetaMetricsEventName.VaultCorruptionRestoreWalletButtonPressed,y);try{await async function(e){return await navigator.locks.request("repairDatabase",{ifAvailable:!0},async function(t){return null!==t&&(await e(),!0)})}(async function(){try{await d(h)}finally{p.forEach(e=>{(0,s.tryPostMessage)(e,a.RELOAD_WINDOW)})}}),t()}catch(e){r(e)}}})})}}}}},{package:"$root$",file:"app/scripts/lib/state-corruption/state-corruption-recovery.ts"}],[352,{lodash:5239},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.sanitizePatches=function(e){return e.filter(e=>{if(i.includes(e.path[0]))return!1;for(const t of o)if(s(e,t))return!1;return!0})},r.sanitizeUIState=function(e){const t={...e};for(const e of i)delete t[e];return function(e){const t=e.snaps;if(!t)return;e.snaps=Object.values(t).reduce((e,t)=>(e[t.id]=function(e){const t={...e};return delete t.sourceCode,delete t.auxiliaryFiles,t}(t),e),{})}(t),function(e){const t=e.srpSessionData;if(!t)return;e.srpSessionData=Object.entries(t).reduce((e,[t,r])=>{const n={...r.token};return delete n.accessToken,e[t]={...r,token:n},e},{})}(t),function(e){const t=e.nodeAuthTokens;t&&(e.nodeAuthTokens=t.map(e=>{const t={...e};return delete t.authToken,t}));const r=e.socialBackupsMetadata;r&&(e.socialBackupsMetadata=r.map(e=>{const t={...e};return delete t.hash,t}))}(t),t};var n=e("lodash");const i=["encryptionKey","encryptionSalt","vault","c2DomainBlocklistLastFetched","hotlistLastFetched","phishingLists","stalelistLastFetched","whitelist","whitelistPaths","accessToken","encryptedKeyringEncryptionKey","encryptedSeedlessEncryptionKey","metadataAccessToken","refreshToken","revokeToken","vaultEncryptionKey","vaultEncryptionSalt","pendingToBeRevokedTokens","snapStates","unencryptedSnapStates"],o=[["nodeAuthTokens",!0,"authToken"],["snaps",!0,"auxiliaryFiles"],["snaps",!0,"sourceCode"],["socialBackupsMetadata",!0,"hash"],["srpSessionData",!0,"token","accessToken"]];function s(e,t){for(let r=0;r<t.length;r++){const i=t[r],o=r===t.length-1,s=r===e.path.length-1;if(!(e.path[r]===i||!0===i&&e.path[r]!==undefined))return!1;if(o)return!0;if(s&&!l(e.value))return!1;if(s){const i=t.slice(r+1);return e.value=(0,n.cloneDeep)(e.value),a(e.value,i),!1}}return!1}function a(e,t,r=0){const n=t[r],i=r===t.length-1;if(i&&!0!==n&&n in e&&!Array.isArray(e))return void delete e[n];if(i)return;let o=[];!0===n?o=Object.values(e):Array.isArray(e)||(o=[e[n]]);const s=o.filter(l);for(const e of s)a(e,t,r+1)}function l(e){return"object"==typeof e&&null!==e&&e!==undefined}}}},{package:"$root$",file:"app/scripts/lib/state-utils.ts"}],[3526,{"./constants.cjs":3527,"./helpers/Bundler.cjs":3528,"./helpers/PendingUserOperationTracker.cjs":3529,"./helpers/SnapSmartContractAccount.cjs":3530,"./logger.cjs":3532,"./types.cjs":3533,"./utils/gas-fees.cjs":3535,"./utils/gas.cjs":3536,"./utils/transaction.cjs":3537,"./utils/validation.cjs":3538,"@metamask/base-controller":1520,"@metamask/controller-utils":1639,"@metamask/eth-query":2226,"@metamask/rpc-errors":3026,"@metamask/transaction-controller":3473,"@metamask/utils":3554,events:4770,lodash:5239,uuid:6134},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n,i,o,s,a,l,c,d,u,p,h,m,g,f,y,C,b,v,w,S,T,k,A,M,P=this&&this.__classPrivateFieldSet||function(e,t,r,n,i){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?i.call(e,r):i?i.value=r:t.set(e,r),r},E=this&&this.__classPrivateFieldGet||function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)},I=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.UserOperationController=void 0;const _=e("@metamask/base-controller"),O=e("@metamask/controller-utils"),R=I(e("@metamask/eth-query")),N=e("@metamask/rpc-errors"),D=e("@metamask/transaction-controller"),F=e("@metamask/utils"),x=I(e("events")),j=e("lodash"),B=e("uuid"),U=e("./constants.cjs"),L=e("./helpers/Bundler.cjs"),G=e("./helpers/PendingUserOperationTracker.cjs"),K=e("./helpers/SnapSmartContractAccount.cjs"),$=e("./logger.cjs"),q=e("./types.cjs"),H=e("./utils/gas.cjs"),W=e("./utils/gas-fees.cjs"),V=e("./utils/transaction.cjs"),Y=e("./utils/validation.cjs"),z={userOperations:{includeInStateLogs:!0,persist:!0,includeInDebugSnapshot:!1,usedInUi:!0}};class X extends _.BaseController{constructor({entrypoint:e,getGasFeeEstimates:t,messenger:r,state:a}){super({name:"UserOperationController",metadata:z,messenger:r,state:{userOperations:{},...a}}),n.add(this),i.set(this,void 0),o.set(this,void 0),s.set(this,void 0),this.hub=new x.default,P(this,i,e,"f"),P(this,o,t,"f"),P(this,s,new G.PendingUserOperationTracker({getUserOperations:()=>(0,j.cloneDeep)(Object.values(this.state.userOperations)),messenger:r}),"f"),E(this,n,"m",w).call(this)}async addUserOperation(e,t){return(0,Y.validateAddUserOperationRequest)(e),(0,Y.validateAddUserOperationOptions)(t),await E(this,n,"m",a).call(this,e,t)}async addUserOperationFromTransaction(e,t){(0,Y.validateAddUserOperationOptions)(t);const{data:r,from:i,maxFeePerGas:o,maxPriorityFeePerGas:s,to:l,value:c}=e,d={data:""===r?undefined:r,from:i,maxFeePerGas:o,maxPriorityFeePerGas:s,to:l,value:c};return(0,Y.validateAddUserOperationRequest)(d),await E(this,n,"m",a).call(this,d,{...t,transaction:e})}startPollingByNetworkClientId(e){return E(this,s,"f").startPolling({networkClientId:e})}}r.UserOperationController=X,i=new WeakMap,o=new WeakMap,s=new WeakMap,n=new WeakSet,a=async function(e,t){(0,$.projectLogger)("Adding user operation",{request:e,options:t});const{networkClientId:r,origin:i,smartContractAccount:o,swaps:s,transaction:a}=t,{chainId:u,provider:p}=await E(this,n,"m",k).call(this,r),h=await E(this,n,"m",d).call(this,u,i,a,s),m=o??new K.SnapSmartContractAccount(this.messenger),g={chainId:u,metadata:h,options:{...t,smartContractAccount:m},provider:p,request:e,transaction:a},{id:y}=h;let C=!1;const b=(async()=>{try{return await E(this,n,"m",l).call(this,g)}catch(e){if(E(this,n,"m",f).call(this,h,e),C)throw e;return undefined}})(),v=async()=>(C=!0,await b);return{id:y,hash:v,transactionHash:async()=>{await v();const{transactionHash:e}=await E(this,n,"m",c).call(this,h);return e}}},l=async function(e){const{metadata:t,options:r}=e,{requireApproval:i,smartContractAccount:o}=r;let s;try{return await E(this,n,"m",u).call(this,e),await E(this,n,"m",p).call(this,t,o),this.hub.emit("user-operation-added",t),!1!==i&&(s=await E(this,n,"m",h).call(this,e)),await E(this,n,"m",m).call(this,t,o),await E(this,n,"m",g).call(this,t),s?.success(),t.hash}catch(e){throw s?.error(e),e}},c=async function(e){const{id:t,hash:r}=e;return(0,$.projectLogger)("Waiting for confirmation",t,r),new Promise((e,r)=>{this.hub.once(`${t}:confirmed`,t=>{e(t)}),this.hub.once(`${t}:failed`,(e,t)=>{r(t)})})},d=async function(e,t,r,i){const o={actualGasCost:null,actualGasUsed:null,baseFeePerGas:null,bundlerUrl:null,chainId:e,error:null,hash:null,id:(0,B.v1)(),origin:t,status:q.UserOperationStatus.Unapproved,swapsMetadata:i?{approvalTxId:i.approvalTxId??null,destinationTokenAddress:i.destinationTokenAddress??null,destinationTokenAmount:i.destinationTokenAmount??null,destinationTokenDecimals:i.destinationTokenDecimals??null,destinationTokenSymbol:i.destinationTokenSymbol??null,estimatedBaseFee:i.estimatedBaseFee??null,sourceTokenAddress:i.sourceTokenAddress??null,sourceTokenAmount:i.sourceTokenAmount??null,sourceTokenDecimals:i.sourceTokenDecimals??null,sourceTokenSymbol:i.sourceTokenSymbol??null,swapAndSendRecipient:i.swapAndSendRecipient??null,swapMetaData:i.swapMetaData??null,swapTokenValue:i.swapTokenValue??null}:null,time:Date.now(),transactionHash:null,transactionParams:r??null,transactionType:null,userFeeLevel:null,userOperation:E(this,n,"m",y).call(this,r)};return E(this,n,"m",C).call(this,o),(0,$.projectLogger)("Added user operation",o.id),o},u=async function(e){const{chainId:t,metadata:r,options:s,provider:a,request:l,transaction:c}=e,{data:d,from:u,to:p,value:h}=l,{id:m,transactionParams:g,userOperation:f}=r,{smartContractAccount:y}=s;(0,$.projectLogger)("Preparing user operation",{id:m});const b=await E(this,n,"m",T).call(this,c,a,s);r.transactionType=b??null,(0,$.projectLogger)("Determined transaction type",b),await(0,W.updateGasFees)({getGasFeeEstimates:E(this,o,"f"),metadata:r,originalRequest:l,provider:a,transaction:g??undefined});const v=await y.prepareUserOperation({chainId:t,data:d,from:u,to:p,value:h});(0,Y.validatePrepareUserOperationResponse)(v);const{bundler:w,callData:S,dummyPaymasterAndData:k,dummySignature:A,initCode:M,nonce:P,sender:I}=v;f.callData=S,f.initCode=M??U.EMPTY_BYTES,f.nonce=P,f.paymasterAndData=k??U.EMPTY_BYTES,f.sender=I,f.signature=A??U.EMPTY_BYTES,r.bundlerUrl=w,await(0,H.updateGas)(r,v,E(this,i,"f")),E(this,n,"m",C).call(this,r)},p=async function(e,t){const{id:r,userOperation:i,chainId:o}=e;(0,$.projectLogger)("Requesting paymaster data",{id:r});const s=await t.updateUserOperation({userOperation:i,chainId:o});(0,Y.validateUpdateUserOperationResponse)(s),i.paymasterAndData=s.paymasterAndData??U.EMPTY_BYTES,s.callGasLimit&&(i.callGasLimit=s.callGasLimit),s.preVerificationGas&&(i.preVerificationGas=s.preVerificationGas),s.verificationGasLimit&&(i.verificationGasLimit=s.verificationGasLimit),E(this,n,"m",C).call(this,e)},h=async function(e){(0,$.projectLogger)("Requesting approval");const{metadata:t}=e,{resultCallbacks:r,value:i}=await E(this,n,"m",S).call(this,t),o=i?.txMeta;return o&&await E(this,n,"m",A).call(this,e,o),t.status=q.UserOperationStatus.Approved,E(this,n,"m",C).call(this,t),r},m=async function(e,t){const{id:r,chainId:i,userOperation:o}=e;(0,$.projectLogger)("Signing user operation",r,o);const s=await t.signUserOperation({userOperation:o,chainId:i});(0,Y.validateSignUserOperationResponse)(s);const{signature:a}=s;o.signature=a,(0,$.projectLogger)("Signed user operation",a),e.status=q.UserOperationStatus.Signed,E(this,n,"m",C).call(this,e)},g=async function(e){const{userOperation:t}=e;(0,$.projectLogger)("Submitting user operation",t);const r=new L.Bundler(e.bundlerUrl),o=await r.sendUserOperation(t,E(this,i,"f"));e.hash=o,e.status=q.UserOperationStatus.Submitted,E(this,n,"m",C).call(this,e)},f=function(e,t){const{id:r}=e,i=t;(0,$.projectLogger)("User operation failed",r,t),e.error={name:i.name,message:i.message,stack:i.stack,code:i.code,rpc:i.value},e.status=q.UserOperationStatus.Failed,E(this,n,"m",C).call(this,e),String(i.code)===String(N.errorCodes.provider.userRejectedRequest)&&E(this,n,"m",b).call(this,r)},y=function(e){return{callData:U.EMPTY_BYTES,callGasLimit:U.EMPTY_BYTES,initCode:U.EMPTY_BYTES,maxFeePerGas:e?.maxFeePerGas??U.EMPTY_BYTES,maxPriorityFeePerGas:e?.maxPriorityFeePerGas??U.EMPTY_BYTES,nonce:U.EMPTY_BYTES,paymasterAndData:U.EMPTY_BYTES,preVerificationGas:U.EMPTY_BYTES,sender:U.ADDRESS_ZERO,signature:U.EMPTY_BYTES,verificationGasLimit:U.EMPTY_BYTES}},C=function(e){const{id:t}=e;this.update(r=>{r.userOperations[t]=(0,j.cloneDeep)(e)}),E(this,n,"m",v).call(this,e)},b=function(e){this.update(t=>{delete t.userOperations[e]})},v=function(e){if(!e.transactionParams)return;const t=(0,V.getTransactionMetadata)(e);this.hub.emit("transaction-updated",t)},w=function(){E(this,s,"f").hub.on("user-operation-confirmed",e=>{(0,$.projectLogger)("In listener..."),this.hub.emit("user-operation-confirmed",e),this.hub.emit(`${e.id}:confirmed`,e)}),E(this,s,"f").hub.on("user-operation-failed",(e,t)=>{this.hub.emit("user-operation-failed",e,t),this.hub.emit(`${e.id}:failed`,e,t)}),E(this,s,"f").hub.on("user-operation-updated",e=>{E(this,n,"m",C).call(this,e)})},S=async function(e){const{id:t,origin:r}=e,n=O.ApprovalType.Transaction,i={txId:t};return await this.messenger.call("ApprovalController:addRequest",{id:t,origin:r,type:n,requestData:i,expectsResult:!0},!0)},T=async function(e,t,r){if(!e)return undefined;if(r.type)return r.type;const n=new R.default(t),i=(0,D.determineTransactionType)(e,n);return(await i).type},k=async function(e){const{provider:t,configuration:r}=this.messenger.call("NetworkController:getNetworkClientById",e),{chainId:n}=r;return{provider:t,chainId:n}},A=async function(e,t){(0,$.projectLogger)("Found updated transaction in approval",{updatedTransaction:t});const{metadata:r,request:i}=e,{userOperation:o}=r,s=o.paymasterAndData!==U.EMPTY_BYTES,a=(0,F.add0x)(t.txParams.maxFeePerGas),l=(0,F.add0x)(t.txParams.maxPriorityFeePerGas);let c=!1;const d=o.maxFeePerGas,u=o.maxPriorityFeePerGas,p=d!==a||u!==l,h=s&&a===U.VALUE_ZERO&&l===U.VALUE_ZERO;p&&!h&&((0,$.projectLogger)("Gas fees updated during approval",{previousMaxFeePerGas:d,previousMaxPriorityFeePerGas:u,updatedMaxFeePerGas:a,updatedMaxPriorityFeePerGas:l}),o.maxFeePerGas=a,o.maxPriorityFeePerGas=l,c=s);const m=i.data??U.EMPTY_BYTES,g=t.txParams.data??U.EMPTY_BYTES;m!==g&&((0,$.projectLogger)("Data updated during approval",{previousData:m,updatedData:g}),c=!0);const f=i.value??U.VALUE_ZERO,y=t.txParams.value??U.VALUE_ZERO;if(f!==y&&((0,$.projectLogger)("Value updated during approval",{previousValue:f,updatedValue:y}),c=!0),c){const t={...i,data:g,maxFeePerGas:a,maxPriorityFeePerGas:l,value:y};await E(this,n,"m",M).call(this,{...e,request:t})}},M=async function(e){(0,$.projectLogger)("Regenerating user operation as parameters were updated during approval");const{options:{smartContractAccount:t},metadata:r}=e;await E(this,n,"m",u).call(this,e),await E(this,n,"m",p).call(this,r,t),(0,$.projectLogger)("Regenerated user operation",r.userOperation)}}}},{package:"@metamask/user-operation-controller",file:"node_modules/@metamask/user-operation-controller/dist/UserOperationController.cjs"}],[3527,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.VALUE_ZERO=r.ADDRESS_ZERO=r.EMPTY_BYTES=void 0,r.EMPTY_BYTES="0x",r.ADDRESS_ZERO="0x0000000000000000000000000000000000000000",r.VALUE_ZERO="0x0"}}},{package:"@metamask/user-operation-controller",file:"node_modules/@metamask/user-operation-controller/dist/constants.cjs"}],[3528,{"../logger.cjs":3532},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n,i,o,s=this&&this.__classPrivateFieldSet||function(e,t,r,n,i){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?i.call(e,r):i?i.value=r:t.set(e,r),r},a=this&&this.__classPrivateFieldGet||function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};Object.defineProperty(r,"__esModule",{value:!0}),r.Bundler=void 0;const l=e("../logger.cjs"),c=(0,l.createModuleLogger)(l.projectLogger,"bundler");r.Bundler=class{constructor(e){n.add(this),i.set(this,void 0),s(this,i,e,"f")}async estimateUserOperationGas(e,t){c("Estimating gas",{url:a(this,i,"f"),userOperation:e,entrypoint:t});const r=await a(this,n,"m",o).call(this,"eth_estimateUserOperationGas",[e,t]);return c("Estimated gas",{response:r}),r}async getUserOperationReceipt(e){return c("Getting user operation receipt",{url:a(this,i,"f"),hash:e}),await a(this,n,"m",o).call(this,"eth_getUserOperationReceipt",[e])}async sendUserOperation(e,t){c("Sending user operation",{url:a(this,i,"f"),userOperation:e,entrypoint:t});const r=await a(this,n,"m",o).call(this,"eth_sendUserOperation",[e,t]);return c("Sent user operation",r),r}},i=new WeakMap,n=new WeakSet,o=async function(e,t){const r={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:1,method:e,params:t})},n=await fetch(a(this,i,"f"),r),o=await n.json();if(o.error){const e=new Error(o.error.message||o.error);throw e.code=o.error.code,e}return o.result}}}},{package:"@metamask/user-operation-controller",file:"node_modules/@metamask/user-operation-controller/dist/helpers/Bundler.cjs"}],[3529,{"../logger.cjs":3532,"../types.cjs":3533,"./Bundler.cjs":3528,"@metamask/controller-utils":1639,"@metamask/eth-query":2226,"@metamask/polling-controller":3542,"@metamask/utils":3554,events:4770},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n,i,o,s,a,l,c,d,u,p,h,m=this&&this.__classPrivateFieldSet||function(e,t,r,n,i){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?i.call(e,r):i?i.value=r:t.set(e,r),r},g=this&&this.__classPrivateFieldGet||function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)},f=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.PendingUserOperationTracker=void 0;const y=e("@metamask/controller-utils"),C=f(e("@metamask/eth-query")),b=e("@metamask/polling-controller"),v=e("@metamask/utils"),w=f(e("events")),S=e("../logger.cjs"),T=e("../types.cjs"),k=e("./Bundler.cjs"),A=(0,v.createModuleLogger)(S.projectLogger,"pending-user-operations");class M extends((0,b.BlockTrackerPollingControllerOnly)()){constructor({getUserOperations:e,messenger:t}){super(),n.add(this),i.set(this,void 0),o.set(this,void 0),this.hub=new w.default,m(this,i,e,"f"),m(this,o,t,"f")}async _executePoll({networkClientId:e}){try{const{blockTracker:t,configuration:r,provider:i}=this._getNetworkClientById(e);A("Polling",{blockNumber:t.getCurrentBlock(),chainId:r.chainId}),await g(this,n,"m",s).call(this,r.chainId,i)}catch(e){A("Failed to check user operations",e)}}_getNetworkClientById(e){return g(this,o,"f").call("NetworkController:getNetworkClientById",e)}}r.PendingUserOperationTracker=M,i=new WeakMap,o=new WeakMap,n=new WeakSet,s=async function(e,t){const r=g(this,n,"m",d).call(this).filter(t=>t.chainId===e);r.length?(A("Found pending user operations to check",{count:r.length,ids:r.map(e=>e.id)}),await Promise.all(r.map(e=>g(this,n,"m",a).call(this,e,t)))):A("No pending user operations to check")},a=async function(e,t){const{bundlerUrl:r,hash:i,id:o}=e;if(i&&r)try{const s=await g(this,n,"m",p).call(this,i,r),a=s?.success;if(s&&!a)return void g(this,n,"m",c).call(this,e,s);if(a)return void await g(this,n,"m",l).call(this,e,s,t);A("No receipt found for user operation",{id:o,hash:i})}catch(e){A("Failed to check user operation",o,e)}else A("Skipping user operation as missing hash or bundler",o)},l=async function(e,t,r){const{id:i}=e,{actualGasCost:o,actualGasUsed:s,receipt:{blockHash:a,transactionHash:l}}=t;A("User operation confirmed",i,l);const{baseFeePerGas:c}=await(0,y.query)(new C.default(r),"getBlockByHash",[a,!1]);e.actualGasCost=g(this,n,"m",h).call(this,o),e.actualGasUsed=g(this,n,"m",h).call(this,s),e.baseFeePerGas=c,e.status=T.UserOperationStatus.Confirmed,e.transactionHash=l,g(this,n,"m",u).call(this,e),this.hub.emit("user-operation-confirmed",e)},c=function(e,t){const{id:r}=e;A("User operation failed",r),e.status=T.UserOperationStatus.Failed,g(this,n,"m",u).call(this,e),this.hub.emit("user-operation-failed",e,new Error("User operation receipt has failed status"))},d=function(){return g(this,i,"f").call(this).filter(e=>e.status===T.UserOperationStatus.Submitted)},u=function(e){this.hub.emit("user-operation-updated",e)},p=async function(e,t){return new k.Bundler(t).getUserOperationReceipt(e)},h=function(e){return"number"==typeof e?(0,y.toHex)(e):e}}}},{package:"@metamask/user-operation-controller",file:"node_modules/@metamask/user-operation-controller/dist/helpers/PendingUserOperationTracker.cjs"}],[353,{"@metamask/storage-service":3405,"webextension-polyfill":6163},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.BrowserStorageAdapter=void 0;var n,i=(n=e("webextension-polyfill"))&&n.__esModule?n:{default:n},o=e("@metamask/storage-service");function s(e,t){(function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")})(e,t),t.add(e)}function a(e,t,r){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:r;throw new TypeError("Private element is not present on this object")}var l=new WeakSet;function c(e,t){return`${o.STORAGE_KEY_PREFIX}${e}:${t}`}r.BrowserStorageAdapter=class{constructor(){s(this,l)}async getItem(e,t){try{const r=a(l,this,c).call(this,e,t),n=await i.default.storage.local.get(r);return r in n?{result:n[r]}:{}}catch(r){return console.error(`StorageService: Failed to get item: ${e}:${t}`,r),{error:r}}}async setItem(e,t,r){try{const n=a(l,this,c).call(this,e,t);await i.default.storage.local.set({[n]:r})}catch(r){throw console.error(`StorageService: Failed to set item: ${e}:${t}`,r),r}}async removeItem(e,t){try{const r=a(l,this,c).call(this,e,t);await i.default.storage.local.remove(r)}catch(r){throw console.error(`StorageService: Failed to remove item: ${e}:${t}`,r),r}}async getAllKeys(e){try{const t=`${o.STORAGE_KEY_PREFIX}${e}:`,r=await i.default.storage.local.get(null);return Object.keys(r).filter(e=>e.startsWith(t)).map(e=>e.slice(t.length))}catch(t){throw console.error(`StorageService: Failed to get keys for ${e}`,t),t}}async clear(e){try{const t=(await this.getAllKeys(e)).map(t=>a(l,this,c).call(this,e,t));t.length>0&&await i.default.storage.local.remove(t)}catch(t){throw console.error(`StorageService: Failed to clear namespace ${e}`,t),t}}}}}},{package:"$root$",file:"app/scripts/lib/stores/browser-storage-adapter.ts"}],[3530,{"../constants.cjs":3527,"../utils/chain-id.cjs":3534},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n,i=this&&this.__classPrivateFieldSet||function(e,t,r,n,i){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?i.call(e,r):i?i.value=r:t.set(e,r),r},o=this&&this.__classPrivateFieldGet||function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};Object.defineProperty(r,"__esModule",{value:!0}),r.SnapSmartContractAccount=void 0;const s=e("../constants.cjs"),a=e("../utils/chain-id.cjs");r.SnapSmartContractAccount=class{constructor(e){n.set(this,void 0),i(this,n,e,"f")}async prepareUserOperation(e){const{chainId:t,data:r,from:i,to:l,value:c}=e,d=r??s.EMPTY_BYTES,u=l??s.ADDRESS_ZERO,p=c??s.VALUE_ZERO,h=await o(this,n,"f").call("KeyringController:prepareUserOperation",i,[{data:d,to:u,value:p}],{chainId:(0,a.toEip155ChainId)(t)}),{bundlerUrl:m,callData:g,dummyPaymasterAndData:f,dummySignature:y,gasLimits:C,initCode:b,nonce:v}=h;return{bundler:m,callData:g,dummyPaymasterAndData:f,dummySignature:y,gas:C,initCode:b,nonce:v,sender:i}}async updateUserOperation(e){const{userOperation:t,chainId:r}=e,{sender:i}=t,{paymasterAndData:l,verificationGasLimit:c,preVerificationGas:d,callGasLimit:u}=await o(this,n,"f").call("KeyringController:patchUserOperation",i,t,{chainId:(0,a.toEip155ChainId)(r)});return{paymasterAndData:l===s.EMPTY_BYTES?undefined:l,verificationGasLimit:c,preVerificationGas:d,callGasLimit:u}}async signUserOperation(e){const{userOperation:t,chainId:r}=e,{sender:i}=t;return{signature:await o(this,n,"f").call("KeyringController:signUserOperation",i,t,{chainId:(0,a.toEip155ChainId)(r)})}}},n=new WeakMap}}},{package:"@metamask/user-operation-controller",file:"node_modules/@metamask/user-operation-controller/dist/helpers/SnapSmartContractAccount.cjs"}],[3531,{"./UserOperationController.cjs":3526,"./types.cjs":3533},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){n===undefined&&(n=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,i)}:function(e,t,r,n){n===undefined&&(n=r),e[n]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||n(t,e,r)};Object.defineProperty(r,"__esModule",{value:!0}),i(e("./UserOperationController.cjs"),r),i(e("./types.cjs"),r)}}},{package:"@metamask/user-operation-controller",file:"node_modules/@metamask/user-operation-controller/dist/index.cjs"}],[3532,{"@metamask/utils":3554},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.createModuleLogger=r.projectLogger=void 0;const n=e("@metamask/utils");Object.defineProperty(r,"createModuleLogger",{enumerable:!0,get:function(){return n.createModuleLogger}}),r.projectLogger=(0,n.createProjectLogger)("user-operation-controller")}}},{package:"@metamask/user-operation-controller",file:"node_modules/@metamask/user-operation-controller/dist/logger.cjs"}],[3533,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n;Object.defineProperty(r,"__esModule",{value:!0}),r.UserOperationStatus=void 0,function(e){e.Unapproved="unapproved",e.Approved="approved",e.Signed="signed",e.Submitted="submitted",e.Failed="failed",e.Confirmed="confirmed"}(n||(r.UserOperationStatus=n={}))}}},{package:"@metamask/user-operation-controller",file:"node_modules/@metamask/user-operation-controller/dist/types.cjs"}],[3534,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.toEip155ChainId=void 0,r.toEip155ChainId=function(e){const t=Number(e);return Number.isInteger(t)?t.toString():e}}}},{package:"@metamask/user-operation-controller",file:"node_modules/@metamask/user-operation-controller/dist/utils/chain-id.cjs"}],[3535,{"../constants.cjs":3527,"../logger.cjs":3532,"@metamask/controller-utils":1639,"@metamask/eth-query":2226,"@metamask/gas-fee-controller":2339,"@metamask/transaction-controller":3473,"@metamask/utils":3554},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.updateGasFees=void 0;const i=e("@metamask/controller-utils"),o=n(e("@metamask/eth-query")),s=e("@metamask/gas-fee-controller"),a=e("@metamask/transaction-controller"),l=e("@metamask/utils"),c=e("../constants.cjs"),d=e("../logger.cjs"),u=(0,d.createModuleLogger)(d.projectLogger,"gas-fees");function p(e){return(0,i.toHex)((0,i.gweiDecToWEIBN)(e))}function h(e){return!e||e===c.EMPTY_BYTES}r.updateGasFees=async function(e){const{metadata:t,originalRequest:r,transaction:n}=e,{userOperation:c}=t;let d;const m=async()=>(d||(d=await async function(e){const{getGasFeeEstimates:t,provider:r}=e;try{const{gasFeeEstimates:e,gasEstimateType:r}=await t();if(r===s.GAS_ESTIMATE_TYPES.FEE_MARKET){const{medium:{suggestedMaxPriorityFeePerGas:t,suggestedMaxFeePerGas:r}={}}=e;if(t&&r){const e={maxFeePerGas:p(r),maxPriorityFeePerGas:p(t)};return u("Using medium values from fee market estimate",e),e}}if(r===s.GAS_ESTIMATE_TYPES.LEGACY){const t=p(e.medium);return u("Using medium value from legacy estimate",t),{maxFeePerGas:t}}if(r===s.GAS_ESTIMATE_TYPES.ETH_GASPRICE){const t=p(e.gasPrice);return u("Using gasPrice from estimate",t),{maxFeePerGas:t}}}catch(e){u("Failed to get estimate",e)}const n=await(0,i.query)(new o.default(r),"gasPrice");if(!n)return{};const a=(0,l.add0x)(n.toString(16));return u("Using gasPrice from network as fallback",a),{maxFeePerGas:a}}(e)),d);c.maxFeePerGas=await async function(e,t,r){const{maxFeePerGas:n,maxPriorityFeePerGas:i}=e,{gasPrice:o}=r??{};if(!h(n))return u("Using maxFeePerGas from request",n),n;if(h(i)&&o)return u("Setting maxFeePerGas to transaction gasPrice",o),o;const{maxFeePerGas:s}=await t();if(!s)throw new Error("Failed to get gas fee estimate for maxFeePerGas");return u("Using maxFeePerGas from estimate",s),s}(r,m,n),c.maxPriorityFeePerGas=await async function(e,t,r,n){const{maxFeePerGas:i,maxPriorityFeePerGas:o}=e,{gasPrice:s}=n??{},{maxFeePerGas:a}=r;if(!h(o))return u("Using maxPriorityFeePerGas from request",o),o;if(h(i)&&s)return u("Setting maxPriorityFeePerGas to transaction gasPrice",s),s;const{maxPriorityFeePerGas:l}=await t();if(l)return u("Using maxPriorityFeePerGas from estimate",l),l;return u("Setting maxPriorityFeePerGas to maxFeePerGas",a),a}(r,m,c,n),t.userFeeLevel=function(e,t,r,n){const{origin:o}=e,{maxFeePerGas:s,maxPriorityFeePerGas:l}=t,{maxFeePerGas:c,maxPriorityFeePerGas:d}=r||{};if(h(s)&&h(l)&&n?.gasPrice)return o===i.ORIGIN_METAMASK?a.UserFeeLevel.CUSTOM:a.UserFeeLevel.DAPP_SUGGESTED;if(h(s)&&h(l)&&c&&d)return a.UserFeeLevel.MEDIUM;if(o===i.ORIGIN_METAMASK)return a.UserFeeLevel.CUSTOM;return a.UserFeeLevel.DAPP_SUGGESTED}(t,r,d,n)}}}},{package:"@metamask/user-operation-controller",file:"node_modules/@metamask/user-operation-controller/dist/utils/gas-fees.cjs"}],[3536,{"../constants.cjs":3527,"../helpers/Bundler.cjs":3528,"../logger.cjs":3532,"@metamask/controller-utils":1639,"@metamask/utils":3554,"bn.js":4413},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.updateGas=void 0;const i=e("@metamask/controller-utils"),o=e("@metamask/utils"),s=n(e("bn.js")),a=e("../constants.cjs"),l=e("../helpers/Bundler.cjs"),c=e("../logger.cjs"),d=(0,c.createModuleLogger)(c.projectLogger,"gas");function u(e){const t=("string"==typeof e?(0,i.hexToBN)(e):new s.default(e)).muln(1.5);return(0,o.add0x)(t.toString(16))}r.updateGas=async function(e,t,r){const{userOperation:n}=e;if(t.gas)return n.callGasLimit=t.gas.callGasLimit,n.preVerificationGas=t.gas.preVerificationGas,n.verificationGasLimit=t.gas.verificationGasLimit,void d("Using gas values from smart contract account",{callGasLimit:n.callGasLimit,preVerificationGas:n.preVerificationGas,verificationGasLimit:n.verificationGasLimit});const i={...n,maxFeePerGas:a.VALUE_ZERO,maxPriorityFeePerGas:a.VALUE_ZERO,callGasLimit:a.VALUE_ZERO,preVerificationGas:a.VALUE_ZERO,verificationGasLimit:"0xF4240"},o=new l.Bundler(e.bundlerUrl),s=await o.estimateUserOperationGas(i,r);n.callGasLimit=u(s.callGasLimit),n.preVerificationGas=u(s.preVerificationGas),n.verificationGasLimit=u(s.verificationGasLimit??s.verificationGas),d("Using buffered gas values from bundler estimate",{callGasLimit:n.callGasLimit,preVerificationGas:n.preVerificationGas,verificationGasLimit:n.verificationGasLimit,multiplier:1.5,estimate:s})}}}},{package:"@metamask/user-operation-controller",file:"node_modules/@metamask/user-operation-controller/dist/utils/gas.cjs"}],[3537,{"../constants.cjs":3527,"../types.cjs":3533,"@metamask/transaction-controller":3473,"@metamask/utils":3554,"bn.js":4413},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.getTransactionMetadata=void 0;const i=e("@metamask/transaction-controller"),o=e("@metamask/utils"),s=n(e("bn.js")),a=e("../constants.cjs"),l=e("../types.cjs");r.getTransactionMetadata=function(e){const{actualGasCost:t,actualGasUsed:r,baseFeePerGas:n,chainId:c,error:d,origin:u,transactionHash:p,id:h,swapsMetadata:m,time:g,transactionParams:f,transactionType:y,userFeeLevel:C,userOperation:b}=e;if(!f)return undefined;const v=t&&r?(0,o.add0x)(new s.default((0,o.remove0x)(t),16).div(new s.default((0,o.remove0x)(r),16)).toString(16)):undefined,w=d?{name:d.name,message:d.message,stack:d.stack,code:d.code,rpc:d.rpc}:undefined,S={[l.UserOperationStatus.Unapproved]:i.TransactionStatus.unapproved,[l.UserOperationStatus.Approved]:i.TransactionStatus.approved,[l.UserOperationStatus.Signed]:i.TransactionStatus.signed,[l.UserOperationStatus.Submitted]:i.TransactionStatus.submitted,[l.UserOperationStatus.Confirmed]:i.TransactionStatus.confirmed,[l.UserOperationStatus.Failed]:i.TransactionStatus.failed}[e.status],T=function(...e){const t=new s.default(0);for(const r of e)r&&t.iadd(new s.default((0,o.remove0x)(r),16));return(0,o.add0x)(t.toString(16))}(b.preVerificationGas,b.verificationGasLimit,b.callGasLimit),k=b.paymasterAndData!==a.EMPTY_BYTES,A=k?a.VALUE_ZERO:b.maxFeePerGas,M=k?a.VALUE_ZERO:b.maxPriorityFeePerGas,P=b.nonce===a.EMPTY_BYTES?undefined:b.nonce,E={...f,from:b.sender,gas:T,nonce:P,maxFeePerGas:A,maxPriorityFeePerGas:M};delete E.gasPrice;const I={approvalTxId:m?.approvalTxId??undefined,destinationTokenAddress:m?.destinationTokenAddress??undefined,destinationTokenAmount:m?.destinationTokenAmount??undefined,destinationTokenDecimals:m?.destinationTokenDecimals??undefined,destinationTokenSymbol:m?.destinationTokenSymbol??undefined,estimatedBaseFee:m?.estimatedBaseFee??undefined,sourceTokenAddress:m?.sourceTokenAddress??undefined,sourceTokenAmount:m?.sourceTokenAmount??undefined,sourceTokenDecimals:m?.sourceTokenDecimals??undefined,sourceTokenSymbol:m?.sourceTokenSymbol??undefined,swapAndSendRecipient:m?.swapAndSendRecipient??undefined,swapMetaData:m?.swapMetaData??undefined,swapTokenValue:m?.swapTokenValue??undefined},_=k?i.UserFeeLevel.CUSTOM:C;return{baseFeePerGas:n??undefined,chainId:c,error:w,hash:p??undefined,id:h,isUserOperation:!0,networkClientId:"user-operation",origin:u,status:S,time:g,txParams:E,txReceipt:{effectiveGasPrice:v??undefined,gasUsed:r??undefined},type:y??undefined,userFeeLevel:_,...I}}}}},{package:"@metamask/user-operation-controller",file:"node_modules/@metamask/user-operation-controller/dist/utils/transaction.cjs"}],[3538,{"../constants.cjs":3527,"@metamask/superstruct":3415,"@metamask/transaction-controller":3473,"@metamask/utils":3554},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.validateSignUserOperationResponse=r.validateUpdateUserOperationResponse=r.validatePrepareUserOperationResponse=r.validateAddUserOperationOptions=r.validateAddUserOperationRequest=void 0;const n=e("@metamask/superstruct"),i=e("@metamask/transaction-controller"),o=e("@metamask/utils"),s=e("../constants.cjs");function a(e,t,r){try{(0,n.assert)(e,t,r)}catch(e){const t=e.failures().map(e=>e.path.length?`${e.path.join(".")} - ${e.message}`:e.message).join("\n");throw new Error(`${r}\n${t}`)}}function l(){return(0,n.define)("Hexadecimal String",e=>(0,o.isStrictHexString)(e))}function c(){return(0,n.define)("Hexadecimal String or 0x",e=>(0,o.isStrictHexString)(e)||e===s.EMPTY_BYTES)}r.validateAddUserOperationRequest=function(e){const t=l(),r=c();a(e,(0,n.object)({data:(0,n.optional)(r),from:t,maxFeePerGas:(0,n.optional)(t),maxPriorityFeePerGas:(0,n.optional)(t),to:(0,n.optional)(t),value:(0,n.optional)(t)}),"Invalid request to add user operation")},r.validateAddUserOperationOptions=function(e){a(e,(0,n.object)({networkClientId:(0,n.string)(),origin:(0,n.string)(),requireApproval:(0,n.optional)((0,n.boolean)()),smartContractAccount:(0,n.optional)((0,n.object)({prepareUserOperation:(0,n.func)(),updateUserOperation:(0,n.func)(),signUserOperation:(0,n.func)()})),swaps:(0,n.optional)((0,n.object)({approvalTxId:(0,n.optional)((0,n.string)()),destinationTokenAddress:(0,n.optional)((0,n.string)()),destinationTokenDecimals:(0,n.optional)((0,n.number)()),destinationTokenSymbol:(0,n.optional)((0,n.string)()),estimatedBaseFee:(0,n.optional)((0,n.string)()),sourceTokenSymbol:(0,n.optional)((0,n.string)()),swapMetaData:(0,n.optional)((0,n.object)()),swapTokenValue:(0,n.optional)((0,n.string)()),destinationTokenAmount:(0,n.optional)((0,n.string)()),sourceTokenAddress:(0,n.optional)((0,n.string)()),sourceTokenAmount:(0,n.optional)((0,n.string)()),sourceTokenDecimals:(0,n.optional)((0,n.number)()),swapAndSendRecipient:(0,n.optional)((0,n.string)())})),type:(0,n.optional)((0,n.enums)(Object.values(i.TransactionType)))}),"Invalid options to add user operation")},r.validatePrepareUserOperationResponse=function(e){const t=l(),r=c();a(e,(0,n.refine)((0,n.object)({bundler:(0,n.string)(),callData:t,dummyPaymasterAndData:(0,n.optional)(r),dummySignature:(0,n.optional)(r),gas:(0,n.optional)((0,n.object)({callGasLimit:t,preVerificationGas:t,verificationGasLimit:t})),initCode:(0,n.optional)(r),nonce:t,sender:t}),"ValidPrepareUserOperationResponse",({gas:e,dummySignature:t})=>!!(e||t&&t!==s.EMPTY_BYTES)||"Must specify dummySignature if not specifying gas"),"Invalid response when preparing user operation")},r.validateUpdateUserOperationResponse=function(e){a(e,(0,n.optional)((0,n.object)({paymasterAndData:(0,n.optional)(c()),callGasLimit:(0,n.optional)(c()),preVerificationGas:(0,n.optional)(c()),verificationGasLimit:(0,n.optional)(c())})),"Invalid response when updating user operation")},r.validateSignUserOperationResponse=function(e){const t=l();a(e,(0,n.object)({signature:t}),"Invalid response when signing user operation")}}}},{package:"@metamask/user-operation-controller",file:"node_modules/@metamask/user-operation-controller/dist/utils/validation.cjs"}],[3539,{"fast-json-stable-stringify":4789,uuid:6134},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n=this&&this.__classPrivateFieldGet||function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.AbstractPollingControllerBaseMixin=r.getKey=void 0;const o=i(e("fast-json-stable-stringify")),s=e("uuid");r.getKey=e=>(0,o.default)(e),r.AbstractPollingControllerBaseMixin=function(e){var t,i;return t=new WeakMap,i=new WeakMap,class extends e{constructor(){super(...arguments),t.set(this,new Map),i.set(this,new Map)}startPolling(e){const i=(0,s.v4)(),o=(0,r.getKey)(e),a=n(this,t,"f").get(o)??new Set;return a.add(i),n(this,t,"f").set(o,a),1===a.size&&this._startPolling(e),i}stopAllPolling(){n(this,t,"f").forEach((e,t)=>{e.forEach(e=>{this.stopPollingByPollingToken(e)})})}stopPollingByPollingToken(e){if(!e)throw new Error("pollingToken required");let r=null;for(const[i,o]of n(this,t,"f"))if(o.delete(e)){0===o.size&&(r=i);break}if(r){this._stopPollingByPollingTokenSetId(r),n(this,t,"f").delete(r);const e=n(this,i,"f").get(r);if(e){for(const t of e)t(JSON.parse(r));e.clear()}}}onPollingComplete(e,t){const o=(0,r.getKey)(e),s=n(this,i,"f").get(o)??new Set;s.add(t),n(this,i,"f").set(o,s)}}}}}},{package:"@metamask/user-operation-controller>@metamask/polling-controller",file:"node_modules/@metamask/user-operation-controller/node_modules/@metamask/polling-controller/dist/AbstractPollingController.cjs"}],[3540,{"./AbstractPollingController.cjs":3539,"@metamask/base-controller":1520},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n=this&&this.__classPrivateFieldGet||function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};Object.defineProperty(r,"__esModule",{value:!0}),r.BlockTrackerPollingController=r.BlockTrackerPollingControllerOnly=void 0;const i=e("@metamask/base-controller"),o=e("./AbstractPollingController.cjs");function s(e){var t;class r extends((0,o.AbstractPollingControllerBaseMixin)(e)){constructor(){super(...arguments),t.set(this,{})}_startPolling(e){const r=(0,o.getKey)(e);if(n(this,t,"f")[r])return;const i=this._getNetworkClientById(e.networkClientId);if(!i)throw new Error(`Unable to retrieve blockTracker for networkClientId ${e.networkClientId}`);{const o=this._executePoll.bind(this,e);i.blockTracker.addListener("latest",o),n(this,t,"f")[r]=o}}_stopPollingByPollingTokenSetId(e){const{networkClientId:r}=JSON.parse(e),i=this._getNetworkClientById(r);if(i&&n(this,t,"f")[e]){const r=n(this,t,"f")[e];r&&(i.blockTracker.removeListener("latest",r),delete n(this,t,"f")[e])}}}return t=new WeakMap,r}class a{}r.BlockTrackerPollingControllerOnly=()=>s(a);r.BlockTrackerPollingController=()=>s(i.BaseController)}}},{package:"@metamask/user-operation-controller>@metamask/polling-controller",file:"node_modules/@metamask/user-operation-controller/node_modules/@metamask/polling-controller/dist/BlockTrackerPollingController.cjs"}],[3541,{"./AbstractPollingController.cjs":3539,"@metamask/base-controller":1520},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n=this&&this.__classPrivateFieldSet||function(e,t,r,n,i){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?i.call(e,r):i?i.value=r:t.set(e,r),r},i=this&&this.__classPrivateFieldGet||function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};Object.defineProperty(r,"__esModule",{value:!0}),r.StaticIntervalPollingController=r.StaticIntervalPollingControllerOnly=void 0;const o=e("@metamask/base-controller"),s=e("./AbstractPollingController.cjs");function a(e){var t,r;class o extends((0,s.AbstractPollingControllerBaseMixin)(e)){constructor(){super(...arguments),t.set(this,{}),r.set(this,1e3)}setIntervalLength(e){n(this,r,e,"f")}getIntervalLength(){return i(this,r,"f")}_startPolling(e){if(!i(this,r,"f"))throw new Error("intervalLength must be defined and greater than 0");const n=(0,s.getKey)(e),o=i(this,t,"f")[n];this._stopPollingByPollingTokenSetId(n);const a=i(this,t,"f")[n]=setTimeout(async()=>{try{await this._executePoll(e)}catch(e){console.error(e)}a===i(this,t,"f")[n]&&this._startPolling(e)},o?i(this,r,"f"):0)}_stopPollingByPollingTokenSetId(e){const r=i(this,t,"f")[e];r&&(clearTimeout(r),delete i(this,t,"f")[e])}}return t=new WeakMap,r=new WeakMap,o}class l{}r.StaticIntervalPollingControllerOnly=()=>a(l);r.StaticIntervalPollingController=()=>a(o.BaseController)}}},{package:"@metamask/user-operation-controller>@metamask/polling-controller",file:"node_modules/@metamask/user-operation-controller/node_modules/@metamask/polling-controller/dist/StaticIntervalPollingController.cjs"}],[3542,{"./BlockTrackerPollingController.cjs":3540,"./StaticIntervalPollingController.cjs":3541},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.StaticIntervalPollingController=r.StaticIntervalPollingControllerOnly=r.BlockTrackerPollingController=r.BlockTrackerPollingControllerOnly=void 0;var n=e("./BlockTrackerPollingController.cjs");Object.defineProperty(r,"BlockTrackerPollingControllerOnly",{enumerable:!0,get:function(){return n.BlockTrackerPollingControllerOnly}}),Object.defineProperty(r,"BlockTrackerPollingController",{enumerable:!0,get:function(){return n.BlockTrackerPollingController}});var i=e("./StaticIntervalPollingController.cjs");Object.defineProperty(r,"StaticIntervalPollingControllerOnly",{enumerable:!0,get:function(){return i.StaticIntervalPollingControllerOnly}}),Object.defineProperty(r,"StaticIntervalPollingController",{enumerable:!0,get:function(){return i.StaticIntervalPollingController}})}}},{package:"@metamask/user-operation-controller>@metamask/polling-controller",file:"node_modules/@metamask/user-operation-controller/node_modules/@metamask/polling-controller/dist/index.cjs"}],[3567,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){t.exports=function(e){if(e.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;for(var n=0;n<e.length;n++){var i=e.charAt(n),o=i.charCodeAt(0);if(255!==t[o])throw new TypeError(i+" is ambiguous");t[o]=n}var s=e.length,a=e.charAt(0),l=Math.log(s)/Math.log(256),c=Math.log(256)/Math.log(s);function d(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var r=0;if(" "!==e[r]){for(var n=0,i=0;e[r]===a;)n++,r++;for(var o=(e.length-r)*l+1>>>0,c=new Uint8Array(o);e[r];){var d=t[e.charCodeAt(r)];if(255===d)return;for(var u=0,p=o-1;(0!==d||u<i)&&-1!==p;p--,u++)d+=s*c[p]>>>0,c[p]=d%256>>>0,d=d/256>>>0;if(0!==d)throw new Error("Non-zero carry");i=u,r++}if(" "!==e[r]){for(var h=o-i;h!==o&&0===c[h];)h++;for(var m=new Uint8Array(n+(o-h)),g=n;h!==o;)m[g++]=c[h++];return m}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var r=0,n=0,i=0,o=t.length;i!==o&&0===t[i];)i++,r++;for(var l=(o-i)*c+1>>>0,d=new Uint8Array(l);i!==o;){for(var u=t[i],p=0,h=l-1;(0!==u||p<n)&&-1!==h;h--,p++)u+=256*d[h]>>>0,d[h]=u%s>>>0,u=u/s>>>0;if(0!==u)throw new Error("Non-zero carry");n=p,i++}for(var m=l-n;m!==l&&0===d[m];)m++;for(var g=a.repeat(r);m<l;++m)g+=e.charAt(d[m]);return g},decodeUnsafe:d,decode:function(e){var t=d(e);if(t)return t;throw new Error("Non-base"+s+" character")}}}}}},{package:"@ensdomains/content-hash>cids>multibase>@multiformats/base-x",file:"node_modules/@multiformats/base-x/src/index.js"}],[3597,{"./utils.js":3611},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.aoutput=r.anumber=r.aexists=r.abytes=void 0;const n=e("./utils.js");r.abytes=n.abytes,r.aexists=n.aexists,r.anumber=n.anumber,r.aoutput=n.aoutput}}},{package:"@noble/hashes",file:"node_modules/@noble/hashes/_assert.js"}],[36,{"../../../../shared/constants/app":6175,"@metamask/approval-controller":1359,"@metamask/controller-utils":1639,"@metamask/snaps-rpc-methods":3209},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.ApprovalControllerInit=void 0;var n=e("@metamask/approval-controller"),i=e("@metamask/controller-utils"),o=e("@metamask/snaps-rpc-methods"),s=e("../../../../shared/constants/app");r.ApprovalControllerInit=({controllerMessenger:e,showUserConfirmation:t})=>({persistedStateKey:null,memStateKey:null,controller:new n.ApprovalController({messenger:e,showApprovalRequest:t,typesExcludedFromRateLimiting:[i.ApprovalType.PersonalSign,i.ApprovalType.EthSignTypedData,i.ApprovalType.Transaction,i.ApprovalType.WatchAsset,i.ApprovalType.EthGetEncryptionPublicKey,i.ApprovalType.EthDecrypt,s.SMART_TRANSACTION_CONFIRMATION_TYPES.showSmartTransactionStatusPage,o.DIALOG_APPROVAL_TYPES.default]})})}}},{package:"$root$",file:"app/scripts/controller-init/confirmations/approval-controller-init.ts"}],[360,{"../../../../../shared/lib/delegation":6266,"../../../../../shared/lib/delegation/delegation":6263,"@metamask/transaction-controller":3473,"@metamask/utils":3554,"bignumber.js":4362},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.enforceSimulations=async function({messenger:e,transactionMeta:t,useRealSignature:r=!1}){l("Enforcing simulations",{transactionMeta:t,useRealSignature:r});const{chainId:o,simulationData:u={tokenBalanceChanges:[]},txParams:p}=t,h=p.from,m=(0,i.hexToNumber)(o),g=(0,s.getDeleGatorEnvironment)(m),f=g.DelegationManager,y=function(e,t){const r=e.call("AppStateController:getState"),n=r.enforcedSimulationsSlippage;return r.enforcedSimulationsSlippageForTransactions[t]??n}(e,t.id),C=function({accountAddress:e,environment:t,simulationData:r,slippage:i}){const o=function(e,t,r,i){const o=(0,s.createCaveatBuilder)(t),{nativeBalanceChange:a,tokenBalanceChanges:c=[]}=r;if(a){const{difference:t,isDecrease:r}=a,n=d(t,i,r);l("Caveat - Native Balance Change",{enforceDecrease:r,recipient:e,delta:BigInt(t),slippage:i,deltaWithSlippage:n}),o.addCaveat("nativeBalanceChange",r,e,n)}for(const t of c){const{difference:r,isDecrease:s,address:a,standard:c,id:u}=t,p=BigInt(r),h=d(r,i,s),m=u?BigInt(u):0n;switch(l("Caveat - Token Balance Change",{enforceDecrease:s,token:a,recipient:e,delta:p,slippage:i,deltaWithSlippage:h}),c){case n.SimulationTokenStandard.erc20:o.addCaveat("erc20BalanceChange",s,a,e,h);break;case n.SimulationTokenStandard.erc721:o.addCaveat("erc721BalanceChange",s,a,e,p);break;case n.SimulationTokenStandard.erc1155:o.addCaveat("erc1155BalanceChange",s,a,e,m,p);break;default:l("Unsupported token standard",c)}}return o.build()}(e,t,r,i);l("Caveats",o);const a=(0,s.createDelegation)({from:e,to:e,caveats:o});return a}({accountAddress:h,environment:g,simulationData:u,slippage:y});l("Delegation",C);let b=c;r&&(l("Signing delegation"),b=await e.call("DelegationController:signDelegation",{chainId:o,delegation:C}));l("Delegation signature",b);const v=function({transaction:e,delegation:t}){const r=[[t]],n=[s.SINGLE_DEFAULT_MODE],i=[[{target:e.to,callData:e.data??"0x",value:e.value?BigInt(e.value):0n}]];return(0,a.encodeRedeemDelegations)({delegations:r,modes:n,executions:i})}({transaction:p,delegation:{...C,signature:b}});return l("Data",v),{updateTransaction:e=>{e.txParams.data=v,e.txParams.to=f,e.txParams.value="0x0"}}};var n=e("@metamask/transaction-controller"),i=e("@metamask/utils"),o=e("bignumber.js"),s=e("../../../../../shared/lib/delegation"),a=e("../../../../../shared/lib/delegation/delegation");const l=(0,i.createProjectLogger)("enforced-simulations"),c="0x2261a7810ed3e9cde160895909e138e2f68adb2da86fcf98ea0840701df107721fb369ab9b52550ea98832c09f8185284aca4c94bd345e867a4f4461868dd7751b";function d(e,t,r){const n=new o.BigNumber(e),i=(100+(r?t:-t))/100;return BigInt(n.mul(i).toFixed(0))}}}},{package:"$root$",file:"app/scripts/lib/transaction/containers/enforced-simulations.ts"}],[361,{"./enforced-simulations":360,"@metamask/transaction-controller":3473,"@metamask/utils":3554,lodash:5239},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.applyTransactionContainers=l,r.applyTransactionContainersExisting=async function({containerTypes:e,transactionId:t,messenger:r,updateEditableParams:n}){const o=(await r.call("TransactionController:getState")).transactions.find(e=>e.id===t);if(!o)throw new Error(`Transaction with ID ${t} not found.`);const{updateTransaction:s}=await l({isApproved:!1,messenger:r,transactionMeta:o,types:e}),a=(0,i.cloneDeep)(o);s(a),n(t,{containerTypes:e,data:a.txParams.data,gas:a.txParams.gas,to:a.txParams.to,value:a.txParams.value})};var n=e("@metamask/transaction-controller"),i=e("lodash"),o=e("@metamask/utils"),s=e("./enforced-simulations");const a=(0,o.createProjectLogger)("transaction-containers");async function l({isApproved:e,messenger:t,transactionMeta:r,types:o}){const{txParamsOriginal:l}=r,c=(0,i.cloneDeep)(r);if(l&&(c.txParams=(0,i.cloneDeep)(l)),o.includes(n.TransactionContainerType.EnforcedSimulations)){const{updateTransaction:r}=await(0,s.enforceSimulations)({messenger:t,transactionMeta:c,useRealSignature:e});r(c)}let d;if(!e){const{gas:e}=await t.call("TransactionController:estimateGas",c.txParams,c.networkClientId,{ignoreDelegationSignatures:!0});a("Estimated gas",e),d=e}return{updateTransaction:e=>{e.containerTypes=o,e.txParams=(0,i.cloneDeep)(c.txParams),d&&(e.txParams.gas=d)}}}}}},{package:"$root$",file:"app/scripts/lib/transaction/containers/util.ts"}],[3612,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.openrpcDocument=void 0,r.openrpcDocument={$schema:"https://meta.json-schema.tools/",$id:"https://meta.open-rpc.org/",title:"openrpcDocument",type:"object",required:["info","methods","openrpc"],additionalProperties:!1,patternProperties:{"^x-":{$ref:"#/definitions/specificationExtension"}},properties:{openrpc:{title:"openrpc",type:"string",enum:["1.3.2","1.3.1","1.3.0","1.2.6","1.2.5","1.2.4","1.2.3","1.2.2","1.2.1","1.2.0","1.1.12","1.1.11","1.1.10","1.1.9","1.1.8","1.1.7","1.1.6","1.1.5","1.1.4","1.1.3","1.1.2","1.1.1","1.1.0","1.0.0","1.0.0-rc1","1.0.0-rc0"]},info:{$ref:"#/definitions/infoObject"},externalDocs:{$ref:"#/definitions/externalDocumentationObject"},servers:{title:"servers",type:"array",additionalItems:!1,items:{$ref:"#/definitions/serverObject"}},methods:{title:"methods",type:"array",additionalItems:!1,items:{title:"methodOrReference",oneOf:[{$ref:"#/definitions/methodObject"},{$ref:"#/definitions/referenceObject"}]}},components:{title:"components",type:"object",properties:{schemas:{title:"schemaComponents",type:"object",patternProperties:{"[0-z]+":{$ref:"#/definitions/JSONSchema"}}},links:{title:"linkComponents",type:"object",patternProperties:{"[0-z]+":{$ref:"#/definitions/linkObject"}}},errors:{title:"errorComponents",type:"object",patternProperties:{"[0-z]+":{$ref:"#/definitions/errorObject"}}},examples:{title:"exampleComponents",type:"object",patternProperties:{"[0-z]+":{$ref:"#/definitions/exampleObject"}}},examplePairings:{title:"examplePairingComponents",type:"object",patternProperties:{"[0-z]+":{$ref:"#/definitions/examplePairingObject"}}},contentDescriptors:{title:"contentDescriptorComponents",type:"object",patternProperties:{"[0-z]+":{$ref:"#/definitions/contentDescriptorObject"}}},tags:{title:"tagComponents",type:"object",patternProperties:{"[0-z]+":{$ref:"#/definitions/tagObject"}}}}},$schema:{title:"metaSchema",description:"JSON Schema URI (used by some editors)",type:"string",default:"https://meta.open-rpc.org/"}},definitions:{specificationExtension:{title:"specificationExtension"},JSONSchema:{$ref:"https://meta.json-schema.tools"},referenceObject:{title:"referenceObject",type:"object",additionalProperties:!1,required:["$ref"],properties:{$ref:{$ref:"https://meta.json-schema.tools/#/definitions/JSONSchemaObject/properties/$ref"}}},errorObject:{title:"errorObject",type:"object",description:"Defines an application level error.",additionalProperties:!1,required:["code","message"],properties:{code:{title:"errorObjectCode",description:"A Number that indicates the error type that occurred. This MUST be an integer. The error codes from and including -32768 to -32000 are reserved for pre-defined errors. These pre-defined errors SHOULD be assumed to be returned from any JSON-RPC api.",type:"integer"},message:{title:"errorObjectMessage",description:"A String providing a short description of the error. The message SHOULD be limited to a concise single sentence.",type:"string"},data:{title:"errorObjectData",description:"A Primitive or Structured value that contains additional information about the error. This may be omitted. The value of this member is defined by the Server (e.g. detailed error information, nested errors etc.)."}}},licenseObject:{title:"licenseObject",type:"object",additionalProperties:!1,properties:{name:{title:"licenseObjectName",type:"string"},url:{title:"licenseObjectUrl",type:"string"}},patternProperties:{"^x-":{$ref:"#/definitions/specificationExtension"}}},contactObject:{title:"contactObject",type:"object",additionalProperties:!1,properties:{name:{title:"contactObjectName",type:"string"},email:{title:"contactObjectEmail",type:"string"},url:{title:"contactObjectUrl",type:"string"}},patternProperties:{"^x-":{$ref:"#/definitions/specificationExtension"}}},infoObject:{title:"infoObject",type:"object",additionalProperties:!1,required:["title","version"],properties:{title:{title:"infoObjectProperties",type:"string"},description:{title:"infoObjectDescription",type:"string"},termsOfService:{title:"infoObjectTermsOfService",type:"string",format:"uri"},version:{title:"infoObjectVersion",type:"string"},contact:{$ref:"#/definitions/contactObject"},license:{$ref:"#/definitions/licenseObject"}},patternProperties:{"^x-":{$ref:"#/definitions/specificationExtension"}}},serverObject:{title:"serverObject",type:"object",required:["url"],additionalProperties:!1,properties:{url:{title:"serverObjectUrl",type:"string",format:"uri"},name:{title:"serverObjectName",type:"string"},description:{title:"serverObjectDescription",type:"string"},summary:{title:"serverObjectSummary",type:"string"},variables:{title:"serverObjectVariables",type:"object",patternProperties:{"[0-z]+":{title:"serverObjectVariable",type:"object",required:["default"],properties:{default:{title:"serverObjectVariableDefault",type:"string"},description:{title:"serverObjectVariableDescription",type:"string"},enum:{title:"serverObjectVariableEnum",type:"array",items:{title:"serverObjectVariableEnumItem",type:"string"}}}}}}},patternProperties:{"^x-":{$ref:"#/definitions/specificationExtension"}}},linkObject:{title:"linkObject",type:"object",additionalProperties:!1,properties:{name:{title:"linkObjectName",type:"string",minLength:1},summary:{title:"linkObjectSummary",type:"string"},method:{title:"linkObjectMethod",type:"string"},description:{title:"linkObjectDescription",type:"string"},params:{title:"linkObjectParams"},server:{title:"linkObjectServer",$ref:"#/definitions/serverObject"}},patternProperties:{"^x-":{$ref:"#/definitions/specificationExtension"}}},externalDocumentationObject:{title:"externalDocumentationObject",type:"object",additionalProperties:!1,description:"information about external documentation",required:["url"],properties:{description:{title:"externalDocumentationObjectDescription",type:"string"},url:{title:"externalDocumentationObjectUrl",type:"string",format:"uri"}},patternProperties:{"^x-":{$ref:"#/definitions/specificationExtension"}}},methodObject:{title:"methodObject",type:"object",required:["name","params"],additionalProperties:!1,properties:{name:{title:"methodObjectName",description:"The cannonical name for the method. The name MUST be unique within the methods array.",type:"string",minLength:1},description:{title:"methodObjectDescription",description:"A verbose explanation of the method behavior. GitHub Flavored Markdown syntax MAY be used for rich text representation.",type:"string"},summary:{title:"methodObjectSummary",description:"A short summary of what the method does.",type:"string"},servers:{title:"servers",type:"array",additionalItems:!1,items:{$ref:"#/definitions/serverObject"}},tags:{title:"methodObjectTags",type:"array",items:{title:"tagOrReference",oneOf:[{$ref:"#/definitions/tagObject"},{$ref:"#/definitions/referenceObject"}]}},paramStructure:{title:"methodObjectParamStructure",type:"string",description:"Format the server expects the params. Defaults to 'either'.",enum:["by-position","by-name","either"],default:"either"},params:{title:"methodObjectParams",type:"array",items:{title:"contentDescriptorOrReference",oneOf:[{$ref:"#/definitions/contentDescriptorObject"},{$ref:"#/definitions/referenceObject"}]}},result:{title:"methodObjectResult",oneOf:[{$ref:"#/definitions/contentDescriptorObject"},{$ref:"#/definitions/referenceObject"}]},errors:{title:"methodObjectErrors",description:"Defines an application level error.",type:"array",items:{title:"errorOrReference",oneOf:[{$ref:"#/definitions/errorObject"},{$ref:"#/definitions/referenceObject"}]}},links:{title:"methodObjectLinks",type:"array",items:{title:"linkOrReference",oneOf:[{$ref:"#/definitions/linkObject"},{$ref:"#/definitions/referenceObject"}]}},examples:{title:"methodObjectExamples",type:"array",items:{title:"examplePairingOrReference",oneOf:[{$ref:"#/definitions/examplePairingObject"},{$ref:"#/definitions/referenceObject"}]}},deprecated:{title:"methodObjectDeprecated",type:"boolean",default:!1},externalDocs:{$ref:"#/definitions/externalDocumentationObject"}},patternProperties:{"^x-":{$ref:"#/definitions/specificationExtension"}}},tagObject:{title:"tagObject",type:"object",additionalProperties:!1,required:["name"],properties:{name:{title:"tagObjectName",type:"string",minLength:1},description:{title:"tagObjectDescription",type:"string"},externalDocs:{$ref:"#/definitions/externalDocumentationObject"}},patternProperties:{"^x-":{$ref:"#/definitions/specificationExtension"}}},exampleObject:{title:"exampleObject",type:"object",required:["name","value"],properties:{summary:{title:"exampleObjectSummary",type:"string"},value:{title:"exampleObjectValue"},description:{title:"exampleObjectDescription",type:"string"},name:{title:"exampleObjectName",type:"string",minLength:1}},patternProperties:{"^x-":{$ref:"#/definitions/specificationExtension"}}},examplePairingObject:{title:"examplePairingObject",type:"object",required:["name","params"],properties:{name:{title:"examplePairingObjectName",type:"string",minLength:1},description:{title:"examplePairingObjectDescription",type:"string"},params:{title:"examplePairingObjectParams",type:"array",items:{title:"exampleOrReference",oneOf:[{$ref:"#/definitions/exampleObject"},{$ref:"#/definitions/referenceObject"}]}},result:{title:"examplePairingObjectResult",oneOf:[{$ref:"#/definitions/exampleObject"},{$ref:"#/definitions/referenceObject"}]}}},contentDescriptorObject:{title:"contentDescriptorObject",type:"object",additionalProperties:!1,required:["name","schema"],properties:{name:{title:"contentDescriptorObjectName",type:"string",minLength:1},description:{title:"contentDescriptorObjectDescription",type:"string"},summary:{title:"contentDescriptorObjectSummary",type:"string"},schema:{$ref:"#/definitions/JSONSchema"},required:{title:"contentDescriptorObjectRequired",type:"boolean",default:!1},deprecated:{title:"contentDescriptorObjectDeprecated",type:"boolean",default:!1}},patternProperties:{"^x-":{$ref:"#/definitions/specificationExtension"}}}}},r.default=r.openrpcDocument}}},{package:"@open-rpc/meta-schema",file:"node_modules/@open-rpc/meta-schema/index.js"}],[3613,{"@json-schema-tools/dereferencer":885,"@json-schema-tools/reference-resolver":889,"fast-safe-stringify":4790},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},n.apply(this,arguments)},i=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}l((n=n.apply(e,t||[])).next())})},o=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(l){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(s=0)),s;)try{if(r=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{r=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.OpenRPCDocumentDereferencingError=void 0;var a=s(e("@json-schema-tools/dereferencer")),l=s(e("@json-schema-tools/reference-resolver")),c=s(e("fast-safe-stringify")),d=function(e){this.name="OpenRPCDocumentDereferencingError",this.message="The json schema provided cannot be dereferenced. Received Error: \n ".concat(e)};r.OpenRPCDocumentDereferencingError=d;var u=function(e,t,r){return i(void 0,void 0,void 0,function(){var n,i;return o(this,function(o){switch(o.label){case 0:if((n=e.$ref)===undefined)return[2,e];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,r.resolve(n,t)];case 2:return[2,o.sent()];case 3:throw i=o.sent(),new d(["unable to eval pointer against OpenRPC Document.","error type: ".concat(i.name),"instance: ".concat(i.instance),"token: ".concat(i.token),"pointer: ".concat(n),"reference object: ".concat((0,c.default)(e))].join("\n"));case 4:return[2]}})})},p=function(e,t,r){return i(void 0,void 0,void 0,function(){var n,i,s,a,l,c;return o(this,function(o){switch(o.label){case 0:n=[],i=0,s=e,o.label=1;case 1:return i<s.length?(a=s[i],c=(l=n).push,[4,u(a,t,r)]):[3,4];case 2:c.apply(l,[o.sent()]),o.label=3;case 3:return i++,[3,1];case 4:return[2,n]}})})},h=function(e,t){return i(void 0,void 0,void 0,function(){var r,n,i;return o(this,function(o){switch(o.label){case 0:if(!0===e||!1===e)return[2,Promise.resolve(e)];t!==undefined&&(e.components={schemas:t}),r=new a.default(e),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,r.resolve()];case 2:return!0!==(n=o.sent())&&!1!==n&&(delete n.components,delete e.components),[2,n];case 3:throw i=o.sent(),new d(["Unable to parse reference inside of JSONSchema",e.title?"Schema Title: ".concat(e.title):"","error message: ".concat(i.message),"schema in question: ".concat((0,c.default)(e))].join("\n"));case 4:return[2]}})})},m=function(e){return i(void 0,void 0,void 0,function(){var t,r,n,i,s,a,l;return o(this,function(o){switch(o.label){case 0:if(e.components===undefined)return[2,Promise.resolve(e)];if(e.components.contentDescriptors===undefined)return[2,Promise.resolve(e)];t=e.components.contentDescriptors,r=Object.keys(t),n={},e.components.schemas&&(n=e.components.schemas),i=0,s=r,o.label=1;case 1:return i<s.length?(a=s[i],l=t[a],[4,h(t[a].schema,n)]):[3,4];case 2:l.schema=o.sent(),o.label=3;case 3:return i++,[3,1];case 4:return[2,e]}})})},g=function(e,t,r){return i(void 0,void 0,void 0,function(){var n,i,s,a,l,c,d,m,g,f,y,C,b,v,w,S,T,k,A,M;return o(this,function(o){switch(o.label){case 0:return n=e,e.$ref===undefined?[3,2]:[4,u({$ref:e.$ref},t,r)];case 1:n=o.sent(),o.label=2;case 2:return n.tags===undefined?[3,4]:(i=n,[4,p(n.tags,t,r)]);case 3:i.tags=o.sent(),o.label=4;case 4:return n.errors===undefined?[3,6]:(s=n,[4,p(n.errors,t,r)]);case 5:s.errors=o.sent(),o.label=6;case 6:return n.links===undefined?[3,8]:(a=n,[4,p(n.links,t,r)]);case 7:a.links=o.sent(),o.label=8;case 8:return n.examples===undefined?[3,14]:(l=n,[4,p(n.examples,t,r)]);case 9:l.examples=o.sent(),c=0,d=n.examples,o.label=10;case 10:return c<d.length?(m=d[c],g=m,[4,p(m.params,t,r)]):[3,14];case 11:return g.params=o.sent(),m.result===undefined?[3,13]:(f=m,[4,u(m.result,t,r)]);case 12:f.result=o.sent(),o.label=13;case 13:return c++,[3,10];case 14:return y=n,[4,p(n.params,t,r)];case 15:return y.params=o.sent(),n.result===undefined?[3,17]:(C=n,[4,u(n.result,t,r)]);case 16:C.result=o.sent(),o.label=17;case 17:b={},t.components&&t.components.schemas&&(b=t.components.schemas),v=n.params,w=0,S=v,o.label=18;case 18:return w<S.length?(T=S[w],k=T,[4,h(T.schema,b)]):[3,21];case 19:k.schema=o.sent(),o.label=20;case 20:return w++,[3,18];case 21:return n.result===undefined?[3,23]:(A=n.result,M=A,[4,h(A.schema,b)]);case 22:M.schema=o.sent(),o.label=23;case 23:return[2,n]}})})};r.default=function(e,t){return void 0===t&&(t=l.default),i(this,void 0,void 0,function(){var r,s,a,l,c,d,u;return o(this,function(p){switch(p.label){case 0:return r=n({},e),[4,(f=r,i(void 0,void 0,void 0,function(){var e,t,r,n,i,s,a;return o(this,function(o){switch(o.label){case 0:if(f.components===undefined)return[2,Promise.resolve(f)];if(f.components.schemas===undefined)return[2,Promise.resolve(f)];e=f.components.schemas,t=Object.keys(e),r=0,n=t,o.label=1;case 1:return r<n.length?(i=n[r],s=e,a=i,[4,h(e[i],e)]):[3,4];case 2:s[a]=o.sent(),o.label=3;case 3:return r++,[3,1];case 4:return[2,f]}})}))];case 1:return r=p.sent(),[4,m(r)];case 2:r=p.sent(),s=[],a=0,l=r.methods,p.label=3;case 3:return a<l.length?(c=l[a],u=(d=s).push,[4,g(c,r,t)]):[3,6];case 4:u.apply(d,[p.sent()]),p.label=5;case 5:return a++,[3,3];case 6:return r.methods=s,[2,r]}var f})})}}}},{package:"@open-rpc/schema-utils-js",file:"node_modules/@open-rpc/schema-utils-js/build/dereference-document.js"}],[3614,{"./dereference-document":3613,"./validate-open-rpc-document":3615,"@json-schema-tools/reference-resolver":889,"@json-schema-tools/reference-resolver/build/reference-resolver":890,"is-url":5042},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},n.apply(this,arguments)},i=this&&this.__createBinding||(Object.create?function(e,t,r,n){n===undefined&&(n=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,i)}:function(e,t,r,n){n===undefined&&(n=r),e[n]=t[r]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return o(t,e),t},a=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}l((n=n.apply(e,t||[])).next())})},l=this&&this.__generator||function(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(l){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(s=0)),s;)try{if(r=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{r=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},c=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.makeCustomResolver=void 0;var d=c(e("./dereference-document")),u=s(e("./validate-open-rpc-document")),p=c(e("@json-schema-tools/reference-resolver")),h=e("is-url"),m=c(e("@json-schema-tools/reference-resolver/build/reference-resolver")),g={dereference:!0,validate:!0};r.makeCustomResolver=function(e){return new m.default(e)},r.default=function(e,t){return function(r,i){return void 0===r&&(r="./openrpc.json"),void 0===i&&(i=g),a(this,void 0,void 0,function(){var o,s,a,c;return l(this,function(l){switch(l.label){case 0:return s=n(n({},g),i),"string"==typeof r?[3,1]:(o=r,[3,6]);case 1:return function(e){try{return JSON.parse(e),!0}catch(e){return!1}}(r)?(o=JSON.parse(r),[3,6]):[3,2];case 2:return h(r)?[4,e(r)]:[3,4];case 3:return o=l.sent(),[3,6];case 4:return[4,t(r)];case 5:o=l.sent(),l.label=6;case 6:if(s.validate&&(c=(0,u.default)(o))instanceof u.OpenRPCDocumentValidationError)throw c;return a=o,s.dereference?s.resolver===undefined?[3,8]:[4,(0,d.default)(o,s.resolver)]:[3,10];case 7:return a=l.sent(),[3,10];case 8:return[4,(0,d.default)(o,p.default)];case 9:a=l.sent(),l.label=10;case 10:if(s.validate&&(c=(0,u.default)(a))instanceof u.OpenRPCDocumentValidationError)throw c;return[2,a]}})})}}}}},{package:"@open-rpc/schema-utils-js",file:"node_modules/@open-rpc/schema-utils-js/build/parse-open-rpc-document.js"}],[3615,{"@json-schema-tools/meta-schema":886,"@open-rpc/meta-schema":3612,ajv:4257},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},n.apply(this,arguments)},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.OpenRPCDocumentValidationError=void 0;var o=i(e("@open-rpc/meta-schema")),s=i(e("ajv")),a=i(e("@json-schema-tools/meta-schema")),l=function(e){this.name="OpenRPCDocumentDereferencingError",this.message=["Error validating OpenRPC Document against @open-rpc/meta-schema.","The errors found are as follows:",JSON.stringify(e,undefined,"  ")].join("\n")};r.OpenRPCDocumentValidationError=l,r.default=function(e){var t=new s.default;t.addSchema(a.default,"https://meta.json-schema.tools");var r=n({},o.default);delete r.definitions.JSONSchema.$id,delete r.definitions.JSONSchema.$schema,delete r.$schema,delete r.$id;try{t.validate(r,e)}catch(e){throw new Error(["schema-utils-js: Internal Error","-----",e,"-----","If you see this report it: https://github.com/open-rpc/schema-utils-js/issues"].join("\n"))}return!t.errors||new l(t.errors)}}}},{package:"@open-rpc/schema-utils-js",file:"node_modules/@open-rpc/schema-utils-js/build/validate-open-rpc-document.js"}],[362,{"../../../../../shared/lib/four-byte":6273,"@ethersproject/abi":763,"@metamask/utils":3554,"ethereumjs-util":4728},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.decodeTransactionDataWithFourByte=async function(e){const t=e.slice(0,10),r=await(0,s.getMethodFrom4Byte)(t);if(!r)return undefined;const o=r.split("(")[0],u=function(e){let t=e.slice(e.indexOf("(")+1,-1);const r=[];for(;t.includes("(");){const e=d(t);if(!e)break;r.push(e.value),t=`${t.slice(0,e.start)}${r.length-1}#${t.slice(e.end+1)}`}return c(t,r)}(r);a("Generated inputs",u);const p=(0,n.addHexPrefix)(e.slice(10)),h=i.Interface.getAbiCoder().decode(u,p),m=u.map((e,t)=>l(e,t,h));return{name:o,params:m}};var n=e("ethereumjs-util"),i=e("@ethersproject/abi"),o=e("@metamask/utils"),s=e("../../../../../shared/lib/four-byte");const a=(0,o.createProjectLogger)("four-byte");function l(e,t,r){var n;const i=r[t],{type:o,name:s}=e;let a=null===(n=e.components)||void 0===n?void 0:n.map((e,t)=>l(e,t,i));if(o.endsWith("[]")){const t=o.slice(0,-2);a=i.map((r,n)=>{const o=`Item ${n+1}`;return l({...e,name:o,type:t},n,i)})}return{name:s,type:o,value:i,children:a}}function c(e,t){return e.split(",").map(e=>{const r=e.split("#"),n=r.length>1?parseInt(r[0],10):undefined;return{type:n===undefined?e:`tuple${r[1]??""}`,components:n===undefined?undefined:c(t[n],t)}})}function d(e){let t=-1;for(let r=0;r<e.length;r++)if("("===e[r])t=r;else if(")"===e[r]&&-1!==t)return{start:t,end:r,value:e.slice(t+1,r)};return undefined}}}},{package:"$root$",file:"app/scripts/lib/transaction/decode/four-byte.ts"}],[363,{"ethereumjs-util":4728},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.getContractProxyAddress=async function(e,t){const r=(await Promise.all(i.map(r=>t.request({method:"eth_getStorageAt",params:[e,r,"latest"]})))).find(e=>(0,n.stripHexPrefix)(e)!==o);return r&&(0,n.addHexPrefix)(r.slice(26))};var n=e("ethereumjs-util");const i=["0x7050c9e0f4ca769c69bd3a8ef740bc37934f8e2c036e5a723fd8ee048ed3f8c3","0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc"],o="0".padEnd(64,"0")}}},{package:"$root$",file:"app/scripts/lib/transaction/decode/proxy.ts"}],[364,{"@ethersproject/abi":763,"@metamask/utils":3554},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.decodeTransactionDataWithSourcify=async function(e,t,r){var a,l;const c=await async function(e,t){var r;const n=await async function(e,t){const r=parseInt(t,16),n=await fetch(`https://sourcify.dev/server/files/any/${r}/${e}`);if(!n.ok)throw new Error("Failed to fetch Sourcify files");return n.json()}(e,t),i=null===(r=n.files)||void 0===r?void 0:r.find(e=>e.name.includes("metadata.json"));if(!i)throw new Error("Metadata not found");return JSON.parse(i.content)}(t,r);i("Retrieved Sourcify metadata",{contractAddress:t,chainId:r,metadata:c});const{abi:d}=c.output,u=new n.Interface(d),p=e.slice(0,10);let h;try{h=u.getFunction(p)}catch(e){}if(!h)return i("Failed to find function in ABI",p,d),undefined;const{name:m,inputs:g}=h,f=s(m,g),y=null===(a=c.output.userdoc)||void 0===a?void 0:a.methods[f],C=null===(l=c.output.devdoc)||void 0===l?void 0:l.methods[f],b=(null==y?void 0:y.notice)??(null==C?void 0:C.details);i("Extracted NatSpec",{signature:f,userDoc:y,devDoc:C});const v=u.decodeFunctionData(p,e),w=g.map((e,t)=>o(e,t,v,y,C));return{name:m,description:b,params:w}};var n=e("@ethersproject/abi");const i=(0,e("@metamask/utils").createProjectLogger)("sourcify");function o(e,t,r,n,i){var s,a;const{name:l,type:c,components:d}=e,u=(null==n||null===(s=n.params)||void 0===s?void 0:s[l])??(null==i||null===(a=i.params)||void 0===a?void 0:a[l]),p=r[t];let h=null==d?void 0:d.map((e,t)=>o(e,t,p,{},{}));if(c.endsWith("[]")){const t=c.slice(0,-2);h=p.map((r,n)=>{const i=`Item ${n+1}`;return o({...e,name:i,type:t},n,p,{},{})})}return{name:l,description:u,type:c,value:p,children:h}}function s(e,t){return`${e??""}(${t.map(e=>{var t;return null!==(t=e.components)&&void 0!==t&&t.length?`${s(undefined,e.components)}${e.type.endsWith("[]")?"[]":""}`:e.type}).join(",")})`}}}},{package:"$root$",file:"app/scripts/lib/transaction/decode/sourcify.ts"}],[365,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.UNISWAP_ROUTER_COMMANDS=void 0;r.UNISWAP_ROUTER_COMMANDS={0:{name:"V3_SWAP_EXACT_IN",params:[{type:"address",description:"The recipient of the output of the trade",name:"recipient"},{type:"uint256",description:"The amount of input tokens for the trade",name:"amountIn"},{type:"uint256",description:"The minimum amount of output tokens the user wants",name:"amountOutMin"},{type:"bytes",description:"The UniswapV3 encoded path to trade along",name:"path"},{type:"bool",description:"A flag for whether the input tokens should come from the msg.sender (through Permit2) or whether the funds are already in the UniversalRouter",name:"payerIsUser"}]},1:{name:"V3_SWAP_EXACT_OUT",params:[{type:"address",description:"The recipient of the output of the trade",name:"recipient"},{type:"uint256",description:"The amount of output tokens to receive",name:"amountOut"},{type:"uint256",description:"The maximum number of input tokens that should be spent",name:"amountInMax"},{type:"bytes",description:"The UniswapV3 encoded path to trade along",name:"path"},{type:"bool",description:"A flag for whether the input tokens should come from the msg.sender (through Permit2) or whether the funds are already in the UniversalRouter",name:"payerIsUser"}]},2:{name:"PERMIT2_TRANSFER_FROM",params:[{type:"address",description:"The token to fetch from Permit2",name:"token"},{type:"address",description:"The recipient of the tokens fetched",name:"recipient"},{type:"uint256",description:"The amount of token to fetch",name:"amount"}]},3:{name:"PERMIT2_PERMIT_BATCH",params:[{type:"bytes",description:"A PermitBatch struct outlining all of the Permit2 permits to execute.",name:"batch"},{type:"bytes",description:"The signature to provide to Permit2",name:"data"}]},4:{name:"SWEEP",params:[{type:"address",description:"The ERC20 token to sweep (or Constants.ETH for ETH)",name:"token"},{type:"address",description:"The recipient of the sweep",name:"recipient"},{type:"uint256",description:"The minimum required tokens to receive from the sweep",name:"amountMin"}]},5:{name:"TRANSFER",params:[{type:"address",description:"The ERC20 token to transfer (or Constants.ETH for ETH)",name:"token"},{type:"address",description:"The recipient of the transfer",name:"recipient"},{type:"uint256",description:"The amount to transfer",name:"value"}]},6:{name:"PAY_PORTION",params:[{type:"address",description:"The ERC20 token to transfer (or Constants.ETH for ETH)",name:"token"},{type:"address",description:"The recipient of the transfer",name:"recipient"},{type:"uint256",description:"In basis points, the percentage of the contracts balance to transfer",name:"bips"}]},8:{name:"V2_SWAP_EXACT_IN",params:[{type:"address",description:"The recipient of the output of the trade",name:"recipient"},{type:"uint256",description:"The amount of input tokens for the trade",name:"amountIn"},{type:"uint256",description:"The minimum amount of output tokens the user wants",name:"amountOutMin"},{type:"address[]",description:"The UniswapV2 token path to trade along",name:"path"},{type:"bool",description:"A flag for whether the input tokens should come from the msg.sender (through Permit2) or whether the funds are already in the UniversalRouter",name:"payerIsUser"}]},9:{name:"V2_SWAP_EXACT_OUT",params:[{type:"address",description:"The recipient of the output of the trade",name:"recipient"},{type:"uint256",description:"The amount of output tokens to receive",name:"amountOut"},{type:"uint256",description:"The maximum number of input tokens that should be spent",name:"amountInMax"},{type:"address[]",description:"The UniswapV2 token path to trade along",name:"path"},{type:"bool",description:"A flag for whether the input tokens should come from the msg.sender (through Permit2) or whether the funds are already in the UniversalRouter",name:"payerIsUser"}]},10:{name:"PERMIT2_PERMIT",params:[{type:"bytes",description:"A PermitSingle struct outlining the Permit2 permit to execute",name:"permitSingle"},{type:"bytes",description:"The signature to provide to Permit2",name:"signature"}]},11:{name:"WRAP_ETH",params:[{type:"address",description:"The recipient of the WETH",name:"recipient"},{type:"uint256",description:"The amount of ETH to wrap",name:"amountMin"}]},12:{name:"UNWRAP_WETH",params:[{type:"address",description:"The recipient of the ETH",name:"recipient"},{type:"uint256",description:"The minimum required ETH to receive from the unwrapping",name:"amountMin"}]},13:{name:"PERMIT2_TRANSFER_FROM_BATCH",params:[{type:"bytes",description:"An array of AllowanceTransferDetails structs that each describe a Permit2 transfer to perform",name:"batchDetails"}]},16:{name:"SEAPORT",params:[{type:"uint256",description:"The ETH value to forward to the Seaport contract",name:"value"},{type:"bytes",description:"The calldata to use to call the Seaport contract",name:"data"}]},17:{name:"LOOKS_RARE_721",params:[{type:"uint256",description:"The ETH value to forward to the LooksRare contract",name:"value"},{type:"bytes",description:"The calldata to use to call the LooksRare contract",name:"data"},{type:"address",description:"The recipient of the ERC721",name:"recipient"},{type:"address",description:"The ERC721 token address",name:"token"},{type:"uint256",description:"The ID of the ERC721",name:"id"}]},18:{name:"NFTX",params:[{type:"uint256",description:"The ETH value to forward to the NFTX contract",name:"value"},{type:"bytes",description:"The calldata to use to call the NFTX contract",name:"data"}]},19:{name:"CRYPTOPUNKS",params:[{type:"uint256",description:"The PunkID to purchase",name:"punkId"},{type:"address",description:"The recipient for the cryptopunk",name:"recipient"},{type:"uint256",description:"The ETH value to forward to the Cryptopunks contract",name:"value"}]},20:{name:"LOOKS_RARE_1155",params:[{type:"uint256",description:"The ETH value to forward to the LooksRare contract",name:"value"},{type:"bytes",description:"The calldata to use to call the LooksRare contract",name:"data"},{type:"address",description:"The recipient of the ERC1155",name:"recipient"},{type:"address",description:"The ERC1155 token address",name:"token"},{type:"uint256",description:"The ID of the ERC1155",name:"id"},{type:"uint256",description:"The amount of the ERC1155 to transfer",name:"amount"}]},21:{name:"OWNER_CHECK_721",params:[{type:"address",description:"The required owner of the ERC721",name:"owner"},{type:"address",description:"The ERC721 token address",name:"token"},{type:"uint256",description:"The ID of the ERC721",name:"id"}]},22:{name:"OWNER_CHECK_1155",params:[{type:"address",description:"The required owner of the ERC1155",name:"owner"},{type:"address",description:"The ERC721 token address",name:"token"},{type:"uint256",description:"The ID of the ERC1155",name:"id"},{type:"uint256",description:"The minimum required amount of the ERC1155",name:"minBalance"}]},23:{name:"SWEEP_ERC721",params:[{type:"address",description:"The ERC721 token address to transfer",name:"token"},{type:"address",description:"The recipient of the transfer",name:"recipient"},{type:"uint256",description:"The token ID to transfer",name:"id"}]},24:{name:"X2Y2_721",params:[{type:"uint256",description:"The ETH value to forward to the X2Y2 contract",name:"value"},{type:"bytes",description:"The calldata to use to call the X2Y2 contract",name:"data"},{type:"address",description:"The recipient of the ERC721",name:"recipient"},{type:"address",description:"The ERC721 token address",name:"token"},{type:"uint256",description:"The ID of the ERC721",name:"id"}]},25:{name:"SUDOSWAP",params:[{type:"uint256",description:"The ETH value to forward to the Sudoswap contract",name:"value"},{type:"bytes",description:"The calldata to use to call the Sudoswap contract",name:"data"}]},26:{name:"NFT20",params:[{type:"uint256",description:"The ETH value to forward to the NFT20 contract",name:"value"},{type:"bytes",description:"The calldata to use to call the NFT20 contract",name:"data"}]},27:{name:"X2Y2_1155",params:[{type:"uint256",description:"The ETH value to forward to the X2Y2 contract",name:"value"},{type:"bytes",description:"The calldata to use to call the X2Y2 contract",name:"data"},{type:"address",description:"The recipient of the ERC1155",name:"recipient"},{type:"address",description:"The ERC1155 token address",name:"token"},{type:"uint256",description:"The ID of the ERC1155",name:"id"},{type:"uint256",description:"The amount of the ERC1155 to transfer",name:"amount"}]},28:{name:"FOUNDATION",params:[{type:"uint256",description:"The ETH value to forward to the Foundation contract",name:"value"},{type:"bytes",description:"The calldata to use to call the Foundation contract",name:"data"},{type:"address",description:"The recipient of the ERC721",name:"recipient"},{type:"address",description:"The ERC721 token address",name:"token"},{type:"uint256",description:"The ID of the ERC721",name:"id"}]},29:{name:"SWEEP_ERC1155",params:[{type:"address",description:"The ERC1155 token address to sweep",name:"token"},{type:"address",description:"The recipient of the sweep",name:"recipient"},{type:"uint256",description:"The token ID to sweep",name:"id"},{type:"uint256",description:"The minimum required tokens to receive from the sweep",name:"amount"}]}}}}},{package:"$root$",file:"app/scripts/lib/transaction/decode/uniswap-commands.ts"}],[366,{"../../../../../shared/constants/network":6194,"../../../../../shared/modules/decoding":6318,"./uniswap-commands":365,"@ethersproject/abi":763},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.UNISWAP_UNIVERSAL_ROUTER_ADDRESSES=void 0,r.decodeUniswapRouterTransactionData=function({transactionData:e,contractAddress:t,chainId:r}){const o=a[r];if(null==o||!o.map(e=>e.toLowerCase()).includes(t.toLowerCase()))return undefined;const c=new n.Interface(l);let d;try{d=c.parseTransaction({data:e})}catch(e){return undefined}const u=d.args.commands,p=d.args.inputs;return u.slice(2).match(/.{1,2}/gu).map((e,t)=>function(e,t){const r=parseInt(e,16),o=31&r,a=s.UNISWAP_ROUTER_COMMANDS[String(o)];if(!a)return undefined;const l=a.params.map(e=>e.type),c=n.Interface.getAbiCoder().decode(l,t),{name:d}=a,u=a.params.map((e,t)=>{const{name:r,type:n,description:o}=e,s=c[t];return{name:r,type:n,value:"path"===r?(0,i.decodeCommandV3Path)(s):s,description:o}});return{name:d,params:u}}(e,p[t])).filter(e=>e!==undefined)};var n=e("@ethersproject/abi"),i=e("../../../../../shared/modules/decoding"),o=e("../../../../../shared/constants/network"),s=e("./uniswap-commands");const a=r.UNISWAP_UNIVERSAL_ROUTER_ADDRESSES={[o.CHAIN_IDS.ARBITRUM]:["0x4C60051384bd2d3C01bfc845Cf5F4b44bcbE9de5","0xeC8B0F7Ffe3ae75d7FfAb09429e3675bb63503e4","0x5E325eDA8064b456f4781070C0738d849c824258"],[o.CHAIN_IDS.AVALANCHE]:["0x82635AF6146972cD6601161c4472ffe97237D292","0x4Dae2f939ACf50408e13d58534Ff8c2776d45265"],[o.CHAIN_IDS.BASE]:["0xeC8B0F7Ffe3ae75d7FfAb09429e3675bb63503e4","0x3fC91A3afd70395Cd496C647d5a6CC9D4B2b7FAD"],[o.CHAIN_IDS.BSC]:["0x5Dc88340E1c5c6366864Ee415d6034cadd1A9897","0xeC8B0F7Ffe3ae75d7FfAb09429e3675bb63503e4","0x4Dae2f939ACf50408e13d58534Ff8c2776d45265"],[o.CHAIN_IDS.MAINNET]:["0xEf1c6E67703c7BD7107eed8303Fbe6EC2554BF6B","0x3fC91A3afd70395Cd496C647d5a6CC9D4B2b7FAD"],[o.CHAIN_IDS.OPTIMISM]:["0xb555edF5dcF85f42cEeF1f3630a52A108E55A654","0xeC8B0F7Ffe3ae75d7FfAb09429e3675bb63503e4","0xCb1355ff08Ab38bBCE60111F1bb2B784bE25D7e8"],[o.CHAIN_IDS.POLYGON]:["0x4C60051384bd2d3C01bfc845Cf5F4b44bcbE9de5","0x643770E279d5D0733F21d6DC03A8efbABf3255B4","0xec7BE89e9d109e7e3Fec59c222CF297125FEFda2"],[o.CHAIN_IDS.SEPOLIA]:["0x3fC91A3afd70395Cd496C647d5a6CC9D4B2b7FAD"]},l=[{constant:!0,inputs:[{name:"commands",type:"bytes"},{name:"inputs",type:"bytes[]"},{name:"deadline",type:"uint256"}],name:"execute",type:"function"},{constant:!0,inputs:[{name:"commands",type:"bytes"},{name:"inputs",type:"bytes[]"}],name:"execute",type:"function"}]}}},{package:"$root$",file:"app/scripts/lib/transaction/decode/uniswap.ts"}],[367,{"../../../../../shared/types/transaction-decode":6352,"./four-byte":362,"./proxy":363,"./sourcify":364,"./uniswap":366,"@metamask/utils":3554},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.decodeTransactionData=async function({transactionData:e,contractAddress:t,chainId:r,provider:n}){c("Decoding transaction data",{transactionData:e,contractAddress:t,chainId:r});const u=(0,o.decodeUniswapRouterTransactionData)({transactionData:e,contractAddress:t,chainId:r});if(u)return c("Decoded with Uniswap commands",u),{data:d(u),source:i.DecodedTransactionDataSource.Uniswap};const p=await(0,a.getContractProxyAddress)(t,n);p&&c("Retrieved proxy implementation address",p);const h=p??t,m=(0,s.decodeTransactionDataWithSourcify)(e,h,r),g=(0,l.decodeTransactionDataWithFourByte)(e),[f,y]=await Promise.allSettled([m,g]);if("fulfilled"===f.status&&f.value)return c("Decoded data with Sourcify",f.value),{data:d([f.value]),source:i.DecodedTransactionDataSource.Sourcify};if(c("Failed to decode data with Sourcify",f),"fulfilled"===y.status&&y.value)return c("Decoded data with 4Byte",y.value),{data:d([y.value]),source:i.DecodedTransactionDataSource.FourByte};return c("Failed to decode data with 4Byte",y),undefined};var n=e("@metamask/utils"),i=e("../../../../../shared/types/transaction-decode"),o=e("./uniswap"),s=e("./sourcify"),a=e("./proxy"),l=e("./four-byte");const c=(0,n.createProjectLogger)("transaction-decode");function d(e){return e.map(e=>function(e){return{...e,params:e.params.map(e=>u(e))}}(e))}function u(e){var t;return{...e,value:p(e.value),children:null===(t=e.children)||void 0===t?void 0:t.map(e=>u(e))}}function p(e){const t=e._hex;return t?BigInt(t).toString():e}}}},{package:"$root$",file:"app/scripts/lib/transaction/decode/util.ts"}],[3670,{"@metamask/eth-sig-util":2228,tslib:6089},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.transformTypedData=void 0;const n=e("tslib").__importStar(e("@metamask/eth-sig-util"));function i(e){switch(Object.prototype.toString.call(e)){case"[object Object]":{const t=Object.keys(e).map(t=>[t,i(e[t])]);return Object.fromEntries(t)}case"[object Array]":return e.map(e=>i(e));case"[object BigInt]":return e.toString();default:return e}}r.transformTypedData=(e,t)=>{if(!t)throw new Error("Trezor: Only version 4 of typed data signing is supported");const r=n.SignTypedDataVersion.V4,{types:o,primaryType:s,domain:a,message:l}=n.TypedDataUtils.sanitizeData(e),c=n.TypedDataUtils.hashStruct("EIP712Domain",i(a),o,r).toString("hex");let d=null;return"EIP712Domain"!==s&&(d=n.TypedDataUtils.hashStruct(s,i(l),o,r).toString("hex")),Object.assign({domain_separator_hash:c,message_hash:d},e)},r.default=r.transformTypedData}}},{package:"@metamask/eth-trezor-keyring>@trezor/connect-plugin-ethereum",file:"node_modules/@trezor/connect-plugin-ethereum/lib/index.js"}],[368,{"@ethersproject/abi":763,"@metamask/keyring-controller":2537,"@metamask/utils":3554},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.ROOT_AUTHORITY=r.PRIMARY_TYPE_DELEGATION=r.ExecutionMode=r.ANY_BENEFICIARY=void 0,r.encodeRedeemDelegations=function(e,t,r){return new o.Interface(d).encodeFunctionData("redeemDelegations",[p(e),t,(n=r,n.map(h))]);var n},r.signDelegation=async function({chainId:e,delegation:t,from:r,messenger:o}){const l={types:u,primaryType:s,domain:{chainId:String((0,n.hexToNumber)(e)),name:a,version:"1",verifyingContract:"0xdb9B1e94B5b69Df7e401DDbedE43491141047dB3"},message:{...t,chainId:(0,n.hexToNumber)(e)}};return await o.call("KeyringController:signTypedMessage",{from:r,data:l},i.SignTypedDataVersion.V4)};var n=e("@metamask/utils"),i=e("@metamask/keyring-controller"),o=e("@ethersproject/abi");r.ExecutionMode=function(e){return e.BATCH_DEFAULT_MODE="0x0100000000000000000000000000000000000000000000000000000000000000",e}({});r.ROOT_AUTHORITY="0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff",r.ANY_BENEFICIARY="0x0000000000000000000000000000000000000a11";const s=r.PRIMARY_TYPE_DELEGATION="Delegation",a="DelegationManager",l=[{type:"address",name:"delegate"},{type:"address",name:"delegator"},{type:"bytes32",name:"authority"},{type:"tuple[]",name:"caveats",components:[{type:"address",name:"enforcer"},{type:"bytes",name:"terms"},{type:"bytes",name:"args"}]},{type:"uint256",name:"salt"},{type:"bytes",name:"signature"}],c=[{type:"address",name:"target"},{type:"uint256",name:"value"},{type:"bytes",name:"callData"}],d=[{type:"function",name:"redeemDelegations",inputs:[{name:"_permissionContexts",type:"bytes[]",internalType:"bytes[]"},{name:"_modes",type:"bytes32[]",internalType:"ModeCode[]"},{name:"_executionCallDatas",type:"bytes[]",internalType:"bytes[]"}],outputs:[],stateMutability:"nonpayable"}],u={EIP712Domain:[{name:"name",type:"string"},{name:"version",type:"string"},{name:"chainId",type:"uint256"},{name:"verifyingContract",type:"address"}],Caveat:[{name:"enforcer",type:"address"},{name:"terms",type:"bytes"}],Delegation:[{name:"delegate",type:"address"},{name:"delegator",type:"address"},{name:"authority",type:"bytes32"},{name:"caveats",type:"Caveat[]"},{name:"salt",type:"uint256"}]};function p(e){return e.map(e=>{return t=e,o.defaultAbiCoder.encode([o.ParamType.from({components:l,name:"delegations",type:"tuple[]"})],[t]);var t})}function h(e){return o.defaultAbiCoder.encode([o.ParamType.from({components:c,name:"executions",type:"tuple[]"})],[e])}}}},{package:"$root$",file:"app/scripts/lib/transaction/delegation.ts"}],[369,{"../../../../../shared/lib/delegation":6266,"../../../../../shared/lib/delegation/caveatBuilder/exactExecutionBuilder":6257,"../../../../../shared/lib/delegation/caveatBuilder/limitedCallsBuilder":6259,"../../../../../shared/lib/delegation/caveatBuilder/specificActionERC20TransferBatchBuilder":6262,"../../../../../shared/lib/delegation/delegation":6263,"../../../../../shared/lib/eip7702-support-utils":6268,"../../smart-transaction/utils":341,"../transaction-relay":373,"../util":374,"@ethersproject/abi":763,"@metamask/controller-utils":1639,"@metamask/metamask-eth-abis":2597,"@metamask/utils":3554},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.Delegation7702PublishHook=void 0;var n=e("@ethersproject/abi"),i=e("@metamask/metamask-eth-abis"),o=e("@metamask/utils"),s=e("@metamask/controller-utils"),a=e("../../../../../shared/lib/delegation"),l=e("../../../../../shared/lib/eip7702-support-utils"),c=e("../../../../../shared/lib/delegation/caveatBuilder/exactExecutionBuilder"),d=e("../../../../../shared/lib/delegation/caveatBuilder/limitedCallsBuilder"),u=e("../../../../../shared/lib/delegation/caveatBuilder/specificActionERC20TransferBatchBuilder"),p=e("../../../../../shared/lib/delegation/delegation"),h=e("../transaction-relay"),m=e("../util"),g=e("../../smart-transaction/utils");function f(e,t,r){y(e,t),t.set(e,r)}function y(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function C(e,t){return e.get(v(e,t))}function b(e,t,r){return e.set(v(e,t),r),r}function v(e,t,r){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:r;throw new TypeError("Private element is not present on this object")}const w={transactionHash:undefined},S=(0,o.createProjectLogger)("delegation-7702-publish-hook");var T=new WeakMap,k=new WeakMap,A=new WeakMap,M=new WeakSet;async function P(e,t){try{return await v(M,this,E).call(this,e,t)}catch(e){throw S("Error",e),e}}async function E(e,t){const{chainId:r,gasFeeTokens:n,selectedGasFeeToken:i,txParams:o}=e,{from:s}=o,c=await C(T,this).call(this,{address:s,chainIds:[r]}),d=(0,l.findAtomicBatchSupportForChain)(c,r),{isSupported:u,delegationAddress:m,upgradeContractAddress:f}=(0,l.checkEip7702Support)(d);if(!u)return S("Skipping as EIP-7702 is not supported",{from:s,chainId:r}),w;const y=e.isGasFeeIncluded,b=Boolean(e.isGasFeeSponsored);if(!(i&&null!=n&&n.length||y||b))return S("Skipping as no selected gas fee token"),w;const A=y||b?undefined:null==n?void 0:n.find(e=>e.tokenAddress.toLowerCase()===(null==i?void 0:i.toLowerCase()));if(!A&&!y&&!b)throw new Error("Selected gas fee token not found");const P=(0,a.getDeleGatorEnvironment)(parseInt(e.chainId,16)),E=P.DelegationManager,O=!y&&!e.isGasFeeSponsored;if(O&&(!A||A===undefined))throw new Error("Gas fee token not found");const{nonce:R,...D}=e.txParams,F={...e,txParams:D};e.txParams.nonce!==undefined&&await C(k,this).call("TransactionController:updateTransaction",F,"Remove nonce for EIP-7702 delegation transaction");const x=await v(M,this,I).call(this,P,F,A,O),j=[O?a.BATCH_DEFAULT_MODE:a.SINGLE_DEFAULT_MODE],B=v(M,this,_).call(this,F,A,O),U={chainId:r,data:(0,p.encodeRedeemDelegations)({delegations:x,modes:j,executions:B}),to:E,metadata:{txType:e.type,client:(0,g.getClientForTransactionMetadata)(),origin:(0,g.sanitizeOrigin)(e.origin)}};m||(U.authorizationList=await v(M,this,N).call(this,F,f??undefined)),S("Relay request",U);const{uuid:L}=await(0,h.submitRelayTransaction)(U),{transactionHash:G,status:K}=await(0,h.waitForRelayResult)({chainId:r,uuid:L,interval:1e3});if(K!==h.RelayStatus.Success)throw new Error(`Transaction relay error - ${K}`);return{transactionHash:G}}async function I(e,t,r,n){const i=v(M,this,O).call(this,e,t,r,n);S("Signing delegation");const o=await C(k,this).call("DelegationController:signDelegation",{chainId:t.chainId,delegation:i});S("Delegation signature",o);return[[{...i,signature:o}]]}function _(e,t,r){const{txParams:n}=e,{data:i,to:o,value:s}=n,a=v(M,this,x).call(this,i),l={target:o,value:BigInt(s??"0x0"),callData:a};if(!r)return[[l]];if(!t)throw new Error("Selected gas fee token not found");return[[l,{target:t.tokenAddress,value:BigInt("0x0"),callData:v(M,this,D).call(this,t.recipient,t.amount)}]]}function O(e,t,r,n){const i=v(M,this,R).call(this,e,t,r,n);S("Caveats",i);const o=(0,a.createDelegation)({from:t.txParams.from,to:p.ANY_BENEFICIARY,caveats:i});return S("Delegation",o),o}function R(e,t,r,n){const i=(0,a.createCaveatBuilder)(e),{txParams:o}=t,{to:s,value:l,data:p}=o,h=v(M,this,x).call(this,p);if(n&&r!==undefined){const{tokenAddress:e,recipient:t,amount:n}=r;s!==undefined&&i.addCaveat(u.specificActionERC20TransferBatch,e,t,n,s,l??"0x0",h)}else s!==undefined&&i.addCaveat(c.exactExecution,s,l??"0x0",h);return i.addCaveat(d.limitedCalls,1),i.build()}async function N(e,t){const{chainId:r,txParams:n,networkClientId:i}=e,{from:o,nonce:s}=n,a=await C(A,this).call(this,o,i),l=s??a;if(S("Including authorization as not upgraded"),!t)throw new Error("Upgrade contract address not found");const c=await C(k,this).call("KeyringController:signEip7702Authorization",{chainId:parseInt(r,16),contractAddress:t,from:o,nonce:parseInt(l,16)}),{r:d,s:u,yParity:p}=v(M,this,F).call(this,c);return S("Authorization signature",{authorizationSignature:c,r:d,s:u,yParity:p}),[{address:t,chainId:r,nonce:l,r:d,s:u,yParity:p}]}function D(e,t){return new n.Interface(i.abiERC20).encodeFunctionData("transfer",[e,t])}function F(e){const t=(0,m.stripSingleLeadingZero)(e.slice(0,66)),r=(0,m.stripSingleLeadingZero)((0,o.add0x)(e.slice(66,130))),n=parseInt(e.slice(130,132),16);return{r:t,s:r,yParity:(0,s.toHex)(n-27==0?0:1)}}function x(e){if("string"!=typeof e||0===e.length)return"0x";const t="0x"===e.slice(0,2).toLowerCase(),r=e.toLowerCase(),n=t?`0x${r.slice(2)}`:`0x${r}`,i=n.slice(2);return 0===i.length?"0x":i.length%2!=0?v(M,this,x).call(this,`0x0${i}`):n}r.Delegation7702PublishHook=class{constructor({isAtomicBatchSupported:e,messenger:t,getNextNonce:r}){var n,i;y(n=this,i=M),i.add(n),f(this,T,void 0),f(this,k,void 0),f(this,A,void 0),b(T,this,e),b(k,this,t),b(A,this,r)}getHook(){return v(M,this,P).bind(this)}}}}},{package:"$root$",file:"app/scripts/lib/transaction/hooks/delegation-7702-publish.ts"}],[37,{"../../controllers/decrypt-message":230},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.DecryptMessageControllerInit=void 0;var n,i=(n=e("../../controllers/decrypt-message"))&&n.__esModule?n:{default:n};r.DecryptMessageControllerInit=({controllerMessenger:e,initMessenger:t,getController:r,getUIState:n})=>{const o=r("DecryptMessageManager");return{persistedStateKey:null,memStateKey:null,controller:new i.default({messenger:e,manager:o,getState:n,metricsEvent:t.call.bind(t,"MetaMetricsController:trackEvent")})}}}}},{package:"$root$",file:"app/scripts/controller-init/confirmations/decrypt-message-controller-init.ts"}],[370,{"../containers/util":361,"@metamask/controller-utils":1639,"@metamask/transaction-controller":3473,"@metamask/utils":3554},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.EnforceSimulationHook=void 0;e("@metamask/transaction-controller");var n=e("@metamask/utils");e("@metamask/controller-utils"),e("../containers/util");function i(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function o(e,t){return e.get(s(e,t))}function s(e,t,r){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:r;throw new TypeError("Private element is not present on this object")}const a=(0,n.createProjectLogger)("enforce-simulation-hook");var l=new WeakMap,c=new WeakSet;async function d(e,t){const{transactionMeta:r}=t,{isFinal:n}=e,{containerTypes:i,delegationAddress:s,id:c,origin:d,simulationData:u,txParamsOriginal:p}=r,h=o(l,this).call("AppStateController:getState");(null==h?void 0:h.enableEnforcedSimulationsForTransactions[c])??(null==h||h.enableEnforcedSimulations);return a("Skipping as enforced simulations are disabled"),{skipSimulation:!1}}r.EnforceSimulationHook=class{constructor({messenger:e}){var t,r;i(t=this,r=c),r.add(t),function(e,t,r){i(e,t),t.set(e,r)}(this,l,void 0),function(e,t,r){e.set(s(e,t),r)}(l,this,e)}getAfterSimulateHook(){return s(c,this,d).bind(this,{})}getBeforeSignHook(){return s(c,this,d).bind(this,{isFinal:!0})}}}}},{package:"$root$",file:"app/scripts/lib/transaction/hooks/enforce-simulation-hook.ts"}],[371,{"../../../../shared/constants/app":6175,"../../../../shared/constants/gas":6183,"../../../../shared/constants/metametrics":6190,"../../../../shared/constants/transaction":6213,"../../../../shared/lib/transactions-controller-utils":6301,"../../../../shared/lib/trust-signals":6305,"../../../../shared/modules/Numeric":6308,"../../../../shared/modules/conversion.utils":6315,"../../../../shared/modules/gas.utils":6323,"../../../../shared/modules/metametrics":6326,"../../../../shared/modules/transaction.utils":6348,"../../../../ui/helpers/utils/metrics":7497,"../snap-keyring/metrics":344,"../util":380,"@metamask/transaction-controller":3473,"@metamask/utils":3554,"bignumber.js":4362,"ethereumjs-util":4728},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.handleTransactionSubmitted=r.handleTransactionRejected=r.handleTransactionFailed=r.handleTransactionDropped=r.handleTransactionConfirmed=r.handleTransactionApproved=r.handleTransactionAdded=r.handlePostTransactionBalanceUpdate=r.createTransactionEventFragmentWithTxId=r.METRICS_STATUS_FAILED=void 0;var n=e("bignumber.js"),i=e("ethereumjs-util"),o=e("@metamask/transaction-controller"),s=e("@metamask/utils"),a=e("../../../../shared/constants/app"),l=e("../../../../shared/constants/gas"),c=e("../../../../shared/constants/metametrics"),d=e("../../../../shared/constants/transaction"),u=e("../../../../shared/lib/transactions-controller-utils"),p=e("../../../../shared/modules/conversion.utils"),h=e("../../../../shared/modules/metametrics"),m=e("../../../../shared/modules/transaction.utils"),g=e("../../../../ui/helpers/utils/metrics"),f=e("../snap-keyring/metrics"),y=e("../../../../shared/modules/gas.utils"),C=e("../../../../shared/modules/Numeric"),b=e("../util"),v=e("../../../../shared/lib/trust-signals");const w=(0,s.createProjectLogger)("transaction-metrics"),S=r.METRICS_STATUS_FAILED="failed on-chain",T=[o.TransactionType.bridge,o.TransactionType.bridgeApproval,o.TransactionType.contractInteraction,o.TransactionType.tokenMethodApprove,o.TransactionType.tokenMethodIncreaseAllowance,o.TransactionType.tokenMethodSafeTransferFrom,o.TransactionType.tokenMethodSetApprovalForAll,o.TransactionType.tokenMethodTransfer,o.TransactionType.tokenMethodTransferFrom,o.TransactionType.swap,o.TransactionType.swapAndSend,o.TransactionType.swapApproval];var k=function(e){return e.swap="mm_swap",e.bridge="mm_bridge",e}(k||{});r.handleTransactionAdded=async(e,t)=>{if(!t.transactionMeta)return;const{properties:r,sensitiveProperties:n}=await E({transactionEventPayload:t,transactionMetricsRequest:e});A({eventName:d.TransactionMetaMetricsEvent.added,transactionEventPayload:t,transactionMetricsRequest:e,payload:{properties:r,sensitiveProperties:n}})};r.handleTransactionApproved=async(e,t)=>{t.transactionMeta&&await M({eventName:d.TransactionMetaMetricsEvent.approved,transactionEventPayload:t,transactionMetricsRequest:e})};r.handleTransactionFailed=async(e,t)=>{if(!t.transactionMeta)return;const r={};t.error&&(r.error=t.error),await M({eventName:d.TransactionMetaMetricsEvent.finalized,extraParams:r,transactionEventPayload:t,transactionMetricsRequest:e})};r.handleTransactionConfirmed=async(e,t)=>{if(0===Object.keys(t).length)return;const r={},n={...t},{txReceipt:i}=n;r.gas_used=null==i?void 0:i.gasUsed,r.block_number=(null==i?void 0:i.blockNumber)&&(0,p.hexToDecimal)(i.blockNumber);const{submittedTime:o,blockTimestamp:s}=n;o&&(r.completion_time=function(e){return Math.round((Date.now()-e)/1e3).toString()}(o)),o&&s&&(r.completion_time_onchain=function(e,t){const r=2,n=Number((0,p.hexToDecimal)(t))-e/1e3;return(Math.round(n*10**r)/10**r).toString()}(o,s)),"0x0"===(null==i?void 0:i.status)&&(r.status=S),await M({eventName:d.TransactionMetaMetricsEvent.finalized,extraParams:r,transactionEventPayload:{actionId:n.actionId,transactionMeta:n},transactionMetricsRequest:e})};r.handleTransactionDropped=async(e,t)=>{if(!t.transactionMeta)return;await M({eventName:d.TransactionMetaMetricsEvent.finalized,extraParams:{dropped:!0},transactionEventPayload:t,transactionMetricsRequest:e})};r.handleTransactionRejected=async(e,t)=>{t.transactionMeta&&await M({eventName:d.TransactionMetaMetricsEvent.rejected,transactionEventPayload:t,transactionMetricsRequest:e})};r.handleTransactionSubmitted=async(e,t)=>{if(!t.transactionMeta)return;const{properties:r,sensitiveProperties:n}=await E({transactionEventPayload:t,transactionMetricsRequest:e});A({eventName:d.TransactionMetaMetricsEvent.submitted,transactionEventPayload:t,transactionMetricsRequest:e,payload:{properties:r,sensitiveProperties:n}})};r.createTransactionEventFragmentWithTxId=async(e,{transactionId:t,actionId:r})=>{const n={...e.getTransaction(t),actionId:r},{properties:i,sensitiveProperties:o}=await E({transactionEventPayload:{transactionMeta:n},transactionMetricsRequest:e});A({eventName:d.TransactionMetaMetricsEvent.approved,transactionEventPayload:{actionId:n.actionId,transactionMeta:n},transactionMetricsRequest:e,payload:{properties:i,sensitiveProperties:o}})};function A({eventName:e,transactionEventPayload:{transactionMeta:t,actionId:r},transactionMetricsRequest:n,payload:i}){if(function(e,t,r){const n=P(t,r.id);return void 0!==e(n)}(n.getEventFragmentById,e,t)&&e!==d.TransactionMetaMetricsEvent.submitted)return;const o=P(e,t.id);switch(e){case d.TransactionMetaMetricsEvent.added:n.createEventFragment({category:c.MetaMetricsEventCategory.Transactions,initialEvent:d.TransactionMetaMetricsEvent.added,successEvent:d.TransactionMetaMetricsEvent.approved,failureEvent:d.TransactionMetaMetricsEvent.rejected,properties:i.properties,sensitiveProperties:i.sensitiveProperties,actionId:r,uniqueIdentifier:o,persist:!0});break;case d.TransactionMetaMetricsEvent.approved:case d.TransactionMetaMetricsEvent.rejected:n.createEventFragment({category:c.MetaMetricsEventCategory.Transactions,successEvent:d.TransactionMetaMetricsEvent.approved,failureEvent:d.TransactionMetaMetricsEvent.rejected,properties:i.properties,sensitiveProperties:i.sensitiveProperties,actionId:r,uniqueIdentifier:o,persist:!0});break;case d.TransactionMetaMetricsEvent.submitted:n.createEventFragment({category:c.MetaMetricsEventCategory.Transactions,initialEvent:d.TransactionMetaMetricsEvent.submitted,successEvent:d.TransactionMetaMetricsEvent.finalized,properties:i.properties,sensitiveProperties:i.sensitiveProperties,actionId:r,uniqueIdentifier:o,persist:!0});break;case d.TransactionMetaMetricsEvent.finalized:n.createEventFragment({category:c.MetaMetricsEventCategory.Transactions,successEvent:d.TransactionMetaMetricsEvent.finalized,properties:i.properties,sensitiveProperties:i.sensitiveProperties,actionId:r,uniqueIdentifier:o,persist:!0})}}async function M({eventName:e,transactionEventPayload:t,transactionMetricsRequest:r,extraParams:n={}}){const{properties:i,sensitiveProperties:o}=await E({transactionEventPayload:t,transactionMetricsRequest:r,extraParams:n});A({eventName:e,transactionEventPayload:t,transactionMetricsRequest:r,payload:{properties:i,sensitiveProperties:o}}),function({eventName:e,transactionEventPayload:{transactionMeta:t},transactionMetricsRequest:r,payload:n}){const i=P(e,t.id);switch(e){case d.TransactionMetaMetricsEvent.approved:case d.TransactionMetaMetricsEvent.rejected:case d.TransactionMetaMetricsEvent.finalized:r.updateEventFragment(i,{properties:n.properties,sensitiveProperties:n.sensitiveProperties})}}({eventName:e,transactionEventPayload:t,transactionMetricsRequest:r,payload:{properties:i,sensitiveProperties:o}}),function({eventName:e,transactionMetricsRequest:t,transactionEventPayload:{transactionMeta:r}}){const n=P(e,r.id);switch(e){case d.TransactionMetaMetricsEvent.approved:case d.TransactionMetaMetricsEvent.finalized:t.finalizeEventFragment(n);break;case d.TransactionMetaMetricsEvent.rejected:t.finalizeEventFragment(n,{abandoned:!0})}}({eventName:e,transactionEventPayload:t,transactionMetricsRequest:r})}function P(e,t){return`transaction-${e===d.TransactionMetaMetricsEvent.finalized||e===d.TransactionMetaMetricsEvent.submitted?"submitted":"added"}-${t}`}async function E({transactionEventPayload:{transactionMeta:e},transactionMetricsRequest:t,extraParams:r={}}){var S;const{type:k,time:A,status:M,chainId:P,origin:E,txParams:{gasPrice:_,gas:O,maxFeePerGas:R,maxPriorityFeePerGas:N,estimateSuggested:D,estimateUsed:F},defaultGasEstimates:x,originalType:j,replacedById:B,customTokenAmount:U,dappProposedTokenAmount:L,currentTokenBalance:G,originalApprovalAmount:K,finalApprovalAmount:$,securityProviderResponse:q,simulationFails:H,id:W,userFeeLevel:V}=e,Y=E===a.ORIGIN_METAMASK?"user":"dapp",z="dappSuggested"===V?"dapp_proposed":V,{assetType:X,tokenStandard:J}=await(0,m.determineTransactionAssetType)(e,t.provider,t.getTokenStandardAndDetails);let Q;if(e.txParams.data){const r=await t.getMethodData(e.txParams.data);Q=null==r?void 0:r.name}const Z={};if((0,m.isEIP1559Transaction)(e)?(Z.max_fee_per_gas=R,Z.max_priority_fee_per_gas=N):(Z.gas_price=_,Z.default_estimate=c.MetaMetricsEventTransactionEstimateType.DefaultEstimate),x){var ee,te;const{estimateType:r}=x;if(r){var re,ne;Z.default_estimate=r===l.PriorityLevels.dAppSuggested?c.MetaMetricsEventTransactionEstimateType.DappProposed:r;let n=null===(re=e.defaultGasEstimates)||void 0===re?void 0:re.maxFeePerGas,i=null===(ne=e.defaultGasEstimates)||void 0===ne?void 0:ne.maxPriorityFeePerGas;if([l.GasRecommendations.low,l.GasRecommendations.medium,l.GasRecommendations.high].includes(r)){var ie,oe;const{gasFeeEstimates:e}=await t.getEIP1559GasFeeEstimates();var se,ae;if(null!=e&&null!==(ie=e[r])&&void 0!==ie&&ie.suggestedMaxFeePerGas)n=null===(se=e[r])||void 0===se?void 0:se.suggestedMaxFeePerGas,Z.default_max_fee_per_gas=n;if(null!=e&&null!==(oe=e[r])&&void 0!==oe&&oe.suggestedMaxPriorityFeePerGas)i=null===(ae=e[r])||void 0===ae?void 0:ae.suggestedMaxPriorityFeePerGas,Z.default_max_priority_fee_per_gas=i}}null!==(ee=e.defaultGasEstimates)&&void 0!==ee&&ee.gas&&(Z.default_gas=e.defaultGasEstimates.gas),null!==(te=e.defaultGasEstimates)&&void 0!==te&&te.gasPrice&&(Z.default_gas_price=e.defaultGasEstimates.gasPrice)}D&&(Z.estimate_suggested=D),F&&(Z.estimate_used=F),null!=r&&r.gas_used&&(Z.gas_used=r.gas_used);const le=function(e){const t={};for(const r in e)(0,i.isHexString)(e[r])?t[r]=(0,p.hexWEIToDecGWEI)(e[r]):t[r]=e[r];return t}(Z);let ce="0";e.txParams.maxFeePerGas&&(ce="2");const de="Approve";let ue,pe,he,me,ge,fe;const{transactionType:ye,isContractInteraction:Ce}=function(e,t){const r=e&&T.includes(e);if([o.TransactionType.swapAndSend,o.TransactionType.cancel,o.TransactionType.deployContract,o.TransactionType.gasPayment,o.TransactionType.batch,o.TransactionType.shieldSubscriptionApprove].includes(e))return{transactionType:e,isContractInteraction:r};if(e===o.TransactionType.retry&&t)return{transactionType:t,isContractInteraction:r};if(r){const t=I(e);return t?{transactionType:t,isContractInteraction:!0}:{transactionType:o.TransactionType.contractInteraction,isContractInteraction:!0}}return{transactionType:o.TransactionType.simpleSend,isContractInteraction:!1}}(k,j);var be,ve;Ce&&(pe=Q,ge=null===(be=e.txParams)||void 0===be?void 0:be.to,fe=null===(ve=e.txParams)||void 0===ve||null===(ve=ve.data)||void 0===ve?void 0:ve.slice(0,10),pe===de&&J===d.TokenStandard.ERC20&&("0"===L||"0"===U?ue=d.TransactionApprovalAmountType.revoke:U&&U!==L?ue=d.TransactionApprovalAmountType.custom:L&&(ue=d.TransactionApprovalAmountType.dappProposed),he=function(e,t,r){if(e===d.TransactionApprovalAmountType.custom&&t&&r)return`${new n.BigNumber(t,10).div(r,10).times(100).round(2)}`;return null}(ue,K,$),me=function(e,t,r){if((e===d.TransactionApprovalAmountType.custom||e===d.TransactionApprovalAmountType.dappProposed)&&t&&r)return`${new n.BigNumber(t,16).div(r,10).times(100).round(2)}`;return null}(ue,L,G)));const we=t.getTransaction(B),Se={RETRY:o.TransactionType.retry,CANCEL:o.TransactionType.cancel,SAME_NONCE:"other"};let Te;null!=r&&r.dropped&&(Te=Se.SAME_NONCE,(null==we?void 0:we.type)===o.TransactionType.cancel?Te=Se.CANCEL:(null==we?void 0:we.type)===o.TransactionType.retry&&(Te=Se.RETRY));const ke=[];1===(null==q?void 0:q.flagAsDangerous)?ke.push(c.MetaMetricsEventUiCustomization.FlaggedAsMalicious):2===(null==q?void 0:q.flagAsDangerous)&&ke.push(c.MetaMetricsEventUiCustomization.FlaggedAsSafetyUnknown);const Ae=(0,g.getBlockaidMetricsProps)(e);(null==Ae||null===(S=Ae.ui_customizations)||void 0===S?void 0:S.length)>0&&ke.push(...Ae.ui_customizations),H&&ke.push(c.MetaMetricsEventUiCustomization.GasEstimationFailed);const Me=t.getIsConfirmationAdvancedDetailsOpen(),Pe=(0,h.getSmartTransactionMetricsProperties)(t,e),Ee=(0,g.getSwapAndSendMetricsProps)(e),Ie={hd_entropy_index:t.getHDEntropyIndex()},_e=function(e,t){const r=t.getSecurityAlertsEnabled();if(!r)return{address_alert_response:"not_applicable"};const{to:n}=e.txParams;if("string"!=typeof n)return{address_alert_response:"not_applicable"};const{chainId:i}=e,o=(0,v.mapChainIdToSupportedEVMChain)(i);if(!o)return{address_alert_response:"not_applicable"};const s=(0,v.createCacheKey)(o,n),a=t.getAddressSecurityAlertResponse(s);if(a)return{address_alert_response:a.result_type};return{address_alert_response:v.ResultType.Loading}}(e,t);let Oe;try{Oe=await t.getAccountType(t.getSelectedAddress())}catch(e){Oe="error",w("Error getting account type for transaction metrics:",e)}let Re={chain_id:P,referrer:E,source:Y,status:M,network:`${parseInt(P,16)}`,eip_1559_version:ce,gas_edit_type:"none",gas_edit_attempted:"none",gas_estimation_failed:Boolean(H),account_type:Oe,device_model:await t.getDeviceModel(t.getSelectedAddress()),asset_type:X,token_standard:J,transaction_type:ye,transaction_speed_up:k===o.TransactionType.retry,transaction_internal_id:W,gas_fee_selected:z,...Ae,ui_customizations:ke.length>0?ke:null,transaction_advanced_view:Me,transaction_contract_method:pe?[pe]:[],...Pe,...Ee,...Ie,..._e};const Ne=await(0,f.getSnapAndHardwareInfoForMetrics)(t.getAccountType,t.getDeviceModel,t.getHardwareTypeForMetric,t.snapAndHardwareMessenger);var De,Fe;(Object.assign(Re,Ne),pe===de||I(k))&&(Re={...Re,simulation_receiving_assets_total_value:Re.simulation_receiving_assets_total_value??(null==e||null===(De=e.assetsFiatValues)||void 0===De?void 0:De.receiving),simulation_sending_assets_total_value:Re.simulation_sending_assets_total_value??(null==e||null===(Fe=e.assetsFiatValues)||void 0===Fe?void 0:Fe.sending),transaction_approval_amount_type:ue});let xe={transaction_envelope_type:(0,m.isEIP1559Transaction)(e)?u.TRANSACTION_ENVELOPE_TYPE_NAMES.FEE_MARKET:u.TRANSACTION_ENVELOPE_TYPE_NAMES.LEGACY,first_seen:A,gas_limit:O,transaction_replaced:Te,transaction_contract_address:ge?[ge]:[],transaction_contract_method_4byte:fe,...r,...le};if(pe===de&&(xe={...xe,transaction_approval_amount_vs_balance_ratio:me,transaction_approval_amount_vs_proposed_ratio:he}),await async function(e,t,r,n){const i=origin&&origin!==a.ORIGIN_METAMASK,{delegationAddress:s,nestedTransactions:l,txParams:c}=e,{authorizationList:u}=c,p=Boolean(null==l?void 0:l.length),h=Boolean(null==u?void 0:u.length);i&&(r.api_method=p?a.MESSAGE_TYPE.WALLET_SEND_CALLS:a.MESSAGE_TYPE.ETH_SEND_TRANSACTION);p&&(r.batch_transaction_count=null==l?void 0:l.length,r.batch_transaction_method="eip7702",r.transaction_contract_method=await async function(e,t){const r=e.filter(e=>T.includes(e.type)&&e.data).map(e=>e.data),n=await Promise.all(r.map(e=>t(e)));return n.map(e=>null==e?void 0:e.name).filter(e=>null==e?void 0:e.length)}(l??[],t),n.transaction_contract_address=null==l?void 0:l.filter(e=>{var t;return T.includes(e.type)&&(null===(t=e.to)||void 0===t?void 0:t.length)}).map(e=>e.to));if(e.status===o.TransactionStatus.rejected){const{error:t}=e;r.eip7702_upgrade_rejection=h&&t.code===d.EIP5792ErrorCode.RejectedUpgrade}r.eip7702_upgrade_transaction=h,n.account_eip7702_upgraded=s}(e,t.getMethodData,Re,xe),function(e,t,r,n){var i;const{gasFeeTokens:o,selectedGasFeeToken:a}=e;t.gas_payment_tokens_available=null==o?void 0:o.map(e=>e.symbol),t.gas_paid_with=null==o||null===(i=o.find(e=>e.tokenAddress.toLowerCase()===(null==a?void 0:a.toLowerCase())))||void 0===i?void 0:i.symbol,(null==a?void 0:a.toLowerCase())===d.NATIVE_TOKEN_ADDRESS&&(t.gas_paid_with="pre-funded_ETH");t.gas_insufficient_native_asset=function(e,t){const{chainId:r,txParams:n}=e,{from:i,gas:o,gasPrice:a,maxFeePerGas:l,value:c}=n,d=t(i,r),u=(0,y.getMaximumGasTotalInHexWei)({gasLimit:o,gasPrice:a,maxFeePerGas:l}),h=(0,s.add0x)((0,p.addHexes)(u,c??"0x0"));return new C.Numeric(h,16).greaterThan(new C.Numeric(d,16))}(e,n)}(e,Re,0,t.getAccountBalance),function(e,t,r){var n;const i=null===(n=r.getFeatureFlags())||void 0===n?void 0:n.extensionUxPna25,s=r.getPna25Acknowledged(),a=r.getParticipateInMetrics(),l=[o.TransactionStatus.confirmed,o.TransactionStatus.dropped,o.TransactionStatus.failed].includes(e.status);i&&s&&a&&l&&(t.transaction_hash=e.hash)}(e,Re,t),M===o.TransactionStatus.submitted||M===o.TransactionStatus.confirmed){const r=t.getNetworkRpcUrl(e.chainId),n=(0,b.extractRpcDomain)(r);Re.rpc_domain=n}return{properties:Re,sensitiveProperties:xe}}function I(e){return e===o.TransactionType.swap?k.swap:e===o.TransactionType.bridge?k.bridge:null}r.handlePostTransactionBalanceUpdate=async({getParticipateInMetrics:e,trackEvent:t,getHDEntropyIndex:r},{transactionMeta:i,approvalTransactionMeta:o})=>{var s;if(e()&&i.swapMetaData)if("0x0"===(null===(s=i.txReceipt)||void 0===s?void 0:s.status))t({event:c.MetaMetricsEventName.SwapFailed,category:c.MetaMetricsEventCategory.Swaps,sensitiveProperties:{...i.swapMetaData},properties:{hd_entropy_index:r()}});else{var a;const e=(0,u.getSwapsTokensReceivedFromTxMeta)(i.destinationTokenSymbol,i,i.destinationTokenAddress,i.txParams.from,i.destinationTokenDecimals,o,i.chainId),s=e?`${new n.BigNumber(e,10).div(i.swapMetaData.token_to_amount,10).times(100).round(2)}%`:null,l=null!==(a=i.txReceipt)&&void 0!==a&&a.gasUsed&&i.swapMetaData.estimated_gas?`${new n.BigNumber(i.txReceipt.gasUsed,16).div(i.swapMetaData.estimated_gas,10).times(100).round(2)}%`:null,d=function(e,t){var r,i;let o="0x0";null!=t&&t.txReceipt&&(o=(0,u.calcGasTotal)(t.txReceipt.gasUsed,t.txReceipt.effectiveGasPrice));const s=(0,u.calcGasTotal)(null===(r=e.txReceipt)||void 0===r?void 0:r.gasUsed,null===(i=e.txReceipt)||void 0===i?void 0:i.effectiveGasPrice),a=new n.BigNumber(s,16).plus(o,16).toString(16);return{approvalGasCostInEth:Number((0,p.hexWEIToDecETH)(o)),tradeGasCostInEth:Number((0,p.hexWEIToDecETH)(s)),tradeAndApprovalGasCostInEth:Number((0,p.hexWEIToDecETH)(a))}}(i,o);t({event:c.MetaMetricsEventName.SwapCompleted,category:c.MetaMetricsEventCategory.Swaps,sensitiveProperties:{...i.swapMetaData,token_to_amount_received:e,quote_vs_executionRatio:s,estimated_vs_used_gasRatio:l,approval_gas_cost_in_eth:d.approvalGasCostInEth,trade_gas_cost_in_eth:d.tradeGasCostInEth,trade_and_approval_gas_cost_in_eth:d.tradeAndApprovalGasCostInEth,token_to_amount:i.swapMetaData.token_to_amount.toString(10)},properties:{hd_entropy_index:r()}})}}}}},{package:"$root$",file:"app/scripts/lib/transaction/metrics.ts"}],[372,{"../../../../shared/modules/conversion.utils":6315,"../../../../shared/modules/fetch-with-timeout":6322},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.buildUrl=u,r.getSendBundleSupportedChains=async function(e){const t=await c();return e.reduce((e,r)=>{const n=(0,i.hexToDecimal)(r),o=t[n];return e[r]=(null==o?void 0:o.sendBundle)??!1,e},{})},r.getSentinelApiHeaders=function(){const e={"X-Client-Id":l};e["X-Client-Version"]="13.18.1";return e},r.getSentinelNetworkFlags=d,r.isSendBundleSupported=async function(e){const t=await d(e);if(null==t||!t.sendBundle)return!1;return!0};var n,i=e("../../../../shared/modules/conversion.utils"),o=(n=e("../../../../shared/modules/fetch-with-timeout"))&&n.__esModule?n:{default:n};const s="https://tx-sentinel-{0}.api.cx.metamask.io/",a="networks",l="extension";async function c(){const e=`${u("ethereum-mainnet")}${a}`;return(await(0,o.default)()(e)).json()}async function d(e){const t=(0,i.hexToDecimal)(e);return(await c())[t]}function u(e){return s.replace("{0}",e)}}}},{package:"$root$",file:"app/scripts/lib/transaction/sentinel-api.ts"}],[373,{"../../../../shared/modules/fetch-with-timeout":6322,"../../../../shared/modules/rpc.utils":6331,"./sentinel-api":372,"@metamask/utils":3554},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.RelayStatus=r.RELAY_RPC_METHOD=void 0,r.isRelaySupported=async function(e){return Boolean(await u(e))},r.submitRelayTransaction=async function(e){const{chainId:t}=e,r=await u(t);if(!r)throw new Error(`Chain not supported by transaction relay - ${t}`);l("Request",r,e);const n=await(0,o.jsonRpcRequest)(r,d,[e]);return l("Response",n),n},r.waitForRelayResult=async function(e){const{chainId:t,interval:r,uuid:n}=e,i=await u(t);if(!i)throw new Error(`Chain not supported by transaction relay - ${t}`);const o=`${i}smart-transactions/${n}`;return new Promise((e,t)=>{const n=setInterval(async()=>{try{const t=await async function(e){l("Polling request",e);const t=await(0,s.default)()(e);if(l("Polling response",t),!t.ok){const e=await t.text();throw new Error(`Failed to fetch relay transaction status: ${t.status} - ${e}`)}const r=await t.json(),n=null==r?void 0:r.transactions[0],{hash:i,status:o}=n||{};return{status:o,transactionHash:i}}(o);t.status!==c.Pending&&(clearInterval(n),e(t))}catch(e){clearInterval(n),t(e)}},r)})};var n,i=e("@metamask/utils"),o=e("../../../../shared/modules/rpc.utils"),s=(n=e("../../../../shared/modules/fetch-with-timeout"))&&n.__esModule?n:{default:n},a=e("./sentinel-api");const l=(0,i.createProjectLogger)("transaction-relay");let c=r.RelayStatus=function(e){return e.Pending="PENDING",e.Success="VALIDATED",e}({});const d=r.RELAY_RPC_METHOD="eth_sendRelayTransaction";async function u(e){const t=await(0,a.getSentinelNetworkFlags)(e);return null!=t&&t.relayTransactions?(0,a.buildUrl)(t.network):(l("Chain is not supported",e),undefined)}}}},{package:"$root$",file:"app/scripts/lib/transaction/transaction-relay.ts"}],[374,{"../../../../shared/constants/app":6175,"../../../../shared/constants/security-provider":6202,"../../../../shared/lib/trace":6299,"../../../../shared/lib/trust-signals":6305,"../../../../shared/modules/transaction.utils":6348,"../ppom/ppom-util":313,"../trust-signals/security-alerts-api":375,"@metamask/keyring-api":2510,"@metamask/transaction-controller":3473,"ethereumjs-util":4728},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.addDappTransaction=async function(e){const{dappRequest:t,requestContext:r}=e,{id:n,method:i}=t,o=String(n),s=r.assertGet("origin"),a=r.get("securityAlertResponse"),c=r.get("traceContext"),d={actionId:o,requestId:String(n),method:i,origin:s,requireApproval:!0,securityAlertResponse:a};(0,l.endTrace)({name:l.TraceName.Middleware,id:o});const{waitForHash:u}=await m({...e,transactionOptions:{...d,traceContext:c}}),p=await u();return(0,l.endTrace)({name:l.TraceName.Transaction,id:o}),p},r.addTransaction=async function(e){await async function(e){const{chainId:t,ppomController:r,securityAlertsEnabled:n,transactionOptions:i,transactionParams:o,updateSecurityAlertResponse:l,internalAccounts:m,getSecurityAlertsConfig:g}=e;!function(e){const{getSecurityAlertResponse:t,addSecurityAlertResponse:r,securityAlertsEnabled:n,transactionOptions:i,transactionParams:o,chainId:s}=e,{origin:a}=i;if(a!==c.ORIGIN_METAMASK||!n)return;const{to:l}=o;if("string"!=typeof l)return;const p=(0,u.mapChainIdToSupportedEVMChain)(s);if(!p)return;const h=e=>t(e),m=(e,t)=>r(e,t);(0,d.scanAddressAndAddToCache)(l,h,m,p).catch(e=>{console.error("[scanAddressForTrustSignals] error scanning address for trust signals:",e)})}(e);const{type:f}=i,{data:C,value:b,to:v}=o,w=a.SECURITY_PROVIDER_EXCLUDED_TRANSACTION_TYPES.includes(f);if(!n||w)return;const S="0x0"===b&&h.includes(f)&&C?(0,p.getTransactionDataRecipient)(C):undefined;if(y(m,v)||y(m,S))return;try{const{from:n}=o,{actionId:c,origin:d}=i,u={method:"eth_sendTransaction",id:c??"",origin:d??"",params:[{from:n,to:v??"",value:b??"",data:C??""}],jsonrpc:"2.0"},p=(0,s.generateSecurityAlertId)();(0,s.validateRequestWithPPOM)({ppomController:r,request:u,securityAlertId:p,chainId:t,updateSecurityAlertResponse:l,getSecurityAlertsConfig:g});const h={...a.LOADING_SECURITY_ALERT_RESPONSE,securityAlertId:p};e.transactionOptions.securityAlertResponse=h}catch(e){(0,s.handlePPOMError)(e,"Error validating JSON RPC using PPOM: ")}}(e);const{transactionMeta:t,waitForHash:r}=await m(e);if(!e.waitForSubmit)return r().catch(()=>{}),t;const n=await r();return function(e,t){return t.state.transactions.find(t=>t.hash===e)}(n,e.transactionController)},r.getTransactionById=g,r.stripSingleLeadingZero=function(e){if(!e.startsWith("0x0")||e.length<=3)return e;return`0x${e.slice(3)}`};var n=e("@metamask/keyring-api"),i=e("@metamask/transaction-controller"),o=e("ethereumjs-util"),s=e("../ppom/ppom-util"),a=e("../../../../shared/constants/security-provider"),l=e("../../../../shared/lib/trace"),c=e("../../../../shared/constants/app"),d=e("../trust-signals/security-alerts-api"),u=e("../../../../shared/lib/trust-signals"),p=e("../../../../shared/modules/transaction.utils");const h=[i.TransactionType.tokenMethodTransfer,i.TransactionType.tokenMethodTransferFrom,i.TransactionType.tokenMethodSafeTransferFrom];async function m(e){const{selectedAccount:t}=e;return t.type===n.EthAccountType.Erc4337?async function(e){var t;const{networkClientId:r,transactionController:n,transactionOptions:i,transactionParams:s,userOperationController:a}=e,{maxFeePerGas:l,maxPriorityFeePerGas:c}=s,{origin:d,requireApproval:u,type:p}=i,h={...s,maxFeePerGas:(0,o.addHexPrefix)(l),maxPriorityFeePerGas:(0,o.addHexPrefix)(c)},m=null==i||null===(t=i.swaps)||void 0===t?void 0:t.meta;null!=m&&m.type&&delete m.type;const f={networkClientId:r,origin:d,requireApproval:u,swaps:m,type:p},y=await a.addUserOperationFromTransaction(h,f);a.startPollingByNetworkClientId(r);return{transactionMeta:g(y.id,n),waitForHash:y.transactionHash}}(e):async function(e){const{transactionController:t,transactionOptions:r,transactionParams:n,networkClientId:i}=e,{result:o,transactionMeta:s}=await t.addTransaction(n,{...r,networkClientId:i});return{transactionMeta:s,waitForHash:()=>o}}(e)}function g(e,t){return t.state.transactions.find(t=>t.id===e)}function f(e){return null==e?void 0:e.toLowerCase()}function y(e,t){const r=f(t);if(!r)return!1;return new Set(e.map(e=>f(e.address))).has(r)}}}},{package:"$root$",file:"app/scripts/lib/transaction/util.ts"}],[375,{"../../../../shared/constants/time":6211,"../../../../shared/lib/trust-signals":6305,"../../../../shared/modules/fetch-with-timeout":6322},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.scanAddress=c,r.scanAddressAndAddToCache=async function(e,t,r,n){const i=(0,s.createCacheKey)(n,e),o=t(i);if(o)return o;const a={result_type:s.ResultType.Loading,label:""};r(i,a);try{const t=await c(n,e);return r(i,t),t}catch(e){throw r(i,{result_type:s.ResultType.ErrorResult,label:""}),e}};var n,i=e("../../../../shared/constants/time"),o=(n=e("../../../../shared/modules/fetch-with-timeout"))&&n.__esModule?n:{default:n},s=e("../../../../shared/lib/trust-signals");const a=5*i.SECOND,l="address/evm/scan";async function c(e,t){const r="https://security-alerts.api.cx.metamask.io";const n=`${r}/${l}`,i={chain:e,address:t},s=await(0,o.default)(a)(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});return await s.json()}}}},{package:"$root$",file:"app/scripts/lib/trust-signals/security-alerts-api.ts"}],[376,{"../../../../shared/constants/app":6175,"../../../../shared/constants/signatures":6203,"../../../../shared/lib/trust-signals":6305,"../../../../shared/modules/transaction.utils":6348,"../ppom/security-alerts-api":315,"../transaction/delegation":368,"./security-alerts-api":375,"./trust-signals-util":377},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.createTrustSignalsMiddleware=function(e,t,r,p,h){return async(m,g,f)=>{try{if(!(0,d.isSecurityAlertsEnabledByUser)(p)||!(0,a.isSecurityAlertsAPIEnabled)())return;(0,d.isEthSendTransaction)(m)?(!function(e,t,r){if(!(0,d.hasValidTransactionParams)(e))return;const{to:i,data:o}=e.params[0],{chainId:s}=r.getNetworkConfigurationByNetworkClientId(e.networkClientId)??{};if(!s)return void console.error("ChainID not found for networkClientId");const a=(0,l.mapChainIdToSupportedEVMChain)(s);if(!a)return void console.error("Unsupported chainId:",s);if((0,c.scanAddressAndAddToCache)(i,t.getAddressSecurityAlertResponse,t.addAddressSecurityAlertResponse,a).catch(e=>{console.error("[createTrustSignalsMiddleware] error scanning address for transaction:",e)}),o&&"string"==typeof o){const e=(0,n.parseApprovalTransactionData)(o),r=null==e?void 0:e.spender;r&&(0,c.scanAddressAndAddToCache)(r,t.getAddressSecurityAlertResponse,t.addAddressSecurityAlertResponse,a).catch(e=>{console.error("[createTrustSignalsMiddleware] error scanning spender address for approval:",e)})}}(m,t,e),u(m,r)):(0,d.isEthSignTypedData)(m)?(!function(e,t,r){var a;if(e.method!==i.MESSAGE_TYPE.ETH_SIGN_TYPED_DATA_V3&&e.method!==i.MESSAGE_TYPE.ETH_SIGN_TYPED_DATA_V4)return;if(!(0,d.hasValidTypedDataParams)(e))return;const u=(0,n.parseTypedDataMessage)("string"==typeof e.params[1]?e.params[1]:JSON.stringify(e.params[1])),p=null===(a=u.domain)||void 0===a?void 0:a.verifyingContract;if(!p)return;const{chainId:h}=r.getNetworkConfigurationByNetworkClientId(e.networkClientId)??{};if(!h)return void console.error("ChainID not found for networkClientId");const m=(0,l.mapChainIdToSupportedEVMChain)(h);if(!m)return void console.error("Unsupported chainId:",h);(0,c.scanAddressAndAddToCache)(p,t.getAddressSecurityAlertResponse,t.addAddressSecurityAlertResponse,m).catch(e=>{console.error("[createTrustSignalsMiddleware] error scanning address for signature:",e)});const{primaryType:g}=u;if(!g)return;if(o.PRIMARY_TYPES_PERMIT.includes(g)){var f;const e=null===(f=u.message)||void 0===f?void 0:f.spender;e&&(0,c.scanAddressAndAddToCache)(e,t.getAddressSecurityAlertResponse,t.addAddressSecurityAlertResponse,m).catch(e=>{console.error("[createTrustSignalsMiddleware] error scanning spender address for permit:",e)})}if(g===s.PRIMARY_TYPE_DELEGATION){var y;const e=null===(y=u.message)||void 0===y?void 0:y.delegate;e&&(0,c.scanAddressAndAddToCache)(e,t.getAddressSecurityAlertResponse,t.addAddressSecurityAlertResponse,m).catch(e=>{console.error("[createTrustSignalsMiddleware] error scanning delegate address for delegation:",e)})}}(m,t,e),u(m,r)):((0,d.isConnected)(m,h)||(0,d.connectScreenHasBeenPrompted)(m))&&u(m,r)}catch(e){console.error("[createTrustSignalsMiddleware] error: ",e)}finally{f()}}};var n=e("../../../../shared/modules/transaction.utils"),i=e("../../../../shared/constants/app"),o=e("../../../../shared/constants/signatures"),s=e("../transaction/delegation"),a=e("../ppom/security-alerts-api"),l=e("../../../../shared/lib/trust-signals"),c=e("./security-alerts-api"),d=e("./trust-signals-util");function u(e,t){e.origin&&t.scanUrl(e.origin).catch(e=>{console.error("[createTrustSignalsMiddleware] error:",e)})}}}},{package:"$root$",file:"app/scripts/lib/trust-signals/trust-signals-middleware.ts"}],[377,{"../../../../shared/constants/app":6175,"../../../../shared/lib/trust-signals":6305,"../../../../shared/modules/selectors/networks":6335},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.connectScreenHasBeenPrompted=function(e){return e.method===i.MESSAGE_TYPE.ETH_REQUEST_ACCOUNTS||e.method===i.MESSAGE_TYPE.WALLET_REQUEST_PERMISSIONS},r.getChainId=function(e){var t;const r=null===(t=(0,n.getProviderConfig)({metamask:e.state}))||void 0===t?void 0:t.chainId;if(!r)throw new Error("Chain ID not found");return(0,o.mapChainIdToSupportedEVMChain)(r)},r.hasValidTransactionParams=function(e){if(!("params"in e)||!e.params)return!1;if(!Array.isArray(e.params)||0===e.params.length)return!1;const t=e.params[0];return"object"==typeof t&&null!==t&&"to"in t},r.hasValidTypedDataParams=function(e){if(!("params"in e)||!e.params)return!1;if(!Array.isArray(e.params)||e.params.length<2)return!1;return e.params[1]!==undefined&&null!==e.params[1]},r.isConnected=function(e,t){if(!e.origin||e.method!==i.MESSAGE_TYPE.ETH_ACCOUNTS)return!1;const r=t(e.origin);return Array.isArray(r)&&r.length>0},r.isEthSendTransaction=function(e){return e.method===i.MESSAGE_TYPE.ETH_SEND_TRANSACTION},r.isEthSignTypedData=function(e){return e.method===i.MESSAGE_TYPE.ETH_SIGN_TYPED_DATA||e.method===i.MESSAGE_TYPE.ETH_SIGN_TYPED_DATA_V1||e.method===i.MESSAGE_TYPE.ETH_SIGN_TYPED_DATA_V3||e.method===i.MESSAGE_TYPE.ETH_SIGN_TYPED_DATA_V4},r.isSecurityAlertsEnabledByUser=function(e){const{securityAlertsEnabled:t}=e.state;return t};var n=e("../../../../shared/modules/selectors/networks"),i=e("../../../../shared/constants/app"),o=e("../../../../shared/lib/trust-signals")}}},{package:"$root$",file:"app/scripts/lib/trust-signals/trust-signals-util.ts"}],[378,{loglevel:5247},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.updateRemoteFeatureFlags=async function(e){try{const t=e.remoteFeatureFlagController;await t.updateRemoteFeatureFlags()}catch(e){i.default.error("Error initializing remote feature flags:",e)}};var n,i=(n=e("loglevel"))&&n.__esModule?n:{default:n}}}},{package:"$root$",file:"app/scripts/lib/update-remote-feature-flags.ts"}],[379,{"../../../shared/modules/environment":6319,"@metamask/utils":3554,"webextension-polyfill":6163},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.useSplitStateStorage=async function(e){var t;if((0,s.getIsSettingsPageDevOptionsEnabled)()){const t=await async function(){const{splitStateMigrationEnabled:e,splitStateMigrationMaxAccounts:t,splitStateMigrationMaxNetworks:r}=await i.default.storage.local.get(["splitStateMigrationEnabled","splitStateMigrationMaxAccounts","splitStateMigrationMaxNetworks"]);return{enabled:e===undefined?null:"1"===e,maxAccounts:t===undefined?0:Number(t),maxNetworks:r===undefined?0:Number(r)}}();if(null!==t.enabled){if(!1===t.enabled)return!1;const{accountCount:r,networkCount:n}=a(e);return r<=t.maxAccounts&&n<=t.maxNetworks}}const r=e.RemoteFeatureFlagController,n=null==r||null===(t=r.remoteFeatureFlags)||void 0===t?void 0:t.platformSplitStateGradualRollout;if(!function(e){return(0,o.isObject)(e)&&(0,o.hasProperty)(e,"value")&&(0,o.isObject)(e.value)&&(0,o.hasProperty)(e.value,"enabled")&&"number"==typeof e.value.enabled&&(0,o.hasProperty)(e.value,"maxAccounts")&&"number"==typeof e.value.maxAccounts&&(0,o.hasProperty)(e.value,"maxNetworks")&&"number"==typeof e.value.maxNetworks}(n)||n.value.enabled<=0)return!1;const{accountCount:l,networkCount:c}=a(e);return l<=n.value.maxAccounts&&c<=n.value.maxNetworks};var n,i=(n=e("webextension-polyfill"))&&n.__esModule?n:{default:n},o=e("@metamask/utils"),s=e("../../../shared/modules/environment");function a(e){var t;const r=e.AccountsController,n=Object.keys((null==r||null===(t=r.internalAccounts)||void 0===t?void 0:t.accounts)??{}).length,i=e.NetworkController;return{accountCount:n,networkCount:Object.keys((null==i?void 0:i.networkConfigurationsByChainId)??{}).length}}}}},{package:"$root$",file:"app/scripts/lib/use-split-state-storage.ts"}],[38,{"@metamask/message-manager":2589},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.DecryptMessageManagerInit=void 0;var n=e("@metamask/message-manager");r.DecryptMessageManagerInit=({controllerMessenger:e})=>({persistedStateKey:null,memStateKey:null,controller:new n.DecryptMessageManager({additionalFinishStatuses:["decrypted"],messenger:e})})}}},{package:"$root$",file:"app/scripts/controller-init/confirmations/decrypt-message-manager-init.ts"}],[381,{"../../shared/constants/app":6175,"../../shared/constants/bridge":6176,"../../shared/constants/hardware-wallets":6184,"../../shared/constants/keyring":6186,"../../shared/constants/metametrics":6190,"../../shared/constants/multichain/networks":6193,"../../shared/constants/network":6194,"../../shared/constants/onboarding":6197,"../../shared/constants/permissions":6198,"../../shared/constants/time":6211,"../../shared/constants/tokens":6212,"../../shared/constants/ui-initialization":6214,"../../shared/lib/accounts":6219,"../../shared/lib/accounts/bitcoin-wallet-snap":6218,"../../shared/lib/accounts/solana-wallet-snap":6222,"../../shared/lib/accounts/tron-wallet-snap":6223,"../../shared/lib/delegation/delegation":6263,"../../shared/lib/eip7702-support-utils":6268,"../../shared/lib/eip7702-utils":6269,"../../shared/lib/fetch-with-cache":6272,"../../shared/lib/metamask-controller-utils":6281,"../../shared/lib/multichain-accounts/remote-feature-flag":6282,"../../shared/lib/sentry":6292,"../../shared/lib/shield":6293,"../../shared/lib/snaps/snaps":6294,"../../shared/lib/storage-helpers":6295,"../../shared/lib/token-util":6298,"../../shared/lib/trace":6299,"../../shared/lib/transactions-controller-utils":6301,"../../shared/lib/translate":6304,"../../shared/modules/environment":6319,"../../shared/modules/error":6320,"../../shared/modules/hexstring-utils":6324,"../../shared/modules/mv3.utils":6327,"../../shared/modules/network.utils":6328,"../../shared/modules/selectors":6333,"../../shared/modules/selectors/multichain":6334,"../../shared/modules/selectors/networks":6335,"../../shared/modules/shield":6342,"../../shared/modules/string-utils":6346,"../../shared/modules/transaction.utils":6348,"./constants/stream":13,"./controller-init/account-order-controller-init":14,"./controller-init/account-tracker-controller-init":15,"./controller-init/accounts-controller-init":16,"./controller-init/accounts/account-tree-controller-init":17,"./controller-init/accounts/snap-keyring-builder-init":18,"./controller-init/alert-controller-init":19,"./controller-init/announcement-controller-init":20,"./controller-init/app-metadata-controller-init":21,"./controller-init/app-state-controller-init":22,"./controller-init/assets":24,"./controller-init/assets/network-enablement-controller-init":25,"./controller-init/bridge-controller-init":30,"./controller-init/bridge-status-controller-init":31,"./controller-init/claims":34,"./controller-init/confirmations/address-book-controller-init":35,"./controller-init/confirmations/approval-controller-init":36,"./controller-init/confirmations/decrypt-message-controller-init":37,"./controller-init/confirmations/decrypt-message-manager-init":38,"./controller-init/confirmations/encryption-public-key-controller-init":39,"./controller-init/confirmations/encryption-public-key-message-manager-init":40,"./controller-init/confirmations/ens-controller-init":41,"./controller-init/confirmations/gas-fee-controller-init":42,"./controller-init/confirmations/name-controller-init":43,"./controller-init/confirmations/ppom-controller-init":44,"./controller-init/confirmations/signature-controller-init":45,"./controller-init/confirmations/transaction-controller-init":46,"./controller-init/confirmations/user-operation-controller-init":47,"./controller-init/connectivity":49,"./controller-init/core-backend":52,"./controller-init/currency-rate-controller-init":53,"./controller-init/defi-positions/defi-positions-controller-init":54,"./controller-init/delegation/delegation-controller-init":55,"./controller-init/error-reporting-service-init":56,"./controller-init/gator-permissions/gator-permissions-controller-init":57,"./controller-init/identity/authentication-controller-init":58,"./controller-init/identity/user-storage-controller-init":59,"./controller-init/institutional-snap/institutional-snap-controller-init":61,"./controller-init/keyring-controller-init":62,"./controller-init/logging-controller-init":63,"./controller-init/metametrics-controller-init":169,"./controller-init/metametrics-data-deletion-controller-init":170,"./controller-init/multichain":171,"./controller-init/multichain/multichain-account-service-init":172,"./controller-init/network-controller-init":179,"./controller-init/notifications/notification-services-controller-init":180,"./controller-init/notifications/notification-services-push-controller-init":181,"./controller-init/onboarding-controller-init":182,"./controller-init/permission-controller-init":183,"./controller-init/permission-log-controller-init":184,"./controller-init/phishing-controller-init":185,"./controller-init/preferences-controller-init":186,"./controller-init/profile-metrics-controller-init":187,"./controller-init/profile-metrics-service-init":188,"./controller-init/rates-controller-init":189,"./controller-init/remote-feature-flag-controller-init":190,"./controller-init/rewards-controller-init":191,"./controller-init/rewards-data-service-init":192,"./controller-init/seedless-onboarding":193,"./controller-init/selected-network-controller-init":196,"./controller-init/shield/shield-controller-init":197,"./controller-init/smart-transactions/smart-transactions-controller-init":198,"./controller-init/snaps":201,"./controller-init/static-assets-controller-init":210,"./controller-init/storage-service-init":211,"./controller-init/subject-metadata-controller-init":212,"./controller-init/subscription":213,"./controller-init/swaps-controller-init":216,"./controller-init/token-balances-controller-init":217,"./controller-init/token-detection-controller-init":218,"./controller-init/token-list-controller-init":219,"./controller-init/tokens-controller-init":220,"./controller-init/transaction-pay-controller-init":221,"./controller-init/utils":223,"./controllers/permissions":240,"./controllers/preferences-controller":244,"./detect-multiple-instances":258,"./lib/AccountIdentitiesPetnamesBridge":261,"./lib/AddressBookPetnamesBridge":262,"./lib/ComposableObservableStore":263,"./lib/PatchStore":265,"./lib/WalletFundsObtainedMonitor":267,"./lib/approval/utils":269,"./lib/backup":270,"./lib/createDefiReferralMiddleware":271,"./lib/createDupeReqFilterStream":272,"./lib/createEvmMethodsToNonEvmAccountReqFilterMiddleware":273,"./lib/createLoggerMiddleware":274,"./lib/createMainFrameOriginMiddleware":275,"./lib/createMetaRPCHandler":276,"./lib/createMetamaskMiddleware":277,"./lib/createOnboardingMiddleware":278,"./lib/createOriginMiddleware":279,"./lib/createOriginThrottlingMiddleware":280,"./lib/createRPCMethodTrackingMiddleware":281,"./lib/createTabIdMiddleware":282,"./lib/createTracingMiddleware":283,"./lib/dapp-swap/dapp-swap-middleware":284,"./lib/forwardRequestToSnap":294,"./lib/messenger":298,"./lib/open-update-tab-and-reload":309,"./lib/ppom/ppom-middleware":312,"./lib/ppom/ppom-util":313,"./lib/rpc-method-middleware":332,"./lib/rpcBlockingMiddleware":333,"./lib/signature/util":339,"./lib/snap-keyring":342,"./lib/snap-keyring/keyring-snaps-permissions":343,"./lib/state-utils":352,"./lib/stream-utils":359,"./lib/transaction/containers/util":361,"./lib/transaction/decode/util":367,"./lib/transaction/metrics":371,"./lib/transaction/sentinel-api":372,"./lib/transaction/transaction-relay":373,"./lib/transaction/util":374,"./lib/trust-signals/trust-signals-middleware":376,"./lib/util":380,"@ethersproject/abi":763,"@metamask/approval-controller":1359,"@metamask/bridge-controller":1527,"@metamask/bridge-status-controller":1556,"@metamask/chain-agnostic-permission":1610,"@metamask/controller-utils":1639,"@metamask/eip-5792-middleware":2033,"@metamask/eip-7702-internal-rpc-middleware":2040,"@metamask/eth-json-rpc-filters":2081,"@metamask/eth-json-rpc-filters/subscriptionManager":2083,"@metamask/eth-json-rpc-middleware":2099,"@metamask/eth-ledger-bridge-keyring":2119,"@metamask/eth-qr-keyring":2128,"@metamask/eth-sig-util":2228,"@metamask/eth-trezor-keyring":2316,"@metamask/json-rpc-engine":2418,"@metamask/json-rpc-middleware-stream":2431,"@metamask/keyring-api":2510,"@metamask/keyring-controller":2537,"@metamask/messenger":2592,"@metamask/metamask-eth-abis":2597,"@metamask/multichain-api-middleware":2671,"@metamask/notification-services-controller/notification-services":2781,"@metamask/obs-store":2840,"@metamask/obs-store/dist/asStream":2839,"@metamask/permission-controller":2862,"@metamask/rpc-errors":3026,"@metamask/scure-bip39/dist/wordlists/english":3030,"@metamask/seedless-onboarding-controller":3046,"@metamask/selected-network-controller":3051,"@metamask/snaps-rpc-methods":3209,"@metamask/snaps-utils":3382,"@metamask/subscription-controller":3411,"@metamask/transaction-controller":3473,"@metamask/utils":3554,"await-semaphore":4349,buffer:4474,"eth-chainlist":4674,"eth-lattice-keyring":4679,events:4770,lodash:5239,loglevel:5247,nanoid:5438,"readable-stream":5677,"webextension-polyfill":6163},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){(function(t){(function(){Object.defineProperty(r,"__esModule",{value:!0}),r.default=r.METAMASK_CONTROLLER_EVENTS=void 0;var n=$r(e("events")),i=e("readable-stream"),o=$r(e("webextension-polyfill")),s=e("@metamask/json-rpc-engine"),a=e("@metamask/json-rpc-middleware-stream"),l=e("@metamask/obs-store"),c=e("@metamask/obs-store/dist/asStream"),d=e("@metamask/eth-json-rpc-middleware"),u=e("lodash"),p=e("@metamask/keyring-controller"),h=$r(e("@metamask/eth-json-rpc-filters")),m=$r(e("@metamask/eth-json-rpc-filters/subscriptionManager")),g=e("@metamask/rpc-errors"),f=e("await-semaphore"),y=$r(e("loglevel")),C=e("@metamask/eth-trezor-keyring"),b=e("@metamask/eth-ledger-bridge-keyring"),v=$r(e("eth-lattice-keyring")),w=e("eth-chainlist"),S=e("@metamask/eth-qr-keyring"),T=e("nanoid"),k=e("@metamask/approval-controller"),A=e("@metamask/messenger"),M=e("@metamask/permission-controller"),P=e("@metamask/selected-network-controller"),E=e("@metamask/snaps-rpc-methods"),I=e("@metamask/controller-utils"),_=e("@metamask/scure-bip39/dist/wordlists/english"),O=e("@metamask/bridge-controller"),R=e("@metamask/transaction-controller"),N=e("@ethersproject/abi"),D=e("@metamask/metamask-eth-abis"),F=e("@metamask/keyring-api"),x=e("@metamask/utils"),j=e("@metamask/eth-sig-util"),B=e("@metamask/notification-services-controller/notification-services"),U=e("@metamask/multichain-api-middleware"),L=e("@metamask/eip-5792-middleware"),G=e("@metamask/eip-7702-internal-rpc-middleware"),K=e("@metamask/chain-agnostic-permission"),$=e("@metamask/bridge-status-controller"),q=e("@metamask/seedless-onboarding-controller"),H=e("@metamask/subscription-controller"),W=e("@metamask/snaps-utils"),V=e("../../shared/lib/eip7702-support-utils"),Y=e("../../shared/lib/eip7702-utils"),z=e("../../shared/lib/multichain-accounts/remote-feature-flag"),X=e("../../shared/lib/sentry"),J=e("../../shared/constants/network"),Q=e("../../shared/constants/hardware-wallets"),Z=e("../../shared/constants/keyring"),ee=e("../../shared/constants/permissions"),te=e("../../shared/constants/time"),re=e("../../shared/constants/app"),ne=e("../../shared/constants/metametrics"),ie=e("../../shared/lib/storage-helpers"),oe=e("../../shared/lib/token-util"),se=e("../../shared/modules/string-utils"),ae=e("../../shared/modules/transaction.utils"),le=e("../../shared/constants/tokens"),ce=e("../../shared/constants/ui-initialization"),de=e("../../shared/lib/metamask-controller-utils"),ue=e("../../shared/modules/mv3.utils"),pe=e("../../shared/modules/network.utils"),he=e("../../shared/modules/selectors"),me=e("../../shared/lib/transactions-controller-utils"),ge=e("../../shared/modules/selectors/networks"),fe=e("../../shared/modules/selectors/multichain"),ye=e("../../shared/lib/trace"),Ce=$r(e("../../shared/lib/fetch-with-cache")),be=e("../../shared/constants/multichain/networks"),ve=e("../../shared/constants/bridge"),we=e("../../shared/lib/accounts"),Se=e("../../shared/lib/accounts/bitcoin-wallet-snap"),Te=e("../../shared/lib/accounts/solana-wallet-snap"),ke=e("../../shared/lib/accounts/tron-wallet-snap"),Ae=e("../../shared/constants/onboarding"),Me=e("../../shared/lib/translate"),Pe=e("../../shared/modules/environment"),Ee=e("../../shared/lib/snaps/snaps"),Ie=e("../../shared/modules/hexstring-utils"),_e=e("../../shared/modules/shield"),Oe=e("../../shared/lib/shield"),Re=e("../../shared/modules/error"),Ne=e("./lib/transaction/metrics"),De=e("./lib/snap-keyring/keyring-snaps-permissions"),Fe=e("./lib/AddressBookPetnamesBridge"),xe=e("./lib/AccountIdentitiesPetnamesBridge"),je=e("./lib/WalletFundsObtainedMonitor"),Be=e("./lib/ppom/ppom-middleware"),Ue=e("./lib/dapp-swap/dapp-swap-middleware"),Le=e("./lib/trust-signals/trust-signals-middleware"),Ge=e("./detect-multiple-instances"),Ke=$r(e("./lib/ComposableObservableStore")),$e=$r(e("./lib/createDupeReqFilterStream")),qe=$r(e("./lib/createLoggerMiddleware")),He=e("./lib/rpc-method-middleware"),We=$r(e("./lib/createOriginMiddleware")),Ve=$r(e("./lib/rpcBlockingMiddleware")),Ye=$r(e("./lib/createMainFrameOriginMiddleware")),ze=$r(e("./lib/createTabIdMiddleware")),Xe=$r(e("./lib/createOnboardingMiddleware")),Je=e("./lib/stream-utils"),Qe=e("./controllers/preferences-controller"),Ze=$r(e("./lib/backup")),et=$r(e("./lib/createMetaRPCHandler")),tt=e("./lib/util"),rt=$r(e("./lib/createMetamaskMiddleware")),nt=e("./lib/createDefiReferralMiddleware"),it=e("./controllers/permissions"),ot=$r(e("./lib/createRPCMethodTrackingMiddleware")),st=e("./lib/snap-keyring"),at=e("./lib/transaction/util"),lt=e("./lib/signature/util"),ct=e("./constants/stream"),dt=e("./lib/ppom/ppom-util"),ut=$r(e("./lib/createEvmMethodsToNonEvmAccountReqFilterMiddleware")),pt=e("./lib/transaction/decode/util"),ht=$r(e("./lib/createTracingMiddleware")),mt=$r(e("./lib/createOriginThrottlingMiddleware")),gt=e("./lib/PatchStore"),ft=e("./lib/state-utils"),yt=e("./lib/approval/utils"),Ct=e("./controller-init/institutional-snap/institutional-snap-controller-init"),bt=e("./controller-init/multichain"),vt=e("./controller-init/assets"),wt=e("./controller-init/confirmations/transaction-controller-init"),St=e("./controller-init/transaction-pay-controller-init"),Tt=e("./controller-init/confirmations/ppom-controller-init"),kt=e("./controller-init/smart-transactions/smart-transactions-controller-init"),At=e("./controller-init/utils"),Mt=e("./controller-init/snaps"),Pt=e("./controller-init/core-backend"),Et=e("./controller-init/identity/authentication-controller-init"),It=e("./controller-init/identity/user-storage-controller-init"),_t=e("./controller-init/defi-positions/defi-positions-controller-init"),Ot=e("./controller-init/notifications/notification-services-controller-init"),Rt=e("./controller-init/notifications/notification-services-push-controller-init"),Nt=e("./controller-init/delegation/delegation-controller-init"),Dt=e("./lib/transaction/transaction-relay"),Ft=e("./lib/open-update-tab-and-reload"),xt=e("./controller-init/accounts/account-tree-controller-init"),jt=e("./controller-init/multichain/multichain-account-service-init"),Bt=e("./controller-init/seedless-onboarding"),Ut=e("./lib/transaction/containers/util"),Lt=e("./lib/transaction/sentinel-api"),Gt=e("./controller-init/shield/shield-controller-init"),Kt=e("./controller-init/gator-permissions/gator-permissions-controller-init"),$t=e("./lib/forwardRequestToSnap"),qt=e("./controller-init/metametrics-controller-init"),Ht=e("./controller-init/token-list-controller-init"),Wt=e("./controller-init/token-detection-controller-init"),Vt=e("./controller-init/tokens-controller-init"),Yt=e("./controller-init/token-balances-controller-init"),zt=e("./controller-init/static-assets-controller-init"),Xt=e("./controller-init/rates-controller-init"),Jt=e("./controller-init/currency-rate-controller-init"),Qt=e("./controller-init/confirmations/ens-controller-init"),Zt=e("./controller-init/confirmations/name-controller-init"),er=e("./controller-init/confirmations/gas-fee-controller-init"),tr=e("./controller-init/selected-network-controller-init"),rr=e("./controller-init/subscription"),nr=e("./controller-init/connectivity"),ir=e("./controller-init/account-tracker-controller-init"),or=e("./controller-init/onboarding-controller-init"),sr=e("./controller-init/remote-feature-flag-controller-init"),ar=e("./controller-init/swaps-controller-init"),lr=e("./controller-init/bridge-controller-init"),cr=e("./controller-init/bridge-status-controller-init"),dr=e("./controller-init/preferences-controller-init"),ur=e("./controller-init/app-state-controller-init"),pr=e("./controller-init/permission-controller-init"),hr=e("./controller-init/subject-metadata-controller-init"),mr=e("./controller-init/assets/network-enablement-controller-init"),gr=e("./controller-init/keyring-controller-init"),fr=e("./controller-init/accounts/snap-keyring-builder-init"),yr=e("./controller-init/permission-log-controller-init"),Cr=e("./controller-init/network-controller-init"),br=e("./controller-init/announcement-controller-init"),vr=e("./controller-init/account-order-controller-init"),wr=e("./controller-init/accounts-controller-init"),Sr=e("./controller-init/phishing-controller-init"),Tr=e("./controller-init/alert-controller-init"),kr=e("./controller-init/metametrics-data-deletion-controller-init"),Ar=e("./controller-init/logging-controller-init"),Mr=e("./controller-init/app-metadata-controller-init"),Pr=e("./controller-init/error-reporting-service-init"),Er=e("./controller-init/storage-service-init"),Ir=e("./controller-init/confirmations/approval-controller-init"),_r=e("./controller-init/confirmations/address-book-controller-init"),Or=e("./controller-init/confirmations/decrypt-message-manager-init"),Rr=e("./controller-init/confirmations/decrypt-message-controller-init"),Nr=e("./controller-init/confirmations/encryption-public-key-controller-init"),Dr=e("./controller-init/confirmations/encryption-public-key-message-manager-init"),Fr=e("./controller-init/confirmations/signature-controller-init"),xr=e("./controller-init/confirmations/user-operation-controller-init"),jr=e("./controller-init/rewards-data-service-init"),Br=e("./controller-init/rewards-controller-init"),Ur=e("./lib/messenger"),Lr=e("./controller-init/claims"),Gr=e("./controller-init/profile-metrics-controller-init"),Kr=e("./controller-init/profile-metrics-service-init");function $r(e){return e&&e.__esModule?e:{default:e}}function qr(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(qr=function(e){return e?r:t})(e)}function Hr(e,t){(function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")})(e,t),t.add(e)}function Wr(e,t,r){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Vr(e,t,r){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:r;throw new TypeError("Private element is not present on this object")}r.METAMASK_CONTROLLER_EVENTS={UPDATE_BADGE:"updateBadge",DECRYPT_MESSAGE_MANAGER_UPDATE_BADGE:"DecryptMessageManager:updateBadge",ENCRYPTION_PUBLIC_KEY_MANAGER_UPDATE_BADGE:"EncryptionPublicKeyManager:updateBadge",APPROVAL_STATE_CHANGE:"ApprovalController:stateChange",APP_STATE_UNLOCK_CHANGE:"AppStateController:unlockChange",METAMASK_NOTIFICATIONS_LIST_UPDATED:"NotificationServicesController:notificationsListUpdated",METAMASK_NOTIFICATIONS_MARK_AS_READ:"NotificationServicesController:markNotificationsAsRead"};const Yr="eip-1193",zr="caip-multichain";var Xr=new WeakSet;class Jr extends n.default{constructor(e){super(),Hr(this,Xr),Wr(this,"handleWatchAssetRequest",({asset:e,type:t,origin:r,networkClientId:n})=>{switch(t){case I.ERC20:return this.tokensController.watchAsset({asset:e,type:t,networkClientId:n});case I.ERC721:case I.ERC1155:return this.nftController.watchNft(e,t,r,n);default:throw new Error(`Asset type ${t} not supported`)}}),Wr(this,"removePermissionsFor",e=>{try{this.permissionController.revokePermissions(e)}catch(e){if(!(e instanceof M.PermissionsRequestNotFoundError))throw e}}),Wr(this,"updateCaveat",(e,t,r,n)=>{try{this.controllerMessenger.call("PermissionController:updateCaveat",e,t,r,n)}catch(e){if(!(e instanceof M.PermissionsRequestNotFoundError))throw e}}),Wr(this,"updateNetworksList",e=>{try{this.networkOrderController.updateNetworksList(e)}catch(e){throw y.default.error(e.message),e}}),Wr(this,"updateAccountsList",e=>{try{this.accountOrderController.updateAccountsList(e)}catch(e){throw y.default.error(e.message),e}}),Wr(this,"setEnabledNetworks",async e=>{try{this.networkEnablementController.enableNetwork(e)}catch(e){throw y.default.error(e.message),e}await this.lookupSelectedNetworks()}),Wr(this,"setEnabledAllPopularNetworks",async()=>{try{this.networkEnablementController.enableAllPopularNetworks()}catch(e){throw y.default.error(e.message),e}await this.lookupSelectedNetworks()}),Wr(this,"updateHiddenAccountsList",e=>{try{this.accountOrderController.updateHiddenAccountsList(e)}catch(e){throw y.default.error(e.message),e}}),Wr(this,"rejectPermissionsRequest",e=>{try{this.permissionController.rejectPermissionsRequest(e)}catch(e){if(!(e instanceof M.PermissionsRequestNotFoundError))throw e}}),Wr(this,"acceptPermissionsRequest",e=>{try{this.permissionController.acceptPermissionsRequest(e)}catch(e){if(!(e instanceof M.PermissionsRequestNotFoundError))throw e}}),Wr(this,"resolvePendingApproval",async(e,t,r)=>{try{await this.approvalController.accept(e,t,r)}catch(e){if(!(e instanceof k.ApprovalRequestNotFoundError))throw e}}),Wr(this,"rejectPendingApproval",(e,t)=>{try{this.approvalController.reject(e,new g.JsonRpcError(t.code,t.message,t.data))}catch(e){if(!(e instanceof k.ApprovalRequestNotFoundError))throw e}});const{isFirstMetaMaskControllerSetup:t,controllerMessenger:r=(0,Ur.getRootMessenger)()}=e;this.defaultMaxListeners=20,this.sendUpdate=(0,u.debounce)(this.privateSendUpdate.bind(this),200*te.MILLISECOND),this.opts=e,this.requestSafeReload=e.requestSafeReload??(()=>Promise.resolve()),this.extension=e.browser,this.platform=e.platform,this.notificationManager=e.notificationManager;const n=e.initState||{},i="13.18.1";this.featureFlags=e.featureFlags,this.activeControllerConnections=0,this.offscreenPromise=e.offscreenPromise??Promise.resolve(),this.getRequestAccountTabIds=e.getRequestAccountTabIds,this.getOpenMetamaskTabsIds=e.getOpenMetamaskTabsIds,this.initializeChainlist(),this.controllerMessenger=r,this.currentMigrationVersion=e.currentMigrationVersion,this.store=new Ke.default({state:n,controllerMessenger:this.controllerMessenger,persist:!0}),this.connections={},this.createVaultMutex=new f.Mutex,this.seedlessOperationMutex=new f.Mutex,this.extension.runtime.onInstalled.addListener(e=>{e.reason}),this.multichainSubscriptionManager=new U.MultichainSubscriptionManager({getNetworkClientById:this.controllerMessenger.call.bind(this.controllerMessenger,"NetworkController:getNetworkClientById"),findNetworkClientIdByChainId:this.controllerMessenger.call.bind(this.controllerMessenger,"NetworkController:findNetworkClientIdByChainId")}),this.multichainMiddlewareManager=new U.MultichainMiddlewareManager,this.deprecatedNetworkVersions={},this.on("controllerConnectionChanged",e=>{const{completedOnboarding:t}=this.onboardingController.state;e>0&&t?this.triggerNetworkrequests():this.stopNetworkRequests()}),this.on("controllerConnectionChanged",e=>{const{completedOnboarding:t}=this.onboardingController.state;e>0&&t&&this.appStateController.state.canTrackWalletFundsObtained&&this.walletFundsObtainedMonitor.setupMonitoring()});const o={ApprovalController:Ir.ApprovalControllerInit,LoggingController:Ar.LoggingControllerInit,ErrorReportingService:Pr.ErrorReportingServiceInit,StorageService:Er.StorageServiceInit,AppMetadataController:Mr.AppMetadataControllerInit,PreferencesController:dr.PreferencesControllerInit,SnapKeyringBuilder:fr.SnapKeyringBuilderInit,KeyringController:gr.KeyringControllerInit,AccountsController:wr.AccountsControllerInit,AddressBookController:_r.AddressBookControllerInit,AlertController:Tr.AlertControllerInit,DecryptMessageManager:Or.DecryptMessageManagerInit,DecryptMessageController:Rr.DecryptMessageControllerInit,EncryptionPublicKeyManager:Dr.EncryptionPublicKeyManagerInit,EncryptionPublicKeyController:Nr.EncryptionPublicKeyControllerInit,SignatureController:Fr.SignatureControllerInit,PermissionController:pr.PermissionControllerInit,PermissionLogController:yr.PermissionLogControllerInit,SubjectMetadataController:hr.SubjectMetadataControllerInit,AppStateController:ur.AppStateControllerInit,OnboardingController:or.OnboardingControllerInit,RemoteFeatureFlagController:sr.RemoteFeatureFlagControllerInit,NetworkController:Cr.NetworkControllerInit,MetaMetricsController:qt.MetaMetricsControllerInit,MetaMetricsDataDeletionController:kr.MetaMetricsDataDeletionControllerInit,GasFeeController:er.GasFeeControllerInit,UserOperationController:xr.UserOperationControllerInit,ExecutionService:Mt.ExecutionServiceInit,InstitutionalSnapController:Ct.InstitutionalSnapControllerInit,RateLimitController:Mt.RateLimitControllerInit,SnapsRegistry:Mt.SnapsRegistryInit,CronjobController:Mt.CronjobControllerInit,SelectedNetworkController:tr.SelectedNetworkControllerInit,SnapController:Mt.SnapControllerInit,SnapInsightsController:Mt.SnapInsightsControllerInit,SnapInterfaceController:Mt.SnapInterfaceControllerInit,WebSocketService:Mt.WebSocketServiceInit,BackendWebSocketService:Pt.BackendWebSocketServiceInit,AccountActivityService:Pt.AccountActivityServiceInit,PPOMController:Tt.PPOMControllerInit,PhishingController:Sr.PhishingControllerInit,AccountTrackerController:ir.AccountTrackerControllerInit,TransactionController:wt.TransactionControllerInit,TransactionPayController:St.TransactionPayControllerInit,SmartTransactionsController:kt.SmartTransactionsControllerInit,SwapsController:ar.SwapsControllerInit,BridgeController:lr.BridgeControllerInit,BridgeStatusController:cr.BridgeStatusControllerInit,NftController:vt.NftControllerInit,AssetsContractController:vt.AssetsContractControllerInit,NftDetectionController:vt.NftDetectionControllerInit,CurrencyRateController:Jt.CurrencyRateControllerInit,RatesController:Xt.RatesControllerInit,TokenListController:Ht.TokenListControllerInit,TokenDetectionController:Wt.TokenDetectionControllerInit,TokensController:Vt.TokensControllerInit,TokenBalancesController:Yt.TokenBalancesControllerInit,StaticAssetsController:zt.StaticAssetsControllerInit,MultichainNetworkController:bt.MultichainNetworkControllerInit,NetworkEnablementController:mr.NetworkEnablementControllerInit,TokenRatesController:vt.TokenRatesControllerInit,AccountOrderController:vr.AccountOrderControllerInit,AccountTreeController:xt.AccountTreeControllerInit,MultichainAssetsController:bt.MultichainAssetsControllerInit,MultichainAssetsRatesController:bt.MultichainAssetsRatesControllerInit,MultichainBalancesController:bt.MultichainBalancesControllerInit,MultichainTransactionsController:bt.MultichainTransactionsControllerInit,MultichainAccountService:jt.MultichainAccountServiceInit,MultichainRouter:Mt.MultichainRouterInit,AuthenticationController:Et.AuthenticationControllerInit,UserStorageController:It.UserStorageControllerInit,NotificationServicesController:Ot.NotificationServicesControllerInit,NotificationServicesPushController:Rt.NotificationServicesPushControllerInit,DeFiPositionsController:_t.DeFiPositionsControllerInit,DelegationController:Nt.DelegationControllerInit,OAuthService:Bt.OAuthServiceInit,SeedlessOnboardingController:Bt.SeedlessOnboardingControllerInit,SubscriptionController:rr.SubscriptionControllerInit,SubscriptionService:rr.SubscriptionServiceInit,ConnectivityController:nr.ConnectivityControllerInit,NetworkOrderController:vt.NetworkOrderControllerInit,ShieldController:Gt.ShieldControllerInit,ClaimsController:Lr.ClaimsControllerInit,ClaimsService:Lr.ClaimsServiceInit,GatorPermissionsController:Kt.GatorPermissionsControllerInit,SnapsNameProvider:Mt.SnapsNameProviderInit,EnsController:Qt.EnsControllerInit,NameController:Zt.NameControllerInit,AnnouncementController:br.AnnouncementControllerInit,RewardsDataService:jr.RewardsDataServiceInit,RewardsController:Br.RewardsControllerInit,ProfileMetricsController:Gr.ProfileMetricsControllerInit,ProfileMetricsService:Kr.ProfileMetricsServiceInit},{controllerApi:a,controllerMemState:l,controllerPersistedState:c,controllersByName:d}=Vr(Xr,this,tn).call(this,{initFunctions:o,initState:n});this.controllerApi=a,this.controllerMemState=l,this.controllerPersistedState=c,this.controllersByName=d,this.approvalController=d.ApprovalController,this.loggingController=d.LoggingController,this.appMetadataController=d.AppMetadataController,this.preferencesController=d.PreferencesController,this.keyringController=d.KeyringController,this.accountsController=d.AccountsController,this.addressBookController=d.AddressBookController,this.alertController=d.AlertController,this.decryptMessageController=d.DecryptMessageController,this.encryptionPublicKeyController=d.EncryptionPublicKeyController,this.signatureController=d.SignatureController,this.permissionController=d.PermissionController,this.permissionLogController=d.PermissionLogController,this.subjectMetadataController=d.SubjectMetadataController,this.appStateController=d.AppStateController,this.networkController=d.NetworkController,this.metaMetricsController=d.MetaMetricsController,this.metaMetricsDataDeletionController=d.MetaMetricsDataDeletionController,this.remoteFeatureFlagController=d.RemoteFeatureFlagController,this.gasFeeController=d.GasFeeController,this.userOperationController=d.UserOperationController,this.cronjobController=d.CronjobController,this.rateLimitController=d.RateLimitController,this.selectedNetworkController=d.SelectedNetworkController,this.snapController=d.SnapController,this.snapInsightsController=d.SnapInsightsController,this.snapInterfaceController=d.SnapInterfaceController,this.snapsRegistry=d.SnapsRegistry,this.ppomController=d.PPOMController,this.phishingController=d.PhishingController,this.onboardingController=d.OnboardingController,this.accountTrackerController=d.AccountTrackerController,this.txController=d.TransactionController,this.smartTransactionsController=d.SmartTransactionsController,this.swapsController=d.SwapsController,this.bridgeController=d.BridgeController,this.bridgeStatusController=d.BridgeStatusController,this.backendWebSocketService=d.BackendWebSocketService,this.accountActivityService=d.AccountActivityService,this.nftController=d.NftController,this.nftDetectionController=d.NftDetectionController,this.assetsContractController=d.AssetsContractController,this.multichainAssetsController=d.MultichainAssetsController,this.multichainBalancesController=d.MultichainBalancesController,this.multichainTransactionsController=d.MultichainTransactionsController,this.multichainAssetsRatesController=d.MultichainAssetsRatesController,this.multichainAccountService=d.MultichainAccountService,this.tokenBalancesController=d.TokenBalancesController,this.staticAssetsController=d.StaticAssetsController,this.tokenListController=d.TokenListController,this.tokenDetectionController=d.TokenDetectionController,this.tokensController=d.TokensController,this.tokenRatesController=d.TokenRatesController,this.currencyRateController=d.CurrencyRateController,this.multichainNetworkController=d.MultichainNetworkController,this.multichainRatesController=d.RatesController,this.authenticationController=d.AuthenticationController,this.userStorageController=d.UserStorageController,this.delegationController=d.DelegationController,this.notificationServicesController=d.NotificationServicesController,this.notificationServicesPushController=d.NotificationServicesPushController,this.deFiPositionsController=d.DeFiPositionsController,this.accountTreeController=d.AccountTreeController,this.oauthService=d.OAuthService,this.subscriptionService=d.SubscriptionService,this.seedlessOnboardingController=d.SeedlessOnboardingController,this.subscriptionController=d.SubscriptionController,this.networkOrderController=d.NetworkOrderController,this.networkEnablementController=d.NetworkEnablementController,this.shieldController=d.ShieldController,this.gatorPermissionsController=d.GatorPermissionsController,this.ensController=d.EnsController,this.nameController=d.NameController,this.announcementController=d.AnnouncementController,this.accountOrderController=d.AccountOrderController,this.rewardsController=d.RewardsController,this.claimsController=d.ClaimsController,this.claimsService=d.ClaimsService,this.profileMetricsController=d.ProfileMetricsController,this.backup=new Ze.default({preferencesController:this.preferencesController,addressBookController:this.addressBookController,accountsController:this.accountsController,networkController:this.networkController,trackMetaMetricsEvent:this.controllerMessenger.call.bind(this.controllerMessenger,"MetaMetricsController:trackEvent")}),this.appMetadataController.maybeRecordFirstTimeInfo(i),this.provider=this.networkController.getProviderAndBlockTracker().provider,this.blockTracker=this.networkController.getProviderAndBlockTracker().blockTracker,this.on("update",e=>{this.metaMetricsController.handleMetaMaskStateUpdate(e)}),this.controllerMessenger.subscribe("KeyringController:unlock",()=>this._onUnlock()),this.controllerMessenger.subscribe("KeyringController:lock",()=>this._onLock()),this.controllerMessenger.subscribe("SubscriptionController:stateChange",e=>{const{useExternalServices:t}=this.preferencesController.state;if(!t)return;(0,Oe.getIsShieldSubscriptionActive)(e.subscriptions)?(this.claimsController.fetchClaimsConfigurations().catch(e=>{y.default.error("Error fetching claims configurations",e)}),(0,_e.updatePreferencesAndMetricsForShieldSubscription)(this.metaMetricsController,this.preferencesController),this.shieldController.start()):this.shieldController.stop()});const p=new A.Messenger({namespace:"PetnamesBridge",parent:this.controllerMessenger});this.controllerMessenger.delegate({messenger:p,events:["NameController:stateChange","AccountsController:stateChange","AddressBookController:stateChange"],actions:["AccountsController:listAccounts"]}),new Fe.AddressBookPetnamesBridge({addressBookController:this.addressBookController,nameController:this.nameController,messenger:p}).init(),new xe.AccountIdentitiesPetnamesBridge({nameController:this.nameController,messenger:p}).init();const h=new A.Messenger({namespace:"WalletFundsObtainedMonitor",parent:this.controllerMessenger});this.controllerMessenger.delegate({messenger:h,events:["NotificationServicesController:notificationsListUpdated"],actions:["MetaMetricsController:trackEvent","AppStateController:setCanTrackWalletFundsObtained","OnboardingController:getState","NotificationServicesController:getState","TokenBalancesController:getState","MultichainBalancesController:getState"]}),this.walletFundsObtainedMonitor=new je.WalletFundsObtainedMonitor({messenger:h}),this.getSecurityAlertsConfig=async e=>(0,_e.getShieldGatewayConfig)(()=>this.controllerMessenger.call("AuthenticationController:getBearerToken"),()=>this.controllerMessenger.call("SubscriptionController:getSubscriptionByProduct",H.PRODUCT_TYPES.SHIELD),e),this.notificationServicesController.init(),this.snapController.init(),this.cronjobController.init(),this.controllerMessenger.subscribe("TransactionController:transactionStatusUpdated",({transactionMeta:e})=>{this._onFinishedTransaction(e)}),this.controllerMessenger.subscribe("TransactionController:transactionSubmitted",({transactionMeta:e})=>{this.subscriptionService.handlePostTransaction(e).catch(e=>{console.error("Error onShieldSubscriptionApprovalTransaction",e)})}),this.controllerMessenger.subscribe("OnboardingController:stateChange",(0,tt.previousValueComparator)(async(e,t)=>{const{completedOnboarding:r}=e,{completedOnboarding:n,firstTimeFlowType:i}=t;if(!r&&n){const{address:e}=this.accountsController.getSelectedAccount();this.isMultichainAccountsFeatureState2Enabled()&&(await this.getSnapKeyring(),await this.accountTreeController.syncWithUserStorageAtLeastOnce()),i===Ae.FirstTimeFlowType.socialImport?await this._importAccountsWithBalances():this.isMultichainAccountsFeatureState2Enabled()?await this.discoverAndCreateAccounts():await this._addAccountsWithBalance(),this.postOnboardingInitialization(),this.triggerNetworkrequests(),await this.tokenDetectionController.detectTokens({selectedAddress:e})}},this.onboardingController.state));const m=({origin:e})=>{if(e===re.ORIGIN_METAMASK){const e=this.accountsController.getSelectedAccount().address;return e?[e]:[]}return this.getPermittedAccounts(e)};this.eip5792Middleware=(0,s.createScaffoldMiddleware)({wallet_getCapabilities:(0,s.createAsyncMiddleware)(async(e,t)=>(0,L.walletGetCapabilities)(e,t,{getAccounts:m,getCapabilities:L.getCapabilities.bind(null,{getDismissSmartAccountSuggestionEnabled:()=>this.preferencesController.state.preferences.dismissSmartAccountSuggestionEnabled,getIsSmartTransaction:e=>(0,he.getIsSmartTransaction)(this._getMetaMaskState(),e),isAtomicBatchSupported:this.txController.isAtomicBatchSupported.bind(this.txController),isRelaySupported:Dt.isRelaySupported,getSendBundleSupportedChains:Lt.getSendBundleSupportedChains,isAuxiliaryFundsSupported:e=>ve.ALLOWED_BRIDGE_CHAIN_IDS.includes(e)},this.controllerMessenger)})),wallet_sendCalls:(0,s.createAsyncMiddleware)(async(e,t)=>await(0,L.walletSendCalls)(e,t,{getAccounts:m,processSendCalls:L.processSendCalls.bind(null,{addTransaction:this.txController.addTransaction.bind(this.txController),addTransactionBatch:this.txController.addTransactionBatch.bind(this.txController),getDismissSmartAccountSuggestionEnabled:()=>this.preferencesController.state.preferences.dismissSmartAccountSuggestionEnabled,isAtomicBatchSupported:this.txController.isAtomicBatchSupported.bind(this.txController),validateSecurity:(e,t,r)=>(0,dt.validateRequestWithPPOM)({chainId:r,ppomController:this.ppomController,request:t,securityAlertId:e,updateSecurityAlertResponse:this.updateSecurityAlertResponse.bind(this),getSecurityAlertsConfig:this.getSecurityAlertsConfig.bind(this)}),isAuxiliaryFundsSupported:e=>ve.ALLOWED_BRIDGE_CHAIN_IDS.includes(e)},this.controllerMessenger)})),wallet_getCallsStatus:(0,s.createAsyncMiddleware)(async(e,t)=>(0,L.walletGetCallsStatus)(e,t,{getCallsStatus:L.getCallsStatus.bind(null,this.controllerMessenger)}))});const C={isBlocked:!1},b=(0,Ve.default)({state:C,allowedOrigins:["npm:@metamask/gator-permissions-snap","npm:@metamask/permissions-kernel-snap"],errorMessage:"Cannot process requests while a wallet_requestExecutionPermissions request is in process"});this.eip7715BlockingMiddleware=b,this.eip7702Middleware=(0,s.createScaffoldMiddleware)({wallet_upgradeAccount:(0,s.createAsyncMiddleware)(async(e,t)=>{await(0,G.walletUpgradeAccount)(e,t,{upgradeAccount:this.upgradeAccount.bind(this),getCurrentChainIdForDomain:this.getCurrentChainIdForDomain.bind(this),isEip7702Supported:this.isEip7702Supported.bind(this),getPermittedAccountsForOrigin:async()=>m({origin:e.origin})})}),wallet_getAccountUpgradeStatus:(0,s.createAsyncMiddleware)(async(e,t)=>{await(0,G.walletGetAccountUpgradeStatus)(e,t,{getCurrentChainIdForDomain:this.getCurrentChainIdForDomain.bind(this),getCode:this.getCode.bind(this),getSelectedNetworkClientIdForChain:this.getSelectedNetworkClientIdForChain.bind(this),getPermittedAccountsForOrigin:async()=>m({origin:e.origin}),isEip7702Supported:this.isEip7702Supported.bind(this)})})}),this.metamaskMiddleware=(0,rt.default)({static:{eth_syncing:!1,web3_clientVersion:`MetaMask/v${i}`},version:i,getAccounts:e=>m({origin:e}),processTransaction:(e,t,r)=>(0,at.addDappTransaction)(this.getAddTransactionRequest({transactionParams:e,dappRequest:t,requestContext:r})),processTypedMessage:(...e)=>(0,lt.addTypedMessage)({signatureController:this.signatureController,signatureParams:e}),processTypedMessageV3:(...e)=>(0,lt.addTypedMessage)({signatureController:this.signatureController,signatureParams:e}),processTypedMessageV4:(...e)=>(0,lt.addTypedMessage)({signatureController:this.signatureController,signatureParams:e}),processPersonalMessage:(...e)=>(0,lt.addPersonalMessage)({signatureController:this.signatureController,signatureParams:e}),processEncryptionPublicKey:this.encryptionPublicKeyController.newRequestEncryptionPublicKey.bind(this.encryptionPublicKeyController),processDecryptMessage:this.decryptMessageController.newRequestDecryptMessage.bind(this.decryptMessageController),getPendingNonce:this.getPendingNonce.bind(this),getPendingTransactionByHash:e=>this.txController.state.transactions.find(t=>t.hash===e&&t.status===R.TransactionStatus.submitted),processRequestExecutionPermissions:async(e,t,r)=>{const n=(0,Pe.getEnabledAdvancedPermissions)();if(!e||0===e.length)throw g.rpcErrors.methodNotSupported("No permission type provided");for(const t of e){var i;const e=null==t||null===(i=t.permission)||void 0===i?void 0:i.type;if(!n.includes(e))throw g.rpcErrors.methodNotSupported(`Permission type '${e??"unknown"}' is not enabled`)}return(0,$t.forwardRequestToSnap)({snapId:"npm:@metamask/permissions-kernel-snap",handleRequest:this.handleSnapRequest.bind(this),onBeforeRequest:()=>{C.isBlocked=!0},onAfterRequest:()=>{C.isBlocked=!1}},e,t,r)},processGetSupportedExecutionPermissions:async(e,t)=>{const r=(0,Pe.getEnabledAdvancedPermissions)(),n=await(0,$t.forwardRequestToSnap)({snapId:"npm:@metamask/permissions-kernel-snap",handleRequest:this.handleSnapRequest.bind(this)},[],e,t);return n&&"object"==typeof n?Object.fromEntries(Object.entries(n).filter(([e])=>r.includes(e))):n},processGetGrantedExecutionPermissions:async(e,t)=>(0,$t.forwardRequestToSnap)({snapId:"npm:@metamask/permissions-kernel-snap",handleRequest:this.handleSnapRequest.bind(this)},[],e,t)}),this.on("update",e=>this._onStateUpdate(e));const v={AccountTracker:this.accountTrackerController,TokenRatesController:this.tokenRatesController,DecryptMessageController:this.decryptMessageController,EncryptionPublicKeyController:this.encryptionPublicKeyController,SignatureController:this.signatureController,SwapsController:this.swapsController,BridgeController:this.bridgeController,BridgeStatusController:this.bridgeStatusController,EnsController:this.ensController,ApprovalController:this.approvalController};this.store.updateStructure({AccountsController:this.accountsController,AppStateController:this.appStateController,AppMetadataController:this.appMetadataController,KeyringController:this.keyringController,PreferencesController:this.preferencesController,MetaMetricsController:this.metaMetricsController,MetaMetricsDataDeletionController:this.metaMetricsDataDeletionController,AddressBookController:this.addressBookController,CurrencyController:this.currencyRateController,MultichainNetworkController:this.multichainNetworkController,NetworkController:this.networkController,AlertController:this.alertController,OnboardingController:this.onboardingController,SeedlessOnboardingController:this.seedlessOnboardingController,PermissionController:this.permissionController,PermissionLogController:this.permissionLogController,SubjectMetadataController:this.subjectMetadataController,AnnouncementController:this.announcementController,NetworkOrderController:this.networkOrderController,NetworkEnablementController:this.networkEnablementController,AccountOrderController:this.accountOrderController,GasFeeController:this.gasFeeController,GatorPermissionsController:this.gatorPermissionsController,TokenListController:this.tokenListController,TokensController:this.tokensController,TokenBalancesController:this.tokenBalancesController,StaticAssetsController:this.staticAssetsController,SmartTransactionsController:this.smartTransactionsController,NftController:this.nftController,PhishingController:this.phishingController,SelectedNetworkController:this.selectedNetworkController,LoggingController:this.loggingController,MultichainRatesController:this.multichainRatesController,NameController:this.nameController,UserOperationController:this.userOperationController,AuthenticationController:this.authenticationController,UserStorageController:this.userStorageController,NotificationServicesController:this.notificationServicesController,NotificationServicesPushController:this.notificationServicesPushController,RemoteFeatureFlagController:this.remoteFeatureFlagController,DeFiPositionsController:this.deFiPositionsController,ProfileMetricsController:this.profileMetricsController,...v,...c}),this.memStore=new Ke.default({config:{AccountsController:this.accountsController,AppStateController:this.appStateController,AppMetadataController:this.appMetadataController,MultichainAssetsController:this.multichainAssetsController,MultichainBalancesController:this.multichainBalancesController,MultichainTransactionsController:this.multichainTransactionsController,MultichainAssetsRatesController:this.multichainAssetsRatesController,TokenRatesController:this.tokenRatesController,MultichainNetworkController:this.multichainNetworkController,NetworkController:this.networkController,KeyringController:this.keyringController,PreferencesController:this.preferencesController,MetaMetricsController:this.metaMetricsController,MetaMetricsDataDeletionController:this.metaMetricsDataDeletionController,AddressBookController:this.addressBookController,CurrencyController:this.currencyRateController,AlertController:this.alertController,OnboardingController:this.onboardingController,SeedlessOnboardingController:this.seedlessOnboardingController,SubscriptionController:this.subscriptionController,PermissionController:this.permissionController,PermissionLogController:this.permissionLogController,SubjectMetadataController:this.subjectMetadataController,AnnouncementController:this.announcementController,NetworkOrderController:this.networkOrderController,NetworkEnablementController:this.networkEnablementController,AccountOrderController:this.accountOrderController,GasFeeController:this.gasFeeController,TokenListController:this.tokenListController,TokensController:this.tokensController,TokenBalancesController:this.tokenBalancesController,StaticAssetsController:this.staticAssetsController,SmartTransactionsController:this.smartTransactionsController,NftController:this.nftController,SelectedNetworkController:this.selectedNetworkController,LoggingController:this.loggingController,MultichainRatesController:this.multichainRatesController,SnapController:this.snapController,CronjobController:this.cronjobController,SnapsRegistry:this.snapsRegistry,SnapInterfaceController:this.snapInterfaceController,SnapInsightsController:this.snapInsightsController,NameController:this.nameController,UserOperationController:this.userOperationController,AuthenticationController:this.authenticationController,UserStorageController:this.userStorageController,NotificationServicesController:this.notificationServicesController,NotificationServicesPushController:this.notificationServicesPushController,RemoteFeatureFlagController:this.remoteFeatureFlagController,DeFiPositionsController:this.deFiPositionsController,PhishingController:this.phishingController,ShieldController:this.shieldController,ClaimsController:this.claimsController,ClaimsService:this.claimsService,ProfileMetricsController:this.profileMetricsController,...v,...l},controllerMessenger:this.controllerMessenger});const w=[this.decryptMessageController.resetState.bind(this.decryptMessageController),this.encryptionPublicKeyController.resetState.bind(this.encryptionPublicKeyController),this.signatureController.resetState.bind(this.signatureController),this.swapsController.resetState.bind(this.swapsController),this.bridgeController.resetState.bind(this.bridgeController),this.ensController.resetState.bind(this.ensController),this.approvalController.clear.bind(this.approvalController)];ue.isManifestV3?!0===t&&(this.resetStates(w),this.extension.storage.session.set({isFirstMetaMaskControllerSetup:!1})):this.resetStates(w);!this.isUnlocked()&&this.onboardingController.state.completedOnboarding,this._startUISync(),this.extension.runtime.getPlatformInfo().then(({os:e})=>{this.appStateController.setBrowserEnvironment(e,this.extension.runtime.getBrowserInfo===undefined?"chrome":"firefox")}),this.setupControllerEventSubscriptions(),this.setupMultichainDataAndSubscriptions(),this.publicConfigStore=this.createPublicConfigStore(),this.extension.runtime.onMessageExternal.addListener(Ge.onMessageReceived),(0,Ge.checkForMultipleVersionsRunning)(),this.onboardingController.state.completedOnboarding&&this.postOnboardingInitialization()}getCurrentChainIdForDomain(e){const t=this.selectedNetworkController.getNetworkClientIdForDomain(e),r=this.networkController.getNetworkConfigurationByNetworkClientId(t);return r?r.chainId:(y.default.warn(`No network configuration found for clientId: ${t}`),undefined)}getSelectedNetworkClientIdForChain(e){const t=this.networkController.getNetworkConfigurationByChainId(e);if(!t)return null;const{rpcEndpoints:r,defaultRpcEndpointIndex:n}=t;return!r||n===undefined||n<0||n>=r.length?null:r[n].networkClientId}getInfuraFeatureFlags(){(0,Ce.default)({url:"https://bridge.api.cx.metamask.io/featureFlags",cacheRefreshTime:20*te.MINUTE}).then(this.onFeatureFlagResponseReceived).catch(e=>{y.default.warn("Feature flag endpoint is unreachable",e)})}onFeatureFlagResponseReceived(e){const{multiChainAssets:t={}}=e,{pollInterval:r}=t;r>0&&this.tokenBalancesController.setIntervalLength(r*te.SECOND)}isMultichainAccountsFeatureState2Enabled(){var e;const t=null===(e=this.remoteFeatureFlagController)||void 0===e||null===(e=e.state)||void 0===e||null===(e=e.remoteFeatureFlags)||void 0===e?void 0:e.enableMultichainAccountsState2;return(0,z.isMultichainAccountsFeatureEnabled)(t,z.FEATURE_VERSION_2)}postOnboardingInitialization(){const{usePhishDetect:e}=this.preferencesController.state;e&&this.phishingController.maybeUpdateState(),((0,tt.getBooleanFlag)("true")||Object.values(this.snapController.state.snaps).some(e=>!e.preinstalled))&&this.snapController.updateRegistry().catch(e=>{e.message.includes("The Snaps platform requires basic functionality to be used.")||console.error(e)})}async lookupSelectedNetworks(){const e=(0,fe.selectAllEnabledNetworkClientIds)(this._getMetaMaskState());await Promise.allSettled([this.networkController.lookupNetwork(),...e.map(async e=>await this.networkController.lookupNetwork(e))])}triggerNetworkrequests(){this.tokenDetectionController.enable(),this.getInfuraFeatureFlags(),(0,F.isEvmAccountType)(this.accountsController.getSelectedMultichainAccount().type)||this.multichainRatesController.start()}stopNetworkRequests(){this.txController.stopIncomingTransactionPolling(),this.tokenDetectionController.disable(),this.multichainRatesController.stop()}resetStates(e){e.forEach(e=>{try{e()}catch(e){console.error(e)}})}async getSnapKeyring(){let[e]=this.keyringController.getKeyringsByType(Z.KeyringType.snap);return e||(await this.keyringController.addNewKeyring(Z.KeyringType.snap),[e]=this.keyringController.getKeyringsByType(Z.KeyringType.snap)),e}getSnapKeyringIfAvailable(){if(this.keyringController.isUnlocked()){const[e]=this.keyringController.getKeyringsByType(Z.KeyringType.snap);return e}return undefined}async forwardSelectedAccountGroupToSnapKeyring(e,t){if(e&&t){const r=this.accountTreeController.getAccountGroupObject(t);if(r){r.accounts.some(e=>{const t=this.accountsController.getAccount(e);return Boolean(t)&&!(0,F.isEvmAccountType)(t.type)})&&await e.setSelectedAccounts(r.accounts)}}}trackInsightSnapView(e){this.metaMetricsController.trackEvent({event:ne.MetaMetricsEventName.InsightSnapViewed,category:ne.MetaMetricsEventCategory.Snaps,properties:{snap_id:e}})}_getSnapMetadata(e){var t;return null===(t=this.snapsRegistry.state.database)||void 0===t||null===(t=t.verifiedSnaps)||void 0===t||null===(t=t[e])||void 0===t?void 0:t.metadata}async handleSnapRequest(e){return await this.controllerMessenger.call("SnapController:handleRequest",e)}setupControllerEventSubscriptions(){let e;const t={};be.NON_EVM_ACCOUNT_CHANGED_CONFIGS.forEach(({network:e})=>{try{var r;t[e]=null===(r=this.accountsController.getSelectedMultichainAccount(e))||void 0===r?void 0:r.address}catch(t){const r=new Error(`Failed to get selected multichain account for network: ${e}`,{cause:t});(0,X.captureException)(r)}}),this.controllerMessenger.subscribe("PreferencesController:stateChange",(0,tt.previousValueComparator)(async(e,t)=>{const{currentLocale:r}=t;await(0,Me.updateCurrentLocale)(r)},this.preferencesController.state)),this.controllerMessenger.subscribe(`${this.accountsController.name}:selectedAccountChange`,async t=>{t.address&&t.address!==e&&(e=t.address,await this._onAccountChange(t.address))}),this.controllerMessenger.subscribe("BridgeStatusController:destinationTransactionCompleted",e=>{const{chain:t}=(0,x.parseCaipAssetType)(e);if(t.namespace===x.KnownCaipNamespace.Eip155){const e=(0,I.toHex)(null==t?void 0:t.reference);e&&this.tokenDetectionController.detectTokens({chainIds:[e]}).catch(e=>{y.default.error("Error detecting tokens",{err:e})})}}),this.controllerMessenger.subscribe(`${this.permissionController.name}:stateChange`,async(e,t)=>{const r=(0,it.diffMap)(e,t);for(const[e,t]of r.entries())this._notifyAccountsChange(e,t)},it.getPermittedAccountsByOrigin),this.controllerMessenger.subscribe(`${this.permissionController.name}:stateChange`,async(e,t)=>{const r=(0,it.getChangedAuthorizations)(e,t),n=(0,it.getRemovedAuthorizations)(e,t);for(const[e,t]of n.entries()){const r=(0,K.getSessionScopes)(t,{getNonEvmSupportedMethods:this.getNonEvmSupportedMethods.bind(this)});Object.entries(r).forEach(([t,r])=>{r.notifications.includes("eth_subscription")&&r.methods.includes("eth_subscribe")&&this.removeMultichainApiEthSubscriptionMiddleware({scope:t,origin:e})})}for(const[e,t]of r.entries()){const r=(0,K.getSessionScopes)(t,{getNonEvmSupportedMethods:this.getNonEvmSupportedMethods.bind(this)});Object.entries(r).forEach(([t,r])=>{r.notifications.includes("eth_subscription")&&r.methods.includes("eth_subscribe")?Object.values(this.connections[e]??{}).forEach(({tabId:r})=>{this.addMultichainApiEthSubscriptionMiddleware({scope:t,origin:e,tabId:r})}):this.removeMultichainApiEthSubscriptionMiddleware({scope:t,origin:e})}),this._notifyAuthorizationChange(e,t)}},it.getAuthorizedScopesByOrigin),this.controllerMessenger.subscribe(`${this.permissionController.name}:stateChange`,async(e,t)=>{const r=(0,u.uniq)([...t.keys(),...e.keys()]);be.NON_EVM_ACCOUNT_CHANGED_CONFIGS.forEach(({chains:n,notificationProperty:i,network:o})=>{r.forEach(r=>{var s,a;const l=t.get(r),c=e.get(r);if(!(Boolean(null==l||null===(s=l.sessionProperties)||void 0===s?void 0:s[i])||Boolean(null==c||null===(a=c.sessionProperties)||void 0===a?void 0:a[i])))return;const d=this._getSelectedMultichainAccountAddress(l,n),u=this._getSelectedMultichainAccountAddress(c,n);d!==u&&this._notifyMultichainAccountChange(r,u?[u]:[],o)})})},it.getAuthorizedScopesByOrigin),this.controllerMessenger.subscribe(`${this.accountTreeController.name}:selectedAccountGroupChange`,e=>{this.forwardSelectedAccountGroupToSnapKeyring(this.getSnapKeyringIfAvailable(),e),be.NON_EVM_ACCOUNT_CHANGED_CONFIGS.forEach(({network:e,accountType:r,notificationProperty:n,chains:i})=>{const[o]=this.accountTreeController.getAccountsFromSelectedAccountGroup({scopes:[e],type:r}),s=t[e];if(!o||o.type!==r||o.address===s)return;t[e]=o.address;const a=(0,it.getOriginsWithSessionProperty)(this.permissionController.state,n),l=(0,it.getPermittedAccountsForScopesByOrigin)(this.permissionController.state,i);for(const[t,r]of l.entries()){r.map(e=>{const{address:t}=(0,x.parseCaipAccountId)(e);return t}).includes(o.address)&&a[t]&&this._notifyMultichainAccountChange(t,[o.address],e)}})}),this.controllerMessenger.subscribe(`${this.multichainAccountService.name}:multichainAccountGroupUpdated`,e=>{this.accountTreeController.getSelectedAccountGroup()===e.id&&this.forwardSelectedAccountGroupToSnapKeyring(this.getSnapKeyringIfAvailable(),e.id)}),this.controllerMessenger.subscribe(`${this.permissionController.name}:stateChange`,async(e,t)=>{const r=(0,it.diffMap)(e,t);for(const[e,t]of r.entries()){const r=this.selectedNetworkController.getNetworkClientIdForDomain(e),n=this.networkController.getNetworkConfigurationByNetworkClientId(r);if(!n){y.default.warn(`No network configuration found for clientId: ${r}`);continue}const{chainId:i}=n;if(t.length>0&&!t.includes(i)){const r=this.networkController.findNetworkClientIdByChainId(t[0]);(0,W.isSnapId)(e)||this.networkController.setActiveNetwork(r),this.selectedNetworkController.setNetworkClientIdForDomain(e,r)}}},it.getPermittedChainsByOrigin),this.controllerMessenger.subscribe("NetworkController:networkRemoved",({chainId:e})=>{const t=(0,x.toCaipChainId)("eip155",(0,x.hexToBigInt)(e).toString(10));this.removeAllScopePermissions(t)}),this.controllerMessenger.subscribe(`${this.snapController.name}:snapInstallStarted`,(e,t,r)=>{var n;const i=null===(n=this._getSnapMetadata(e))||void 0===n?void 0:n.category;this.metaMetricsController.trackEvent({event:r?ne.MetaMetricsEventName.SnapUpdateStarted:ne.MetaMetricsEventName.SnapInstallStarted,category:ne.MetaMetricsEventCategory.Snaps,properties:{snap_id:e,origin:t,snap_category:i}})}),this.controllerMessenger.subscribe(`${this.snapController.name}:snapInstallFailed`,(e,t,r,n)=>{var i;const o=n.includes("User rejected the request."),s=r?ne.MetaMetricsEventName.SnapUpdateFailed:ne.MetaMetricsEventName.SnapInstallFailed,a=r?ne.MetaMetricsEventName.SnapUpdateRejected:ne.MetaMetricsEventName.SnapInstallRejected,l=null===(i=this._getSnapMetadata(e))||void 0===i?void 0:i.category;this.metaMetricsController.trackEvent({event:o?a:s,category:ne.MetaMetricsEventCategory.Snaps,properties:{snap_id:e,origin:t,snap_category:l}})}),this.controllerMessenger.subscribe(`${this.snapController.name}:snapInstalled`,(e,t,r)=>{var n;if(r)return;const i=e.id,o=null===(n=this._getSnapMetadata(i))||void 0===n?void 0:n.category;this.metaMetricsController.trackEvent({event:ne.MetaMetricsEventName.SnapInstalled,category:ne.MetaMetricsEventCategory.Snaps,properties:{snap_id:i,version:e.version,origin:t,snap_category:o}})}),this.controllerMessenger.subscribe(`${this.snapController.name}:snapUpdated`,(e,t,r,n)=>{var i;if(n)return;const o=e.id,s=null===(i=this._getSnapMetadata(o))||void 0===i?void 0:i.category;this.metaMetricsController.trackEvent({event:ne.MetaMetricsEventName.SnapUpdated,category:ne.MetaMetricsEventCategory.Snaps,properties:{snap_id:o,old_version:t,new_version:e.version,origin:r,snap_category:s}})}),this.controllerMessenger.subscribe(`${this.snapController.name}:snapTerminated`,e=>{const t=Object.values(this.approvalController.state.pendingApprovals).filter(t=>t.origin===e.id&&t.type.startsWith(ee.RestrictedMethods.snap_dialog));for(const e of t)this.approvalController.reject(e.id,new Error("Snap was terminated."))}),this.controllerMessenger.subscribe(`${this.snapController.name}:snapUninstalled`,e=>{var t;const r=this.notificationServicesController.getNotificationsByType(B.TRIGGER_TYPES.SNAP).filter(t=>t.data.origin===e.id).map(e=>e.id);this.notificationServicesController.deleteNotificationsById(r);const n=e.id,i=null===(t=this._getSnapMetadata(n))||void 0===t?void 0:t.category;this.metaMetricsController.trackEvent({event:ne.MetaMetricsEventName.SnapUninstalled,category:ne.MetaMetricsEventCategory.Snaps,properties:{snap_id:n,version:e.version,snap_category:i}})})}setupMultichainDataAndSubscriptions(){this.controllerMessenger.subscribe("AccountsController:selectedAccountChange",e=>{0===this.activeControllerConnections||(0,F.isEvmAccountType)(e.type)?this.multichainRatesController.stop():this.multichainRatesController.start()}),this.controllerMessenger.subscribe("CurrencyRateController:stateChange",({currentCurrency:e})=>{e!==this.multichainRatesController.state.fiatCurrency&&this.multichainRatesController.setFiatCurrency(e)})}addMultichainApiEthSubscriptionMiddleware({scope:e,origin:t,tabId:r}){const n=this.multichainSubscriptionManager.subscribe({scope:e,origin:t,tabId:r});this.multichainMiddlewareManager.addMiddleware({scope:e,origin:t,tabId:r,middleware:n.middleware})}removeMultichainApiEthSubscriptionMiddleware({scope:e,origin:t}){this.multichainMiddlewareManager.removeMiddlewareByScopeAndOrigin(e,t),this.multichainSubscriptionManager.unsubscribeByScopeAndOrigin(e,t)}createPublicConfigStore(){const e=new l.ObservableStore,t=async({isUnlocked:e})=>{const{chainId:t,networkVersion:r,isConnected:n}=await this.getProviderNetworkState();return{isUnlocked:e,chainId:t,networkVersion:n?r:"loading"}},r=async r=>{var n;(null===(n=r.networksMetadata[r.selectedNetworkClientId])||void 0===n?void 0:n.status)===J.NetworkStatus.Available&&e.putState(await t(r))};return this.on("update",r),r(this.getState()),e}async getProviderState(e,{isInitializingStreamProvider:t=!1}={}){const r=await this.getProviderNetworkState({origin:e,isInitializingStreamProvider:t}),n={};if(ue.isManifestV3){var i;const{chrome:e}=globalThis;n.extensionId=null==e||null===(i=e.runtime)||void 0===i?void 0:i.id}return{isUnlocked:!0,accounts:this.getPermittedAccounts(e),...n,...r}}async getProviderNetworkState({origin:e=P.METAMASK_DOMAIN,isInitializingStreamProvider:t=!1}={}){const r=this.controllerMessenger.call("SelectedNetworkController:getNetworkClientIdForDomain",e),n=this.controllerMessenger.call("NetworkController:getNetworkClientById",r),{chainId:i}=n.configuration,{completedOnboarding:o}=this.onboardingController.state;let s=this.deprecatedNetworkVersions[r];if(s===undefined&&o&&!t){try{const e=await n.provider.request({method:"net_version"});s=(0,pe.convertNetworkId)(e)}catch(e){console.error(e),s=null}this.deprecatedNetworkVersions[r]=s}const a=this.networkController.state.networksMetadata[r];return{chainId:i,networkVersion:s??"loading",isConnected:(null==a?void 0:a.status)===J.NetworkStatus.Available}}getState(){const{vault:e}=this.keyringController.state,t=Boolean(e),r=this.memStore.getFlatState();return{isInitialized:t,...(0,ft.sanitizeUIState)(r)}}async _addNetworkAndSetActive(e){var t;const r=await this.networkController.addNetwork(e),{networkClientId:n}=(null==r||null===(t=r.rpcEndpoints)||void 0===t?void 0:t[r.defaultRpcEndpointIndex])??{};return await this.networkController.setActiveNetwork(n),r}getApi(){const{accountsController:e,addressBookController:t,alertController:r,appStateController:n,nftController:i,nftDetectionController:o,currencyRateController:s,tokenBalancesController:a,tokenDetectionController:l,ensController:c,tokenListController:d,gasFeeController:u,gatorPermissionsController:p,metaMetricsController:h,networkController:m,multichainNetworkController:g,announcementController:f,onboardingController:y,permissionController:C,preferencesController:b,tokensController:v,smartTransactionsController:w,txController:S,backup:T,approvalController:k,phishingController:A,tokenRatesController:M,authenticationController:P,userStorageController:E,notificationServicesController:I,notificationServicesPushController:_,deFiPositionsController:R,multichainAssetsRatesController:N,staticAssetsController:D}=this;return{setCurrentCurrency:s.setCurrentCurrency.bind(s),setUseBlockie:b.setUseBlockie.bind(b),setAvatarType:e=>b.setPreference("avatarType",e),setUsePhishDetect:b.setUsePhishDetect.bind(b),setUseMultiAccountBalanceChecker:b.setUseMultiAccountBalanceChecker.bind(b),setUseSafeChainsListValidation:b.setUseSafeChainsListValidation.bind(b),setUseTokenDetection:b.setUseTokenDetection.bind(b),setUseNftDetection:b.setUseNftDetection.bind(b),setUse4ByteResolution:b.setUse4ByteResolution.bind(b),setUseCurrencyRateCheck:b.setUseCurrencyRateCheck.bind(b),setOpenSeaEnabled:b.setOpenSeaEnabled.bind(b),getProviderConfig:()=>(0,ge.getProviderConfig)({metamask:this.networkController.state}),isPublicEndpointUrl:e=>(0,tt.isPublicEndpointUrl)(e,this.opts.infuraProjectId),grantPermissionsIncremental:this.permissionController.grantPermissionsIncremental.bind(this.permissionController),grantPermissions:this.permissionController.grantPermissions.bind(this.permissionController),setSecurityAlertsEnabled:b.setSecurityAlertsEnabled.bind(b),setAddSnapAccountEnabled:b.setAddSnapAccountEnabled.bind(b),setUseExternalNameSources:b.setUseExternalNameSources.bind(b),setUseTransactionSimulations:b.setUseTransactionSimulations.bind(b),setIpfsGateway:b.setIpfsGateway.bind(b),setIsIpfsGatewayEnabled:b.setIsIpfsGatewayEnabled.bind(b),setUseAddressBarEnsResolution:b.setUseAddressBarEnsResolution.bind(b),setParticipateInMetaMetrics:h.setParticipateInMetaMetrics.bind(h),setDataCollectionForMarketing:h.setDataCollectionForMarketing.bind(h),setMarketingCampaignCookieId:h.setMarketingCampaignCookieId.bind(h),setCurrentLocale:b.setCurrentLocale.bind(b),setServiceWorkerKeepAlivePreference:b.setServiceWorkerKeepAlivePreference.bind(b),markPasswordForgotten:this.markPasswordForgotten.bind(this),unMarkPasswordForgotten:this.unMarkPasswordForgotten.bind(this),getRequestAccountTabIds:this.getRequestAccountTabIds,getOpenMetamaskTabsIds:this.getOpenMetamaskTabsIds,markNotificationPopupAsAutomaticallyClosed:()=>this.notificationManager.markAsAutomaticallyClosed(),getCode:this.getCode.bind(this),addNewAccount:this.addNewAccount.bind(this),getSeedPhrase:this.getSeedPhrase.bind(this),resetAccount:this.resetAccount.bind(this),removeAccount:this.removeAccount.bind(this),importAccountWithStrategy:this.importAccountWithStrategy.bind(this),getNextAvailableAccountName:e.getNextAvailableAccountName.bind(e),getAccountsBySnapId:e=>(0,st.getAccountsBySnapId)(this.getSnapKeyring.bind(this),e),checkIsSeedlessPasswordOutdated:this.checkIsSeedlessPasswordOutdated.bind(this),syncPasswordAndUnlockWallet:this.syncPasswordAndUnlockWallet.bind(this),subscriptionsStartPolling:this.subscriptionController.startPolling.bind(this.subscriptionController),getSubscriptionsEligibilities:this.subscriptionController.getSubscriptionsEligibilities.bind(this.subscriptionController),assignUserToCohort:this.subscriptionController.assignUserToCohort.bind(this.subscriptionController),getSubscriptions:this.subscriptionController.getSubscriptions.bind(this.subscriptionController),getSubscriptionPricing:this.subscriptionController.getPricing.bind(this.subscriptionController),cacheLastSelectedPaymentMethod:this.subscriptionController.cacheLastSelectedPaymentMethod.bind(this.subscriptionController),getSubscriptionCryptoApprovalAmount:this.subscriptionController.getCryptoApproveTransactionParams.bind(this.subscriptionController),cancelSubscription:this.subscriptionController.cancelSubscription.bind(this.subscriptionController),unCancelSubscription:this.subscriptionController.unCancelSubscription.bind(this.subscriptionController),getSubscriptionBillingPortalUrl:this.subscriptionController.getBillingPortalUrl.bind(this.subscriptionController),startSubscriptionWithCard:this.subscriptionService.startSubscriptionWithCard.bind(this.subscriptionService),updateSubscriptionCardPaymentMethod:this.subscriptionService.updateSubscriptionCardPaymentMethod.bind(this.subscriptionService),updateSubscriptionCryptoPaymentMethod:this.subscriptionService.updateSubscriptionCryptoPaymentMethod.bind(this.subscriptionService),submitSubscriptionUserEvents:this.subscriptionController.submitUserEvent.bind(this.subscriptionController),linkRewardToShieldSubscription:this.subscriptionService.linkRewardToExistingSubscription.bind(this.subscriptionService),getRewardsCandidateSubscriptionId:this.rewardsController.getCandidateSubscriptionId.bind(this.rewardsController),getRewardsSeasonMetadata:this.rewardsController.getSeasonMetadata.bind(this.rewardsController),getRewardsSeasonStatus:this.rewardsController.getSeasonStatus.bind(this.rewardsController),getRewardsHasAccountOptedIn:this.rewardsController.getHasAccountOptedIn.bind(this.rewardsController),estimateRewardsPoints:this.rewardsController.estimatePoints.bind(this.rewardsController),validateRewardsReferralCode:this.rewardsController.validateReferralCode.bind(this.rewardsController),getRewardsGeoMetadata:this.rewardsController.getRewardsGeoMetadata.bind(this.rewardsController),rewardsOptIn:this.rewardsController.optIn.bind(this.rewardsController),rewardsIsOptInSupported:this.rewardsController.isOptInSupported.bind(this.rewardsController),rewardsGetOptInStatus:this.rewardsController.getOptInStatus.bind(this.rewardsController),rewardsLinkAccountsToSubscriptionCandidate:this.rewardsController.linkAccountsToSubscriptionCandidate.bind(this.rewardsController),getSubmitClaimConfig:this.claimsController.getSubmitClaimConfig.bind(this.claimsController),generateClaimSignature:this.claimsController.generateClaimSignature.bind(this.claimsController),getClaims:this.claimsController.getClaims.bind(this.claimsController),saveClaimDraft:this.claimsController.saveOrUpdateClaimDraft.bind(this.claimsController),getClaimDrafts:this.claimsController.getClaimDrafts.bind(this.claimsController),deleteClaimDraft:this.claimsController.deleteClaimDraft.bind(this.claimsController),deleteAllClaimDrafts:this.claimsController.deleteAllClaimDrafts.bind(this.claimsController),connectHardware:this.connectHardware.bind(this),forgetDevice:this.forgetDevice.bind(this),checkHardwareStatus:this.checkHardwareStatus.bind(this),unlockHardwareWalletAccount:this.unlockHardwareWalletAccount.bind(this),attemptLedgerTransportCreation:this.attemptLedgerTransportCreation.bind(this),getAppNameAndVersion:this.getAppNameAndVersion.bind(this),completeQrCodeScan:n.completeQrCodeScan.bind(n),cancelQrCodeScan:n.cancelQrCodeScan.bind(n),submitPassword:this.submitPassword.bind(this),verifyPassword:this.verifyPassword.bind(this),setActiveNetwork:async e=>await this.multichainNetworkController.setActiveNetwork(e),findNetworkClientIdByChainId:this.networkController.findNetworkClientIdByChainId.bind(this.networkController),getNetworksWithTransactionActivityByAccounts:this.multichainNetworkController.getNetworksWithTransactionActivityByAccounts.bind(this.multichainNetworkController),setActiveNetworkConfigurationId:e=>{this.networkController.setActiveNetwork(e)},setNetworkClientIdForDomain:(e,t)=>this.selectedNetworkController.setNetworkClientIdForDomain(e,t),rollbackToPreviousProvider:m.rollbackToPreviousProvider.bind(m),addNetwork:this._addNetworkAndSetActive.bind(this),updateNetwork:this.networkController.updateNetwork.bind(this.networkController),removeNetwork:this.multichainNetworkController.removeNetwork.bind(this.multichainNetworkController),getCurrentNetworkEIP1559Compatibility:this.networkController.getEIP1559Compatibility.bind(this.networkController),getNetworkConfigurationByNetworkClientId:this.networkController.getNetworkConfigurationByNetworkClientId.bind(this.networkController),setSelectedAddress:e=>{const t=this.accountsController.getAccountByAddress(e);if(!t)throw new Error(`No account found for address: ${e}`);this.accountsController.setSelectedAccount(t.id)},toggleExternalServices:this.toggleExternalServices.bind(this),addToken:v.addToken.bind(v),updateTokenType:v.updateTokenType.bind(v),setFeatureFlag:b.setFeatureFlag.bind(b),setPreference:b.setPreference.bind(b),addKnownMethodData:b.addKnownMethodData.bind(b),setDismissSeedBackUpReminder:b.setDismissSeedBackUpReminder.bind(b),setOverrideContentSecurityPolicyHeader:b.setOverrideContentSecurityPolicyHeader.bind(b),setAdvancedGasFee:b.setAdvancedGasFee.bind(b),setTheme:b.setTheme.bind(b),setSnapsAddSnapAccountModalDismissed:b.setSnapsAddSnapAccountModalDismissed.bind(b),setManageInstitutionalWallets:b.setManageInstitutionalWallets.bind(b),setSelectedInternalAccount:e=>{this.accountsController.getAccount(e)&&this.accountsController.setSelectedAccount(e)},setAccountName:e.setAccountName.bind(e),setAccountLabel:(e,t)=>{const r=this.accountsController.getAccountByAddress(e);if(r===undefined)throw new Error(`No account found for address: ${e}`);this.accountsController.setAccountName(r.id,t)},setSelectedMultichainAccount:e=>{this.accountTreeController.setSelectedAccountGroup(e)},setAccountGroupName:(e,t)=>{this.accountTreeController.setAccountGroupName(e,t)},setAccountGroupPinned:this.accountTreeController.setAccountGroupPinned.bind(this.accountTreeController),setAccountGroupHidden:this.accountTreeController.setAccountGroupHidden.bind(this.accountTreeController),syncAccountTreeWithUserStorage:async()=>{await this.getSnapKeyring(),await this.accountTreeController.syncWithUserStorage()},createNextMultichainAccountGroup:async e=>{await this.multichainAccountService.createNextMultichainAccountGroup({entropySource:e})},alignMultichainWallets:async()=>{this.multichainAccountService&&await this.multichainAccountService.alignWallets()},getTokenStandardAndDetails:this.getTokenStandardAndDetails.bind(this),getTokenSymbol:this.getTokenSymbol.bind(this),getTokenStandardAndDetailsByChain:this.getTokenStandardAndDetailsByChain.bind(this),getERC1155BalanceOf:this.assetsContractController.getERC1155BalanceOf.bind(this.assetsContractController),addNft:i.addNft.bind(i),addNftVerifyOwnership:i.addNftVerifyOwnership.bind(i),removeAndIgnoreNft:i.removeAndIgnoreNft.bind(i),removeNft:i.removeNft.bind(i),checkAndUpdateAllNftsOwnershipStatus:i.checkAndUpdateAllNftsOwnershipStatus.bind(i),checkAndUpdateSingleNftOwnershipStatus:i.checkAndUpdateSingleNftOwnershipStatus.bind(i),isNftOwner:i.isNftOwner.bind(i),setAddressBook:t.set.bind(t),removeFromAddressBook:t.delete.bind(t),setLastActiveTime:n.setLastActiveTime.bind(n),setCurrentExtensionPopupId:n.setCurrentExtensionPopupId.bind(n),setBrowserEnvironment:n.setBrowserEnvironment.bind(n),setDefaultHomeActiveTabName:n.setDefaultHomeActiveTabName.bind(n),setConnectedStatusPopoverHasBeenShown:n.setConnectedStatusPopoverHasBeenShown.bind(n),setRecoveryPhraseReminderHasBeenShown:n.setRecoveryPhraseReminderHasBeenShown.bind(n),setRecoveryPhraseReminderLastShown:n.setRecoveryPhraseReminderLastShown.bind(n),setTermsOfUseLastAgreed:n.setTermsOfUseLastAgreed.bind(n),setSurveyLinkLastClickedOrClosed:n.setSurveyLinkLastClickedOrClosed.bind(n),setOnboardingDate:n.setOnboardingDate.bind(n),setLastViewedUserSurvey:n.setLastViewedUserSurvey.bind(n),setRampCardClosed:n.setRampCardClosed.bind(n),setNewPrivacyPolicyToastClickedOrClosed:n.setNewPrivacyPolicyToastClickedOrClosed.bind(n),setNewPrivacyPolicyToastShownDate:n.setNewPrivacyPolicyToastShownDate.bind(n),setSnapsInstallPrivacyWarningShownStatus:n.setSnapsInstallPrivacyWarningShownStatus.bind(n),setOutdatedBrowserWarningLastShown:n.setOutdatedBrowserWarningLastShown.bind(n),setIsUpdateAvailable:n.setIsUpdateAvailable.bind(n),setUpdateModalLastDismissedAt:n.setUpdateModalLastDismissedAt.bind(n),setLastUpdatedAt:n.setLastUpdatedAt.bind(n),setShowTestnetMessageInDropdown:n.setShowTestnetMessageInDropdown.bind(n),setShowBetaHeader:n.setShowBetaHeader.bind(n),setShowPermissionsTour:n.setShowPermissionsTour.bind(n),setShowAccountBanner:n.setShowAccountBanner.bind(n),setProductTour:n.setProductTour.bind(n),setShowNetworkBanner:n.setShowNetworkBanner.bind(n),updateNftDropDownState:n.updateNftDropDownState.bind(n),getLastInteractedConfirmationInfo:n.getLastInteractedConfirmationInfo.bind(n),deleteDappSwapComparisonData:n.deleteDappSwapComparisonData.bind(n),setLastInteractedConfirmationInfo:n.setLastInteractedConfirmationInfo.bind(n),updateSlides:n.updateSlides.bind(n),removeSlide:n.removeSlide.bind(n),setEnableEnforcedSimulations:n.setEnableEnforcedSimulations.bind(n),setEnableEnforcedSimulationsForTransaction:n.setEnableEnforcedSimulationsForTransaction.bind(n),setEnforcedSimulationsSlippageForTransaction:n.setEnforcedSimulationsSlippageForTransaction.bind(n),setHasShownMultichainAccountsIntroModal:n.setHasShownMultichainAccountsIntroModal.bind(n),updateNetworkConnectionBanner:n.updateNetworkConnectionBanner.bind(n),setShowShieldEntryModalOnce:n.setShowShieldEntryModalOnce.bind(n),setPendingShieldCohort:n.setPendingShieldCohort.bind(n),setShieldPausedToastLastClickedOrClosed:n.setShieldPausedToastLastClickedOrClosed.bind(n),setShieldEndingToastLastClickedOrClosed:n.setShieldEndingToastLastClickedOrClosed.bind(n),setPna25Acknowledged:n.setPna25Acknowledged.bind(n),setAppActiveTab:n.setAppActiveTab.bind(n),setDefaultSubscriptionPaymentOptions:n.setDefaultSubscriptionPaymentOptions.bind(n),setShieldSubscriptionMetricsProps:n.setShieldSubscriptionMetricsProps.bind(n),tryReverseResolveAddress:c.reverseResolveAddress.bind(c),startOAuthLogin:this.oauthService.startOAuthLogin.bind(this.oauthService),setMarketingConsent:this.oauthService.setMarketingConsent.bind(this.oauthService),getMarketingConsent:this.oauthService.getMarketingConsent.bind(this.oauthService),preloadToprfNodeDetails:this.seedlessOnboardingController.preloadToprfNodeDetails.bind(this.seedlessOnboardingController),authenticate:this.seedlessOnboardingController.authenticate.bind(this.seedlessOnboardingController),resetOAuthLoginState:this.seedlessOnboardingController.clearState.bind(this.seedlessOnboardingController),createSeedPhraseBackup:this.createSeedPhraseBackup.bind(this),storeKeyringEncryptionKey:this.seedlessOnboardingController.storeKeyringEncryptionKey.bind(this.seedlessOnboardingController),restoreSocialBackupAndGetSeedPhrase:this.restoreSocialBackupAndGetSeedPhrase.bind(this),syncSeedPhrases:this.syncSeedPhrases.bind(this),changePassword:this.changePassword.bind(this),getIsSeedlessOnboardingUserAuthenticated:this.seedlessOnboardingController.getIsUserAuthenticated.bind(this.seedlessOnboardingController),fetchAndUpdateGatorPermissions:p.fetchAndUpdateGatorPermissions.bind(p),addPendingRevocation:p.addPendingRevocation.bind(p),submitDirectRevocation:p.submitDirectRevocation.bind(p),checkDelegationDisabled:this.checkDelegationDisabled.bind(this),setLocked:this.setLocked.bind(this),createNewVaultAndKeychain:this.createNewVaultAndKeychain.bind(this),createNewVaultAndRestore:this.createNewVaultAndRestore.bind(this),generateNewMnemonicAndAddToVault:this.generateNewMnemonicAndAddToVault.bind(this),importMnemonicToVault:this.importMnemonicToVault.bind(this),exportAccount:this.exportAccount.bind(this),updateTransaction:S.updateTransaction.bind(S),approveTransactionsWithSameNonce:S.approveTransactionsWithSameNonce.bind(S),createCancelTransaction:this.createCancelTransaction.bind(this),createSpeedUpTransaction:this.createSpeedUpTransaction.bind(this),estimateGas:this.estimateGas.bind(this),estimateGasFee:S.estimateGasFee.bind(S),getNextNonce:this.getNextNonce.bind(this),addTransaction:(e,t)=>(0,at.addTransaction)(this.getAddTransactionRequest({transactionParams:e,transactionOptions:t,waitForSubmit:!1})),addTransactionAndWaitForPublish:(e,t)=>(0,at.addTransaction)(this.getAddTransactionRequest({transactionParams:e,transactionOptions:t,waitForSubmit:!0})),createTransactionEventFragment:Ne.createTransactionEventFragmentWithTxId.bind(null,this.getTransactionMetricsRequest()),setTransactionActive:S.setTransactionActive.bind(S),decryptMessage:this.decryptMessageController.decryptMessage.bind(this.decryptMessageController),decryptMessageInline:this.decryptMessageController.decryptMessageInline.bind(this.decryptMessageController),cancelDecryptMessage:this.decryptMessageController.cancelDecryptMessage.bind(this.decryptMessageController),encryptionPublicKey:this.encryptionPublicKeyController.encryptionPublicKey.bind(this.encryptionPublicKeyController),cancelEncryptionPublicKey:this.encryptionPublicKeyController.cancelEncryptionPublicKey.bind(this.encryptionPublicKeyController),setSeedPhraseBackedUp:y.setSeedPhraseBackedUp.bind(y),completeOnboarding:y.completeOnboarding.bind(y),setFirstTimeFlowType:y.setFirstTimeFlowType.bind(y),setAlertEnabledness:r.setAlertEnabledness.bind(r),setUnconnectedAccountAlertShown:r.setUnconnectedAccountAlertShown.bind(r),setWeb3ShimUsageAlertDismissed:r.setWeb3ShimUsageAlertDismissed.bind(r),removePermissionsFor:this.removePermissionsFor,approvePermissionsRequest:this.acceptPermissionsRequest,rejectPermissionsRequest:this.rejectPermissionsRequest,...(0,it.getPermissionBackgroundApiMethods)({permissionController:C,approvalController:k,accountsController:e,networkController:m,multichainNetworkController:g}),disableSnap:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:disable"),enableSnap:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:enable"),updateSnap:(e,t)=>(this.controllerMessenger.call("SnapController:install",e,t),null),removeSnap:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:remove"),handleSnapRequest:this.handleSnapRequest.bind(this),revokeDynamicSnapPermissions:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:revokeDynamicPermissions"),disconnectOriginFromSnap:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:disconnectOrigin"),updateNetworksList:this.updateNetworksList.bind(this),updateAccountsList:this.updateAccountsList.bind(this),setEnabledNetworks:this.setEnabledNetworks.bind(this),setEnabledAllPopularNetworks:this.setEnabledAllPopularNetworks.bind(this),updateHiddenAccountsList:this.updateHiddenAccountsList.bind(this),getPhishingResult:async e=>(await A.maybeUpdateState(),A.test(e)),deleteInterface:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapInterfaceController:deleteInterface"),updateInterfaceState:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapInterfaceController:updateInterfaceState"),fetchAndSetQuotes:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:fetchAndSetQuotes"),setSelectedQuoteAggId:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:setSelectedQuoteAggId"),resetSwapsState:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:resetSwapsState"),setSwapsTokens:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:setSwapsTokens"),clearSwapsQuotes:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:clearSwapsQuotes"),setApproveTxId:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:setApproveTxId"),setTradeTxId:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:setTradeTxId"),setSwapsTxGasPrice:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:setSwapsTxGasPrice"),setSwapsTxGasLimit:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:setSwapsTxGasLimit"),setSwapsTxMaxFeePerGas:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:setSwapsTxMaxFeePerGas"),setSwapsTxMaxFeePriorityPerGas:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:setSwapsTxMaxFeePriorityPerGas"),safeRefetchQuotes:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:safeRefetchQuotes"),stopPollingForQuotes:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:stopPollingForQuotes"),setBackgroundSwapRouteState:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:setBackgroundSwapRouteState"),resetPostFetchState:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:resetPostFetchState"),setSwapsErrorKey:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:setSwapsErrorKey"),setInitialGasEstimate:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:setInitialGasEstimate"),setCustomApproveTxData:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:setCustomApproveTxData"),setSwapsLiveness:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:setSwapsLiveness"),setSwapsFeatureFlags:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:setSwapsFeatureFlags"),setSwapsUserFeeLevel:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:setSwapsUserFeeLevel"),setSwapsQuotesPollingLimitEnabled:this.controllerMessenger.call.bind(this.controllerMessenger,"SwapsController:setSwapsQuotesPollingLimitEnabled"),[O.BridgeBackgroundAction.RESET_STATE]:this.controllerMessenger.call.bind(this.controllerMessenger,`${O.BRIDGE_CONTROLLER_NAME}:${O.BridgeBackgroundAction.RESET_STATE}`),[O.BridgeUserAction.UPDATE_QUOTE_PARAMS]:this.controllerMessenger.call.bind(this.controllerMessenger,`${O.BRIDGE_CONTROLLER_NAME}:${O.BridgeUserAction.UPDATE_QUOTE_PARAMS}`),[O.BridgeBackgroundAction.TRACK_METAMETRICS_EVENT]:this.controllerMessenger.call.bind(this.controllerMessenger,`${O.BRIDGE_CONTROLLER_NAME}:${O.BridgeBackgroundAction.TRACK_METAMETRICS_EVENT}`),[O.BridgeBackgroundAction.FETCH_QUOTES]:this.controllerMessenger.call.bind(this.controllerMessenger,`${O.BRIDGE_CONTROLLER_NAME}:${O.BridgeBackgroundAction.FETCH_QUOTES}`),submitTx:this.controllerMessenger.call.bind(this.controllerMessenger,`${$.BRIDGE_STATUS_CONTROLLER_NAME}:submitTx`),fetchSmartTransactionFees:w.getFees.bind(w),clearSmartTransactionFees:w.clearFees.bind(w),submitSignedTransactions:w.submitSignedTransactions.bind(w),cancelSmartTransaction:w.cancelSmartTransaction.bind(w),fetchSmartTransactionsLiveness:w.fetchLiveness.bind(w),updateSmartTransaction:w.updateSmartTransaction.bind(w),setStatusRefreshInterval:w.setStatusRefreshInterval.bind(w),trackMetaMetricsEvent:h.trackEvent.bind(h),trackMetaMetricsPage:h.trackPage.bind(h),createEventFragment:h.createEventFragment.bind(h),updateEventFragment:h.updateEventFragment.bind(h),finalizeEventFragment:h.finalizeEventFragment.bind(h),trackInsightSnapView:this.trackInsightSnapView.bind(this),updateMetaMetricsTraits:h.updateTraits.bind(h),addEventBeforeMetricsOptIn:h.addEventBeforeMetricsOptIn.bind(h),bufferedTrace:h.bufferedTrace.bind(h),bufferedEndTrace:h.bufferedEndTrace.bind(h),rejectAllPendingApprovals:this.rejectAllPendingApprovals.bind(this),rejectPendingApproval:this.rejectPendingApproval,requestUserApproval:k.addAndShowApprovalRequest.bind(k),resolvePendingApproval:this.resolvePendingApproval,resetViewedNotifications:f.resetViewed.bind(f),updateViewedNotifications:f.updateViewed.bind(f),currencyRateStartPolling:s.startPolling.bind(s),currencyRateStopPollingByPollingToken:s.stopPollingByPollingToken.bind(s),multichainAssetsRatesStartPolling:N.startPolling.bind(N),multichainAssetsRatesStopPollingByPollingToken:N.stopPollingByPollingToken.bind(N),tokenRatesStartPolling:M.startPolling.bind(M),tokenRatesStopPollingByPollingToken:M.stopPollingByPollingToken.bind(M),tokenDetectionStartPolling:l.startPolling.bind(l),tokenDetectionStopPollingByPollingToken:l.stopPollingByPollingToken.bind(l),tokenListStartPolling:d.startPolling.bind(d),tokenListStopPollingByPollingToken:d.stopPollingByPollingToken.bind(d),tokenBalancesStartPolling:a.startPolling.bind(a),tokenBalancesStopPollingByPollingToken:a.stopPollingByPollingToken.bind(a),staticAssetsStartPolling:D.startPolling.bind(D),staticAssetsStopPollingByPollingToken:D.stopPollingByPollingToken.bind(D),updateBalances:a.updateBalances.bind(a),deFiStartPolling:R.startPolling.bind(R),deFiStopPolling:R.stopPollingByPollingToken.bind(R),gasFeeStartPolling:u.startPolling.bind(u),gasFeeStopPollingByPollingToken:u.stopPollingByPollingToken.bind(u),getGasFeeTimeEstimate:u.getTimeEstimate.bind(u),addPollingTokenToAppState:n.addPollingToken.bind(n),removePollingTokenFromAppState:n.removePollingToken.bind(n),updateThrottledOriginState:n.updateThrottledOriginState.bind(n),backupUserData:T.backupUserData.bind(T),restoreUserData:T.restoreUserData.bind(T),detectTokens:l.detectTokens.bind(l),fetchHistoricalPricesForAsset:(...e)=>this.multichainAssetsRatesController.fetchHistoricalPricesForAsset(...e),detectNfts:o.detectNfts.bind(o),addDetectedTokens:v.addDetectedTokens.bind(v),addImportedTokens:v.addTokens.bind(v),ignoreTokens:v.ignoreTokens.bind(v),getBalancesInSingleCall:(...e)=>this.assetsContractController.getBalancesInSingleCall(...e),performSignIn:P.performSignIn.bind(P),performSignOut:P.performSignOut.bind(P),getUserProfileLineage:P.getUserProfileLineage.bind(P),getBearerToken:P.getBearerToken.bind(P),setIsBackupAndSyncFeatureEnabled:E.setIsBackupAndSyncFeatureEnabled.bind(E),deleteAccountSyncingDataFromUserStorage:E.performDeleteStorageAllFeatureEntries.bind(E),syncContactsWithUserStorage:E.syncContactsWithUserStorage.bind(E),checkAccountsPresence:I.checkAccountsPresence.bind(I),createOnChainTriggers:I.createOnChainTriggers.bind(I),disableAccounts:I.disableAccounts.bind(I),enableAccounts:I.enableAccounts.bind(I),fetchAndUpdateMetamaskNotifications:I.fetchAndUpdateMetamaskNotifications.bind(I),deleteNotificationsById:I.deleteNotificationsById.bind(I),getNotificationsByType:I.getNotificationsByType.bind(I),markMetamaskNotificationsAsRead:I.markMetamaskNotificationsAsRead.bind(I),setFeatureAnnouncementsEnabled:I.setFeatureAnnouncementsEnabled.bind(I),enablePushNotifications:_.enablePushNotifications.bind(_),disablePushNotifications:_.disablePushNotifications.bind(_),enableMetamaskNotifications:I.enableMetamaskNotifications.bind(I),disableMetamaskNotifications:I.disableNotificationServices.bind(I),throwTestError:this.throwTestError.bind(this),captureTestError:this.captureTestError.bind(this),updateProposedNames:this.nameController.updateProposedNames.bind(this.nameController),setName:this.nameController.setName.bind(this.nameController),createSnapAccount:async(e,t,r)=>{const n=await this.getSnapKeyring();return await n.createAccount(e,t,r)},multichainAddAssets:(e,t)=>this.multichainAssetsController.addAssets(e,t),multichainIgnoreAssets:(e,t)=>this.multichainAssetsController.ignoreAssets(e,t),multichainUpdateBalance:e=>this.multichainBalancesController.updateBalance(e),multichainUpdateTransactions:e=>this.multichainTransactionsController.updateTransactionsForAccount(e),decodeTransactionData:e=>(0,pt.decodeTransactionData)({...e,provider:this.provider}),createMetaMetricsDataDeletionTask:this.metaMetricsDataDeletionController.createMetaMetricsDataDeletionTask.bind(this.metaMetricsDataDeletionController),updateDataDeletionTaskStatus:this.metaMetricsDataDeletionController.updateDataDeletionTaskStatus.bind(this.metaMetricsDataDeletionController),endTrace:ye.endTrace,isRelaySupported:Dt.isRelaySupported,isSendBundleSupported:Lt.isSendBundleSupported,openUpdateTabAndReload:()=>(0,Ft.openUpdateTabAndReload)(this.requestSafeReload.bind(this)),requestSafeReload:this.requestSafeReload.bind(this),applyTransactionContainersExisting:(e,t)=>(0,Ut.applyTransactionContainersExisting)({containerTypes:t,messenger:this.controllerMessenger,transactionId:e,updateEditableParams:this.txController.updateEditableParams.bind(this.txController)}),lookupSelectedNetworks:this.lookupSelectedNetworks.bind(this),resetWallet:this.resetWallet.bind(this)}}rejectOriginPendingApprovals(e){(0,yt.rejectOriginApprovals)({approvalController:this.approvalController,deleteInterface:e=>this.controllerMessenger.call("SnapInterfaceController:deleteInterface",e),origin:e})}async resetWallet(e=!1){this.authenticationController.performSignOut(),this.seedlessOnboardingController.clearState(),this.subscriptionController.stopAllPolling(),this.subscriptionController.clearState(),this.shieldController.clearState(),this.claimsController.clearState(),e||(this.onboardingController.resetOnboarding(),this.appStateController.setIsWalletResetInProgress(!0))}async exportAccount(e,t){return await this.verifyPassword(t),this.keyringController.exportAccount(t,e)}async getTokenStandardAndDetails(e,t,r){var n,i,o,s;const a=Vr(Xr,this,Zr).call(this),{tokensChainsCache:l}=this.tokenListController.state,c=(null==l||null===(n=l[a])||void 0===n?void 0:n.data)||{},{allTokens:d}=this.tokensController.state,u=(null==d||null===(i=d[a])||void 0===i?void 0:i[t])||[],p={...le.STATIC_MAINNET_TOKEN_LIST[null==e?void 0:e.toLowerCase()]||{},...c[null==e?void 0:e.toLowerCase()]||{},...u.find(({address:t})=>(0,se.isEqualCaseInsensitive)(t,e))||{}},h=(0,se.isEqualCaseInsensitive)(p.standard,I.ERC20)||!0===p.erc20,m=!(r||(0,se.isEqualCaseInsensitive)(p.standard,I.ERC1155)||(0,se.isEqualCaseInsensitive)(p.standard,I.ERC721)||p.erc721),g=p.decimals!==undefined&&p.symbol;let f;if(h||m&&g)try{const r=t?await(0,oe.fetchTokenBalance)(e,t,this.provider):undefined;f={address:e,balance:r,standard:I.ERC20,decimals:p.decimals,symbol:p.symbol}}catch(e){y.default.warn(`Failed to get token balance. Error: ${e}`)}if(f===undefined)try{f=await this.assetsContractController.getTokenStandardAndDetails(e,t,r)}catch(e){y.default.warn(`Failed to get token standard and details. Error: ${e}`)}if(f){if((0,se.isEqualCaseInsensitive)(f.standard,I.ERC1155))try{const n=await(0,oe.fetchERC1155Balance)(e,t,r,this.provider),i=null!=n&&n._hex?parseInt(n._hex,16).toString():null;f={...f,balance:i}}catch(e){y.default.warn("Failed to get token balance. Error:",e)}}return{...f,decimals:null===(o=f)||void 0===o||null===(o=o.decimals)||void 0===o?void 0:o.toString(10),balance:null===(s=f)||void 0===s||null===(s=s.balance)||void 0===s?void 0:s.toString(10)}}async getTokenStandardAndDetailsByChain(e,t,r,n){var i,o,s,a;const{tokensChainsCache:l}=this.tokenListController.state,c=(null==l||null===(i=l[n])||void 0===i?void 0:i.data)||{},{allTokens:d}=this.tokensController.state,u=this.accountsController.getSelectedAccount(),p=(null==d||null===(o=d[n])||void 0===o?void 0:o[u.address])||[];let h={};n===J.CHAIN_IDS.MAINNET&&(h=le.STATIC_MAINNET_TOKEN_LIST[null==e?void 0:e.toLowerCase()]||{});const m=c[null==e?void 0:e.toLowerCase()]||{},g=p.find(({address:t})=>(0,se.isEqualCaseInsensitive)(t,e))||{},f={...h,...m,...g},C=(0,se.isEqualCaseInsensitive)(f.standard,I.ERC20)||!0===f.erc20,b=!(r||(0,se.isEqualCaseInsensitive)(f.standard,I.ERC1155)||(0,se.isEqualCaseInsensitive)(f.standard,I.ERC721)||f.erc721),v=f.decimals!==undefined&&f.symbol;let w;if(C||b&&v)try{let r=0;Vr(Xr,this,Zr).call(this)===n&&(r=await(0,oe.fetchTokenBalance)(e,t,this.provider)),w={address:e,balance:r,standard:I.ERC20,decimals:f.decimals,symbol:f.symbol}}catch(e){y.default.warn(`Failed to get token balance. Error: ${e}`)}if(w===undefined)try{var S,T;const i=null===(S=this.networkController)||void 0===S||null===(S=S.state)||void 0===S||null===(S=S.networkConfigurationsByChainId)||void 0===S||null===(S=S[n])||void 0===S||null===(S=S.rpcEndpoints[null===(T=this.networkController)||void 0===T||null===(T=T.state)||void 0===T||null===(T=T.networkConfigurationsByChainId)||void 0===T||null===(T=T[n])||void 0===T?void 0:T.defaultRpcEndpointIndex])||void 0===S?void 0:S.networkClientId;w=await this.assetsContractController.getTokenStandardAndDetails(e,t,r,i)}catch(e){y.default.warn(`Failed to get token standard and details. Error: ${e}`)}if(w){if((0,se.isEqualCaseInsensitive)(w.standard,I.ERC1155))try{const n=await(0,oe.fetchERC1155Balance)(e,t,r,this.provider),i=null!=n&&n._hex?parseInt(n._hex,16).toString():null;w={...w,balance:i}}catch(e){y.default.warn("Failed to get token balance. Error:",e)}}return{...w,decimals:null===(s=w)||void 0===s||null===(s=s.decimals)||void 0===s?void 0:s.toString(10),balance:null===(a=w)||void 0===a||null===(a=a.balance)||void 0===a?void 0:a.toString(10)}}async getTokenSymbol(e){try{const t=await this.assetsContractController.getTokenStandardAndDetails(e);return null==t?void 0:t.symbol}catch(e){return null}}async createSeedPhraseBackup(e,r,n){let i=!1;try{var o,s;null===(o=(s=this.metaMetricsController).bufferedTrace)||void 0===o||o.call(s,{name:ye.TraceName.OnboardingCreateKeyAndBackupSrp,op:ye.TraceOperation.OnboardingSecurityOp});const a=t.from(r),l=this._convertMnemonicToWordlistIndices(a);await this.seedlessOnboardingController.createToprfKeyAndBackupSeedPhrase(e,l,n),i=!0,await this.syncKeyringEncryptionKey()}catch(e){var a,l;throw null===(a=this.controllerMessenger)||void 0===a||null===(l=a.captureException)||void 0===l||l.call(a,(0,Re.createSentryError)(ye.TraceName.OnboardingCreateKeyAndBackupSrpError,e)),y.default.error("[createSeedPhraseBackup] error",e),e}finally{var c,d;null===(c=(d=this.metaMetricsController).bufferedEndTrace)||void 0===c||c.call(d,{name:ye.TraceName.OnboardingCreateKeyAndBackupSrp,data:{success:i}})}}async fetchAllSecretData(e){let t=!1;try{var r,n;null===(r=(n=this.metaMetricsController).bufferedTrace)||void 0===r||r.call(n,{name:ye.TraceName.OnboardingFetchSrps,op:ye.TraceOperation.OnboardingSecurityOp});const i=await this.seedlessOnboardingController.fetchAllSecretData(e);return t=!0,i}catch(e){throw y.default.error("error while fetching all seed phrases",e),e}finally{var i,o;null===(i=(o=this.metaMetricsController).bufferedEndTrace)||void 0===i||i.call(o,{name:ye.TraceName.OnboardingFetchSrps,data:{success:t}})}}async syncPasswordAndUnlockWallet(e){const t=this.onboardingController.getIsSocialLoginFlow();let r=!1;if(t)try{r=await this.seedlessOnboardingController.checkIsPasswordOutdated({skipCache:!1})}catch(e){y.default.error("error while checking if password is outdated",e)}if(!t||!r)return await this.submitPassword(e),void(t&&this.seedlessOnboardingController.renewRefreshToken(e).catch(e=>{y.default.error("error while revoking seedless refresh token",e)}).finally(()=>{this.seedlessOnboardingController.revokePendingRefreshTokens().catch(e=>{y.default.error("error while revoking pending refresh tokens",e)})}));const n=await this.seedlessOperationMutex.acquire();try{const t=await this.keyringController.verifyPassword(e).then(()=>!0).catch(e=>{if(e.message.includes("Incorrect password"))return!1;throw y.default.error("error while verifying keyring password",e.message),e});await this.seedlessOnboardingController.submitGlobalPassword({globalPassword:e,maxKeyChainLength:20}).catch(e=>{if(y.default.error(`error while submitting global password: ${e.message}`),e instanceof q.RecoveryError){if((null==e?void 0:e.message)===q.SeedlessOnboardingControllerErrorMessage.IncorrectPassword&&t)throw new Error(q.SeedlessOnboardingControllerErrorMessage.OutdatedPassword);throw new g.JsonRpcError(-32603,e.message,e.data)}throw e});const r=await this.seedlessOnboardingController.loadKeyringEncryptionKey();await this.submitEncryptionKey(r);let n=!1;try{var i,o;await this.seedlessOnboardingController.syncLatestGlobalPassword({globalPassword:e}),null===(i=(o=this.metaMetricsController).bufferedTrace)||void 0===i||i.call(o,{name:ye.TraceName.OnboardingResetPassword,op:ye.TraceOperation.OnboardingSecurityOp}),await this.keyringController.changePassword(e),n=!0,await this.syncKeyringEncryptionKey(),await this.seedlessOnboardingController.checkIsPasswordOutdated({skipCache:!0}),this.seedlessOnboardingController.renewRefreshToken(e).catch(e=>{y.default.error("error while revoking seedless refresh token",e)}).finally(()=>{this.seedlessOnboardingController.revokePendingRefreshTokens().catch(e=>{y.default.error("error while revoking pending refresh tokens",e)})})}catch(e){var s,a;throw null===(s=this.controllerMessenger)||void 0===s||null===(a=s.captureException)||void 0===a||a.call(s,(0,Re.createSentryError)(ye.TraceName.OnboardingResetPasswordError,e)),await this.setLocked({skipSeedlessOperationLock:!0}),e}finally{var l,c;null===(l=(c=this.metaMetricsController).bufferedEndTrace)||void 0===l||l.call(c,{name:ye.TraceName.OnboardingResetPassword,data:{success:n}})}}finally{n()}}async syncKeyringEncryptionKey(){const e=await this.keyringController.exportEncryptionKey();await this.seedlessOnboardingController.storeKeyringEncryptionKey(e)}async checkIsSeedlessPasswordOutdated(e=!1){try{const t=this.onboardingController.getIsSocialLoginFlow(),{completedOnboarding:r}=this.onboardingController.state;if(!t||!r)return!1;return await this.seedlessOnboardingController.checkIsPasswordOutdated({skipCache:e})}catch(e){var t,r;throw null===(t=this.controllerMessenger)||void 0===t||null===(r=t.captureException)||void 0===r||r.call(t,(0,Re.createSentryError)("Failed to check if seedless password is outdated",e)),e}}async syncSeedPhrases(){try{if(!this.onboardingController.getIsSocialLoginFlow())throw new Error("Syncing seed phrases is only available for social login flow");const[e,...r]=await this.fetchAllSecretData();if(!e)throw new Error("No root SRP found");for(const e of r){if(!this.seedlessOnboardingController.getSecretDataBackupState(e.data,e.type)){if(e.type===q.SecretType.PrivateKey){await this.importAccountWithStrategy("privateKey",[(0,x.bytesToHex)(e.data)],{shouldCreateSocialBackup:!1,shouldSelectAccount:!1});continue}const r=this._convertEnglishWordlistIndicesToCodepoints(e.data),n=t.from(r).toString("utf8");await this.importMnemonicToVault(n,{shouldCreateSocialBackup:!1,shouldSelectAccount:!1,shouldImportSolanaAccount:!0})}}}catch(t){var e,r;throw y.default.error("error while syncing seed phrases",t),null===(e=this.controllerMessenger)||void 0===e||null===(r=e.captureException)||void 0===r||r.call(e,(0,Re.createSentryError)("Error while syncing seed phrases",t)),t}}async addNewSeedPhraseBackup(e,r,n=!0){const i=t.from(e,"utf8"),o=this._convertMnemonicToWordlistIndices(i);if(n){const e=await this.seedlessOperationMutex.acquire();let t=!1;try{var s,a;null===(s=(a=this.metaMetricsController).bufferedTrace)||void 0===s||s.call(a,{name:ye.TraceName.OnboardingAddSrp,op:ye.TraceOperation.OnboardingSecurityOp}),await this.seedlessOnboardingController.addNewSecretData(o,q.SecretType.Mnemonic,{keyringId:r}),t=!0}catch(e){var l,c;throw null===(l=this.controllerMessenger)||void 0===l||null===(c=l.captureException)||void 0===c||c.call(l,(0,Re.createSentryError)(ye.TraceName.OnboardingAddSrpError,e)),e}finally{var d,u;null===(d=(u=this.metaMetricsController).bufferedEndTrace)||void 0===d||d.call(u,{name:ye.TraceName.OnboardingAddSrp,data:{success:t}}),e()}}else this.seedlessOnboardingController.updateBackupMetadataState({keyringId:r,data:o,type:q.SecretType.Mnemonic})}async changePassword(e,t){const r=await this.seedlessOperationMutex.acquire(),n=this.onboardingController.getIsSocialLoginFlow();try{if(await this.keyringController.changePassword(e),n)try{await this.seedlessOnboardingController.changePassword(e,t);const r=await this.keyringController.exportEncryptionKey();await this.seedlessOnboardingController.storeKeyringEncryptionKey(r)}catch(e){var i,o;y.default.error("error while changing seedless-onboarding password",e),y.default.error("reverting keyring password change"),await this.keyringController.changePassword(t);const r=await this.keyringController.exportEncryptionKey();throw await this.seedlessOnboardingController.storeKeyringEncryptionKey(r),null===(i=this.controllerMessenger)||void 0===i||null===(o=i.captureException)||void 0===o||o.call(i,(0,Re.createSentryError)("error while changing password for social login flow",e)),e}}catch(e){throw y.default.error("error while changing password",e),e}finally{r()}}async createNewVaultAndKeychain(e){const t=await this.createVaultMutex.acquire(),r=this.appStateController.getIsWalletResetInProgress();try{r&&(this.permissionController.clearState(),await this.snapController.clearState(),this.accountTreeController.clearState(),this.accountOrderController.updateHiddenAccountsList([]),this.txController.clearUnapprovedTransactions()),await this.keyringController.createNewVaultAndKeychain(e),this.appStateController.setIsWalletResetInProgress(!1);const t=this.keyringController.state.keyrings[0];return await this.accountsController.updateAccounts(),this.accountTreeController.reinit(),await this.forwardSelectedAccountGroupToSnapKeyring(await this.getSnapKeyring(),this.accountTreeController.getSelectedAccountGroup()),t}finally{t()}}getDiscoveryCountByProvider(e){const t={Bitcoin:0,Solana:0,Tron:0},r=Object.values(F.SolAccountType),n=Object.values(F.BtcAccountType),i=Object.values(F.TrxAccountType);for(const o of e)r.includes(o.type)&&(t.Solana+=1),n.includes(o.type)&&(t.Bitcoin+=1),i.includes(o.type)&&(t.Tron+=1);return t}async discoverAndCreateAccounts(e){(0,ye.trace)({name:ye.TraceName.DiscoverAccounts,op:ye.TraceOperation.AccountDiscover});try{var t;const r=e||(null===(t=this.keyringController.state.keyrings[0])||void 0===t?void 0:t.metadata.id);if(!r)throw new Error("No keyring id to discover accounts for");await this.getSnapKeyring();const n=this.controllerMessenger.call("MultichainAccountService:getMultichainAccountWallet",{entropySource:r}),i=await n.discoverAccounts();return this.getDiscoveryCountByProvider(i)}catch(e){return y.default.warn(`Failed to add accounts with balance. ${e}`),{Bitcoin:0,Solana:0,Tron:0}}finally{(0,ye.endTrace)({name:ye.TraceName.DiscoverAccounts})}}async importMnemonicToVault(e,r={shouldCreateSocialBackup:!0,shouldSelectAccount:!0,shouldImportSolanaAccount:!0}){const{shouldCreateSocialBackup:n,shouldSelectAccount:i,shouldImportSolanaAccount:o}=r,s=await this.createVaultMutex.acquire();try{if(this.keyringController.getKeyringsByType(p.KeyringTypes.hd).some(r=>t.from(this._convertEnglishWordlistIndicesToCodepoints(r.mnemonic)).toString("utf8")===e))throw new Error("This Secret Recovery Phrase has already been imported.");const{id:r}=await this.keyringController.addNewKeyring(p.KeyringTypes.hd,{mnemonic:e,numberOfAccounts:1}),[s]=await this.keyringController.withKeyring({id:r},async({keyring:e})=>e.getAccounts());if(this.onboardingController.getIsSocialLoginFlow())try{await this.addNewSeedPhraseBackup(e,r,n)}catch(e){throw await this.keyringController.removeAccount(s),e}if(i){const e=this.accountsController.getAccountByAddress(s);this.accountsController.setSelectedAccount(e.id)}(async()=>{var e,t;let n;this.isMultichainAccountsFeatureState2Enabled()&&await this.accountTreeController.syncWithUserStorage(),n=this.isMultichainAccountsFeatureState2Enabled()&&o?await this.discoverAndCreateAccounts(r):await this._addAccountsWithBalance(r,o);const i=this.getHDEntropyIndex();this.metaMetricsController.trackEvent({event:ne.MetaMetricsEventName.ImportSecretRecoveryPhrase,properties:{status:"completed",hd_entropy_index:i,number_of_solana_accounts_discovered:null===(e=n)||void 0===e?void 0:e.Solana,number_of_bitcoin_accounts_discovered:null===(t=n)||void 0===t?void 0:t.Bitcoin}})})()}finally{s()}}async restoreSeedPhrasesToVault(e){if(!this.onboardingController.getIsSocialLoginFlow())return;const r=!1,n=!1;for(const i of e){if(this.seedlessOnboardingController.getSecretDataBackupState(i.data,i.type))continue;if(i.type===q.SecretType.PrivateKey){await this.importAccountWithStrategy("privateKey",[(0,x.bytesToHex)(i.data)],{shouldCreateSocialBackup:r,shouldSelectAccount:n});continue}const e=this._convertEnglishWordlistIndicesToCodepoints(i.data),o=t.from(e).toString("utf8");await this.importMnemonicToVault(o,{shouldCreateSocialBackup:r,shouldSelectAccount:n,shouldImportSolanaAccount:false})}}async restoreSocialBackupAndGetSeedPhrase(e){try{const[r,...n]=await this.fetchAllSecretData(e),i=this._convertEnglishWordlistIndicesToCodepoints(r.data),o=t.from(i).toString("utf8"),s=Array.from(t.from(o,"utf8").values());return await this.createNewVaultAndRestore(e,s),n.length>0&&await this.restoreSeedPhrasesToVault(n),o}catch(e){var r,n;if(e instanceof q.RecoveryError)throw new g.JsonRpcError(-32603,e.message,e.data);throw null===(r=this.controllerMessenger)||void 0===r||null===(n=r.captureException)||void 0===n||n.call(r,(0,Re.createSentryError)("Failed to restore social backup and get seed phrase",e)),e}}async generateNewMnemonicAndAddToVault(){const e=await this.createVaultMutex.acquire();try{const{id:e}=await this.keyringController.addNewKeyring(p.KeyringTypes.hd),[t]=await this.keyringController.withKeyring({id:e},async({keyring:e})=>e.getAccounts()),r=this.accountsController.getAccountByAddress(t);return this.accountsController.setSelectedAccount(r.id),t}finally{e()}}async createNewVaultAndRestore(e,r){const n=await this.createVaultMutex.acquire();try{const{completedOnboarding:n}=this.onboardingController.state,i=t.from(r);this.permissionController.clearState(),await this.snapController.clearState(),this.accountTreeController.clearState(),this.accountOrderController.updateHiddenAccountsList([]),this.txController.clearUnapprovedTransactions(),n&&this.tokenDetectionController.enable();const o=this._convertMnemonicToWordlistIndices(i);if(await this.keyringController.createNewVaultAndRestore(e,o),this.appStateController.setIsWalletResetInProgress(!1),await this.accountsController.updateAccounts(),await this.multichainAccountService.init(),this.accountTreeController.reinit(),await this.forwardSelectedAccountGroupToSnapKeyring(await this.getSnapKeyring(),this.accountTreeController.getSelectedAccountGroup()),n){const{useExternalServices:e}=this.preferencesController.state;this.isMultichainAccountsFeatureState2Enabled()&&e?(await this.getSnapKeyring(),await this.accountTreeController.syncWithUserStorageAtLeastOnce(),await this.discoverAndCreateAccounts()):await this._addAccountsWithBalance()}if((0,Pe.getIsSeedlessOnboardingFeatureEnabled)()){if(this.onboardingController.getIsSocialLoginFlow()){const e=this.keyringController.state.keyrings[0].metadata.id;this.seedlessOnboardingController.updateBackupMetadataState({keyringId:e,data:o,type:q.SecretType.Mnemonic}),await this.syncKeyringEncryptionKey()}}}finally{n()}}async _getMultichainWalletSnapClient(e){const t=await this.getSnapKeyring(),r=this.controllerMessenger;return new we.MultichainWalletSnapClient(e,t,r)}async _addAccountsWithBalance(e,t=!0){(0,ye.trace)({name:ye.TraceName.DiscoverAccounts,op:ye.TraceOperation.AccountDiscover});try{const i=Vr(Xr,this,Zr).call(this),o=e?{id:e}:{type:p.KeyringTypes.hd},{accounts:s,entropySource:a}=await this.keyringController.withKeyring(o,async({keyring:e,metadata:t})=>({accounts:await e.getAccounts(),entropySource:t.id}));let l=s[s.length-1];(0,ye.trace)({name:ye.TraceName.EvmDiscoverAccounts,op:ye.TraceOperation.AccountDiscover});try{for(let e=s.length;;e++){if("0x0"===await this.getBalance(l,this.provider)){var r,n;await this.tokenDetectionController.detectTokens({chainIds:[i],selectedAddress:l});const t=null===(r=this.tokensController.state.allTokens)||void 0===r||null===(r=r[i])||void 0===r?void 0:r[l],o=null===(n=this.tokensController.state.allDetectedTokens)||void 0===n||null===(n=n[i])||void 0===n?void 0:n[l];if(0===((null==t?void 0:t.length)??0)&&0===((null==o?void 0:o.length)??0)){1!==e&&await this.removeAccount(l);break}}l=await this.keyringController.withKeyring(o,async({keyring:e})=>{const[t]=await e.addAccounts(1);return t})}}finally{(0,ye.endTrace)({name:ye.TraceName.EvmDiscoverAccounts,op:ye.TraceOperation.AccountDiscover})}const c={Bitcoin:0,Solana:0,Tron:0},d=await this._getMultichainWalletSnapClient(Se.BITCOIN_WALLET_SNAP_ID),u=F.BtcScope.Mainnet,h=await d.discoverAccounts(a,u);if(c.Bitcoin=h.length,0===h.length&&await this._addSnapAccount(a,d,{scope:u,synchronize:!1}),t){const e=await this._getMultichainWalletSnapClient(Te.SOLANA_WALLET_SNAP_ID),t=F.SolScope.Mainnet,r=await e.discoverAccounts(a,t);c.Solana=r.length,0===r.length&&await this._addSnapAccount(a,e,{scope:t})}const m=await this._getMultichainWalletSnapClient(ke.TRON_WALLET_SNAP_ID),g=F.TrxScope.Mainnet,f=await m.discoverAccounts(a,g);return c.Tron=f.length,0===f.length&&await this._addSnapAccount(a,m,{scope:g}),c}catch(e){return y.default.warn(`Failed to add accounts with balance. Error: ${e}`),{Bitcoin:0,Solana:0,Tron:0}}finally{(0,ye.endTrace)({name:ye.TraceName.DiscoverAccounts,op:ye.TraceOperation.AccountDiscover})}}async _importAccountsWithBalances(){const{keyrings:e}=this.keyringController.state;for(const{metadata:t}of e){await this.keyringController.withKeyring({id:t.id},async({keyring:e})=>e.type===p.KeyringTypes.hd)&&(this.isMultichainAccountsFeatureState2Enabled()?(await this.getSnapKeyring(),await this.accountTreeController.syncWithUserStorageAtLeastOnce(),await this.discoverAndCreateAccounts(t.id)):await this._addAccountsWithBalance(t.id,true))}}async _addSnapAccount(e,t,r={}){let n=e;try{if(!n){n=await this.keyringController.withKeyring({type:p.KeyringTypes.hd},async({metadata:e})=>e.id)}return await t.createAccount({...r,entropySource:n},{displayConfirmation:!1,displayAccountNameSuggestion:!1,setSelectedAccount:!1})}catch(e){return y.default.warn(`Failed to add Snap account. Error: ${e}`),(0,X.captureException)(e),null}}_convertMnemonicToWordlistIndices(e){const t=e.toString().split(" ").map(e=>_.wordlist.indexOf(e));return new Uint8Array(new Uint16Array(t).buffer)}_convertEnglishWordlistIndicesToCodepoints(e){return t.from(Array.from(new Uint16Array(e.buffer)).map(e=>_.wordlist[e]).join(" "))}async getBalance(e,t){const r=this.accountTrackerController.state.accountsByChainId[Vr(Xr,this,Zr).call(this)],n=null==r?void 0:r[(0,Ie.toChecksumHexAddress)(e)];if(n&&n.balance)return n.balance;try{return await t.request({method:"eth_getBalance",params:[e,"latest"]})||"0x0"}catch(e){throw y.default.error(e),e}}async submitPassword(e){await this.submitPasswordOrEncryptionKey({password:e})}async submitEncryptionKey(e){await this.submitPasswordOrEncryptionKey({encryptionKey:e})}async submitPasswordOrEncryptionKey({password:e,encryptionKey:t}){const r=this.onboardingController.getIsSocialLoginFlow();await this.offscreenPromise,t?await this.keyringController.submitEncryptionKey(t):(await this.keyringController.submitPassword(e),r&&await this.seedlessOnboardingController.submitPassword(e));try{await this.blockTracker.checkForLatestBlock()}catch(e){y.default.error("Error while unlocking extension.",e)}if(await this.accountsController.updateAccounts(),await this.multichainAccountService.init(),this.accountTreeController.init(),this.forwardSelectedAccountGroupToSnapKeyring(await this.getSnapKeyring(),this.accountTreeController.getSelectedAccountGroup()),this.isMultichainAccountsFeatureState2Enabled()){(async()=>{await this.multichainAccountService.resyncAccounts(),await this.multichainAccountService.alignWallets()})()}}async _loginUser(e){try{await this.submitPassword(e)}finally{this._startUISync()}}_startUISync(){this.emit("startUISync"),this.startUISync=!0,this.memStore.subscribe(this.sendUpdate.bind(this))}async submitEncryptionKeyFromSessionStorage(){try{const{loginToken:e,loginSalt:t}=await this.extension.storage.session.get(["loginToken","loginSalt"]);if(e&&t){const{vault:r}=this.keyringController.state;if(JSON.parse(r).salt!==t)return console.warn("submitEncryptionKey: Stored salt and vault salt do not match"),void await this.clearLoginArtifacts();await this.keyringController.submitEncryptionKey(e,t)}}catch(e){throw await this.clearLoginArtifacts(),e}}async clearLoginArtifacts(){await this.extension.storage.session.remove(["loginToken","loginSalt"])}async verifyPassword(e){await this.keyringController.verifyPassword(e)}getPrimaryKeyringMnemonic(){const[e]=this.keyringController.getKeyringsByType(Z.KeyringType.hdKeyTree);if(!e.mnemonic)throw new Error("Primary keyring mnemonic unavailable.");return e.mnemonic}getPrimaryKeyringMnemonicSeed(){const[e]=this.keyringController.getKeyringsByType(Z.KeyringType.hdKeyTree);if(!e.seed)throw new Error("Primary keyring mnemonic unavailable.");return e.seed}async attemptLedgerTransportCreation(){return await Vr(Xr,this,Qr).call(this,{name:Q.HardwareDeviceNames.ledger},async e=>await e.attemptMakeApp())}async getAppNameAndVersion(){return await Vr(Xr,this,Qr).call(this,{name:Q.HardwareDeviceNames.ledger},async e=>await e.getAppNameAndVersion())}async connectHardware(e,t,r){return Vr(Xr,this,Qr).call(this,{name:e,hdPath:r},async e=>{let r=[];switch(t){case-1:r=await e.getPreviousPage();break;case 1:r=await e.getNextPage();break;default:r=await e.getFirstPage()}return r})}async checkHardwareStatus(e,t){return Vr(Xr,this,Qr).call(this,{name:e,hdPath:t},async e=>e.isUnlocked())}async getHardwareTypeForMetric(e){return await this.keyringController.withKeyring({address:e},({keyring:e})=>Q.KEYRING_DEVICE_PROPERTY_MAP[e.type])}async forgetDevice(e){return Vr(Xr,this,Qr).call(this,{name:e},async e=>{for(const t of await e.getAccounts())this._onAccountRemoved(t);return e.forgetDevice(),!0})}async getAccountType(e){const t=await this.keyringController.getAccountKeyringType(e);switch(t){case Z.KeyringType.trezor:case Z.KeyringType.oneKey:case Z.KeyringType.lattice:case Z.KeyringType.qr:case Z.KeyringType.ledger:return Q.KEYRING_DEVICE_PROPERTY_MAP[t];case Z.KeyringType.imported:return"imported";case Z.KeyringType.snap:return"snap";default:return"MetaMask"}}async getDeviceModel(e){return this.keyringController.withKeyring({address:e},async({keyring:e})=>{switch(e.type){case Z.KeyringType.trezor:case Z.KeyringType.oneKey:return e.getModel();case Z.KeyringType.qr:return e.getName();case Z.KeyringType.ledger:return Q.HardwareDeviceNames.ledger;case Z.KeyringType.lattice:return Q.HardwareDeviceNames.lattice;default:return undefined}})}getAccountLabel(e,t,r){return`${e[0].toUpperCase()}${e.slice(1)} ${parseInt(t,10)+1} ${r||""}`.trim()}async unlockHardwareWalletAccount(e,t,r,n){const{address:i}=await Vr(Xr,this,Qr).call(this,{name:t,hdPath:r},async r=>{r.setAccountToUnlock(e);const[i]=await r.addAccounts(1);return{address:(0,j.normalize)(i),label:this.getAccountLabel(t===Q.HardwareDeviceNames.qr?r.getName():t,e,n)}});this.preferencesController.setSelectedAddress(i);const o=this.accountsController.listAccounts(),{identities:s}=this.preferencesController.state;return{unlockedAccount:i,identities:s,accounts:o}}async addNewAccount(e,t){const r=await this.keyringController.getAccounts(),n=t?{id:t}:{type:p.KeyringTypes.hd},i=await this.keyringController.withKeyring(n,async({keyring:t})=>{if(t.type!==p.KeyringTypes.hd)throw new Error("Cannot add account to non-HD keyring");const n=await t.getAccounts();if(e&&e!==n.length){if(e>n.length)throw new Error("Account out of sequence");const t=n[e];if(!t)throw new Error(`Can't find account at index ${e}`);return t}const[i]=await t.addAccounts(1);if(r.includes(i))throw await t.removeAccount(i),new Error(`Cannot add duplicate ${i} account`);return i});return r.includes(i)||this.preferencesController.setSelectedAddress(i),i}async getSeedPhrase(e,t){return this._convertEnglishWordlistIndicesToCodepoints(await this.keyringController.exportSeedPhrase(e,t))}async resetAccount(){const e=this.accountsController.getSelectedAccount().address,t=Vr(Xr,this,Zr).call(this);return this.txController.wipeTransactions({address:e,chainId:t}),this.smartTransactionsController.wipeSmartTransactions({address:e,ignoreNetwork:!1}),this.bridgeStatusController.wipeBridgeStatus({address:e,ignoreNetwork:!1}),this.networkController.resetConnection(),e}captureKeyringTypesWithMissingIdentities(e=[],t=[]){const r=t.filter(t=>!e.some(e=>e.address.toLowerCase()===t.toLowerCase())).map(e=>this.keyringController.getAccountKeyringType(e)),n=e.length,i=this.accountTrackerController.state.accountsByChainId[Vr(Xr,this,Zr).call(this)],o=Object.keys(i||{}).length;(0,X.captureException)(new Error(`Attempt to get permission specifications failed because their were ${t.length} accounts, but ${n} identities, and the ${r} keyrings included accounts with missing identities. Meanwhile, there are ${o} accounts in the account tracker.`))}sortEvmAccountsByLastSelected(e){const t=this.accountsController.listAccounts();return this.sortAddressesWithInternalAccounts(e,t)}sortMultichainAccountsByLastSelected(e){const t=e=>{var t;const r=this.accountsController.getAccountByAddress(e);if(!r)return undefined;const n=this.multichainAccountService.getAccountContext(r.id);return null==n||null===(t=n.group)||void 0===t||null===(t=t.get({scopes:[F.EthScope.Eoa]}))||void 0===t?void 0:t.metadata.lastSelected};return e.sort((e,r)=>(t(r)??0)-(t(e)??0))}sortAddressesWithInternalAccounts(e,t){return e.sort((r,n)=>{const i=t.find(e=>e.address.toLowerCase()===r.toLowerCase()),o=t.find(e=>e.address.toLowerCase()===n.toLowerCase());if(!i)throw this.captureKeyringTypesWithMissingIdentities(t,e),new Error(`Missing identity for address: "${r}".`);if(!o)throw this.captureKeyringTypesWithMissingIdentities(t,e),new Error(`Missing identity for address: "${n}".`);return i.metadata.lastSelected===o.metadata.lastSelected?0:i.metadata.lastSelected===undefined?1:o.metadata.lastSelected===undefined?-1:o.metadata.lastSelected-i.metadata.lastSelected})}getPermittedAccounts(e){let t;try{t=this.permissionController.getCaveat(e,K.Caip25EndowmentPermissionName,K.Caip25CaveatType)}catch(e){if(e instanceof M.PermissionDoesNotExistError)return[];throw e}const r=(0,K.getEthAccounts)(t.value);return this.sortEvmAccountsByLastSelected(r)}async handleDefiReferral(e,t,r){var n;if(!(null===(n=this.remoteFeatureFlagController)||void 0===n||null===(n=n.state)||void 0===n||null===(n=n.remoteFeatureFlags)||void 0===n||null===(n=n.extensionUxDefiReferralPartners)||void 0===n?void 0:n[e.id]))return;const i=this.getPermittedAccounts(e.origin);if(0===i.length)return;if(this.approvalController.has({origin:e.origin,type:e.approvalType}))return;const o=i[0],s=this.preferencesController.state.referrals[e.id],a=s[o],l=Object.keys(s).filter(e=>s[e]===Qe.ReferralStatus.Declined),c=a===undefined,d=a===Qe.ReferralStatus.Approved;if(c)try{this.metaMetricsController.trackEvent({event:ne.MetaMetricsEventName.ReferralViewed,category:ne.MetaMetricsEventCategory.Referrals,properties:{url:e.origin,trigger_type:r}});const n=await this.approvalController.add({origin:e.origin,type:e.approvalType,requestData:{selectedAddress:o,partnerId:e.id,partnerName:e.name,learnMoreUrl:e.learnMoreUrl},shouldShowRequest:r===nt.ReferralTriggerType.NewConnection});null!=n&&n.approved?(this._handleDefiReferralApprovedAccount(e,o,i,l),await this._handleDefiReferralRedirect(e,t,o)):this.preferencesController.addReferralDeclinedAccount(e.id,o),this.metaMetricsController.trackEvent({event:ne.MetaMetricsEventName.ReferralConfirmButtonClicked,category:ne.MetaMetricsEventCategory.Referrals,properties:{opt_in:Boolean(null==n?void 0:n.approved),url:e.origin}})}catch(e){if(e.code===g.errorCodes.provider.userRejectedRequest)return;throw e}d&&await this._handleDefiReferralRedirect(e,t,o)}async _handleDefiReferralRedirect(e,t,r){await this._updateDefiReferralUrl(e,t),this.preferencesController.addReferralPassedAccount(e.id,r)}_handleDefiReferralApprovedAccount(e,t,r,n){0===n.length?this.preferencesController.setAccountsReferralApproved(e.id,r):(this.preferencesController.addReferralApprovedAccount(e.id,t),r.forEach(t=>{n.includes(t)&&this.preferencesController.removeReferralDeclinedAccount(e.id,t)}))}async _updateDefiReferralUrl(e,t){try{const{url:r}=await o.default.tabs.get(t),{search:n}=new URL(r||""),i=`${e.referralUrl}${n}`;await o.default.tabs.update(t,{url:i})}catch(t){y.default.error(`Failed to update URL to ${e.name} referral page: `,t)}}removeAllScopePermissions(e){this.permissionController.updatePermissionsByCaveat(K.Caip25CaveatType,t=>K.Caip25CaveatMutators[K.Caip25CaveatType].removeScope(t,e))}removeAllAccountPermissions(e){this.permissionController.updatePermissionsByCaveat(K.Caip25CaveatType,t=>K.Caip25CaveatMutators[K.Caip25CaveatType].removeAccount(t,e))}async removeAccount(e){return this._onAccountRemoved(e),await this.keyringController.removeAccount(e),e}async importAccountWithStrategy(e,t,r={shouldCreateSocialBackup:!0,shouldSelectAccount:!0}){const{shouldCreateSocialBackup:n,shouldSelectAccount:i}=r,o=await this.keyringController.importAccountWithStrategy(e,t);if(this.onboardingController.getIsSocialLoginFlow()){const{id:e,privateKey:t}=await this.keyringController.withKeyring({address:o},async({keyring:e,metadata:t})=>{const r=await e.exportAccount(o);return{id:t.id,privateKey:r}});try{await this.addNewPrivateKeyBackup(t,e,n)}catch(e){throw await this.keyringController.removeAccount(o),e}}i&&this.preferencesController.setSelectedAddress(o)}async addNewPrivateKeyBackup(e,t,r=!0){const n=(0,x.hexToBytes)((0,x.add0x)(e));if(r){const e=await this.seedlessOperationMutex.acquire();try{await this.seedlessOnboardingController.addNewSecretData(n,q.SecretType.PrivateKey,{keyringId:t})}catch(e){throw y.default.error("Error adding new private key backup",e),e}finally{e()}}else this.seedlessOnboardingController.updateBackupMetadataState({keyringId:t,data:n,type:q.SecretType.PrivateKey})}async requestPermissionApproval(e,t,r={}){const n=(0,T.nanoid)();return this.approvalController.addAndShowApprovalRequest({id:n,origin:e,requestData:{metadata:{id:n,origin:e},permissions:t,...r},type:M.MethodNames.RequestPermissions})}async requestApprovalPermittedChainsPermission(e,t){const r=(0,K.setPermittedEthChainIds)({requiredScopes:{},optionalScopes:{},sessionProperties:{},isMultichainOrigin:!1},[t]);await this.permissionController.requestPermissionsIncremental({origin:e},{[K.Caip25EndowmentPermissionName]:{caveats:[{type:K.Caip25CaveatType,value:r}]}})}getNonEvmSupportedMethods(e){return this.controllerMessenger.call("MultichainRouter:getSupportedMethods",e)}notifyNonEVMAccountChangedForCurrentAccount(e){let t;try{t=this.permissionController.getCaveat(e,K.Caip25EndowmentPermissionName,K.Caip25CaveatType)}catch{}if(!t)return;const r=(0,K.getSessionScopes)(t.value,{getNonEvmSupportedMethods:this.getNonEvmSupportedMethods.bind(this)});be.NON_EVM_ACCOUNT_CHANGED_CONFIGS.forEach(({network:n,chains:i,notificationProperty:o})=>{var s;if(!(null===(s=t.value.sessionProperties)||void 0===s?void 0:s[o]))return;const a=i.map(e=>r[e]).filter(e=>e!==undefined);if(0===a.length)return;const l=new Set(a.flatMap(e=>e.accounts)),c=Array.from(l).map(e=>{const{address:t}=(0,x.parseCaipAccountId)(e);return t}),[d]=this.sortMultichainAccountsByLastSelected(c);d&&this._notifyMultichainAccountChange(e,[d],n)})}getAddTransactionRequest({transactionParams:e,transactionOptions:t,dappRequest:r,requestContext:n,...i}){var o;const s=(null==n?void 0:n.get("networkClientId"))??(null==t?void 0:t.networkClientId),{chainId:a}=this.networkController.getNetworkConfigurationByNetworkClientId(s);return{internalAccounts:this.accountsController.listAccounts(),dappRequest:r,requestContext:n,networkClientId:s,selectedAccount:this.accountsController.getAccountByAddress(e.from),transactionController:this.txController,transactionOptions:t,transactionParams:e,userOperationController:this.userOperationController,chainId:a,ppomController:this.ppomController,securityAlertsEnabled:null===(o=this.preferencesController.state)||void 0===o?void 0:o.securityAlertsEnabled,updateSecurityAlertResponse:this.updateSecurityAlertResponse.bind(this),getSecurityAlertResponse:this.appStateController.getAddressSecurityAlertResponse.bind(this.appStateController),addSecurityAlertResponse:this.appStateController.addAddressSecurityAlertResponse.bind(this.appStateController),getSecurityAlertsConfig:this.getSecurityAlertsConfig.bind(this),...i}}async createCancelTransaction(e,t,r){await this.txController.stopTransaction(e,t,r);return this.getState()}async createSpeedUpTransaction(e,t,r){await this.txController.speedUpTransaction(e,t,r);return this.getState()}async estimateGas(e){return new Promise((t,r)=>{this.provider.request({method:"eth_estimateGas",params:[e]}).then(e=>t(e.toString(16))).catch(e=>r(e))})}async updateSecurityAlertResponse(e,t,r){return await(0,dt.updateSecurityAlertResponse)({appStateController:this.appStateController,messenger:this.controllerMessenger,method:e,securityAlertId:t,securityAlertResponse:r,signatureController:this.signatureController,transactionController:this.txController})}getHDEntropyIndex(){const e=this.accountsController.getSelectedAccount(),t=this.keyringController.state.keyrings.filter(e=>e.type===p.KeyringTypes.hd).findIndex(t=>t.accounts.includes(e.address));return-1===t?undefined:t}markPasswordForgotten(){this.preferencesController.setPasswordForgotten(!0),this.sendUpdate()}unMarkPasswordForgotten(){this.preferencesController.setPasswordForgotten(!1),this.sendUpdate()}setupUntrustedCommunicationEip1193({connectionStream:e,sender:t,subjectType:r}){if(t.url&&this.onboardingController.state.completedOnboarding&&this.preferencesController.state.usePhishDetect){const{hostname:r}=new URL(t.url);this.phishingController.maybeUpdateState();const n=this.phishingController.test(t.url);if(null!=n&&n.result)return this.sendPhishingWarning(e,r),void this.metaMetricsController.trackEvent({event:ne.MetaMetricsEventName.PhishingPageDisplayed,category:ne.MetaMetricsEventCategory.Phishing,properties:{url:r}})}let n;n=r||(t.id&&t.id!==this.extension.runtime.id?M.SubjectType.Extension:M.SubjectType.Website);const i=(0,Je.setupMultiplex)(e);i.ignoreStream(ct.METAMASK_CAIP_MULTICHAIN_PROVIDER),this.setupProviderConnectionEip1193(i.createStream(ct.METAMASK_EIP_1193_PROVIDER),t,n),t.url&&this.setupPublicConfig(i.createStream("publicConfig"))}setupUntrustedCommunicationCaip({connectionStream:e,sender:t,subjectType:r}){let n;n=r||(t.id&&t.id!==this.extension.runtime.id?M.SubjectType.Extension:M.SubjectType.Website),this.setupProviderConnectionCaip(e,t,n)}setupTrustedCommunication(e,t){const r=(0,Je.setupMultiplex)(e);this.setupControllerConnection(r.createStream("controller")),this.setupProviderConnectionEip1193(r.createStream("provider"),t,M.SubjectType.Internal)}setupPhishingCommunication({connectionStream:e}){const{usePhishDetect:t}=this.preferencesController.state;if(!t)return;const r=(0,Je.setupMultiplex)(e).createStream("metamask-phishing-safelist");r.on("data",(0,et.default)({safelistPhishingDomain:this.safelistPhishingDomain.bind(this),backToSafetyPhishingWarning:this.backToSafetyPhishingWarning.bind(this)},r))}setUpCookieHandlerCommunication({connectionStream:e}){const{metaMetricsId:t,dataCollectionForMarketing:r,participateInMetaMetrics:n}=this.metaMetricsController.state;if(t&&r&&n){const t=(0,Je.setupMultiplex)(e).createStream(ct.METAMASK_COOKIE_HANDLER);t.on("data",(0,et.default)({getCookieFromMarketingPage:this.getCookieFromMarketingPage.bind(this)},t))}}getCookieFromMarketingPage(e){const{ga_client_id:t}=e;this.metaMetricsController.setMarketingCampaignCookieId(t)}sendPhishingWarning(e,t){(0,Je.setupMultiplex)(e).createStream("phishing").write({hostname:t})}setupControllerConnection(e){const t=new gt.PatchStore(this.memStore);let r=!1;const n=()=>{if(!(0,Je.isStreamWritable)(e)||!r)return;const n=t.flushPendingPatches();e.write({jsonrpc:"2.0",method:"sendUpdate",params:[n]})},o={...this.getApi(),...this.controllerApi,startSendingPatches:()=>{r=!0,n()},getStatePatches:()=>t.flushPendingPatches()};this.on("update",n),this.activeControllerConnections+=1,this.emit("controllerConnectionChanged",this.activeControllerConnections),e.on("data",(0,et.default)(o,e));const s=()=>{if(!(0,Je.isStreamWritable)(e))return;const r=this.getState();t.init(),e.write({jsonrpc:"2.0",method:ce.START_UI_SYNC,params:[r]})};this.startUISync?s():this.once("startUISync",s);const a=()=>{e.mmFinished||(this.activeControllerConnections-=1,this.emit("controllerConnectionChanged",this.activeControllerConnections),e.mmFinished=!0,this.removeListener("update",n),t.destroy())};e.mmFinished=!1,(0,i.finished)(e,a),e.once("close",a),e.once("end",a)}setupProviderConnectionEip1193(e,t,r){let n,o;n=r===M.SubjectType.Internal?re.ORIGIN_METAMASK:r===M.SubjectType.Snap?t.snapId:new URL(t.url).origin,t.id&&t.id!==this.extension.runtime.id&&this.subjectMetadataController.addSubjectMetadata({origin:n,extensionId:t.id,subjectType:M.SubjectType.Extension}),t.tab&&t.tab.id&&(o=t.tab.id);let s=n;t.tab&&t.tab.url&&(s=new URL(t.tab.url).origin);const l=this.setupProviderEngineEip1193({origin:n,sender:t,subjectType:r,tabId:o,mainFrameOrigin:s}),c=(0,$e.default)(),d=(0,a.createEngineStream)({engine:l}),u=this.addConnection(n,{tabId:o,apiType:Yr,engine:l});(0,i.pipeline)(e,c,d,e,e=>{var t;l.destroy(),u&&this.removeConnection(n,u),!e||null!==(t=e.message)&&void 0!==t&&t.match("Premature close")||y.default.error(e)}),r!==M.SubjectType.Internal&&this._notifyChainChangeForConnection({engine:l},n)}setupProviderConnectionCaip(e,t,r){let n,o;n=r===M.SubjectType.Internal?re.ORIGIN_METAMASK:r===M.SubjectType.Snap?t.snapId:new URL(t.url).origin,t.id&&t.id!==this.extension.runtime.id&&this.subjectMetadataController.addSubjectMetadata({origin:n,extensionId:t.id,subjectType:M.SubjectType.Extension}),t.tab&&t.tab.id&&(o=t.tab.id);const s=this.setupProviderEngineCaip({origin:n,sender:t,subjectType:r,tabId:o}),l=(0,$e.default)(),c=(0,a.createEngineStream)({engine:s}),d=this.addConnection(n,{tabId:o,apiType:zr,engine:s});setTimeout(()=>this.notifyNonEVMAccountChangedForCurrentAccount(n),500),(0,i.pipeline)(e,l,c,e,e=>{var t;s.destroy(),d&&this.removeConnection(n,d),!e||null!==(t=e.message)&&void 0!==t&&t.match("Premature close")||y.default.error(e)})}setupCommonMiddlewareHooks(e){return{getProviderState:this.getProviderState.bind(this),handleWatchAssetRequest:this.handleWatchAssetRequest.bind(this),requestUserApproval:this.approvalController.addAndShowApprovalRequest.bind(this.approvalController),getCaveat:({target:t,caveatType:r})=>{try{return this.permissionController.getCaveat(e,t,r)}catch(e){if(!(e instanceof M.PermissionDoesNotExistError))throw e}return undefined},requestPermittedChainsPermissionIncrementalForOrigin:t=>(0,K.requestPermittedChainsPermissionIncremental)({...t,origin:e,hooks:{requestPermissionsIncremental:this.permissionController.requestPermissionsIncremental.bind(this.permissionController),grantPermissionsIncremental:this.permissionController.grantPermissionsIncremental.bind(this.permissionController)}}),addNetwork:this._addNetworkAndSetActive.bind(this),updateNetwork:this.networkController.updateNetwork.bind(this.networkController),setActiveNetwork:async t=>{this.permissionController.hasPermission(e,K.Caip25EndowmentPermissionName)?this.selectedNetworkController.setNetworkClientIdForDomain(e,t):await this.networkController.setActiveNetwork(t)},getNetworkConfigurationByChainId:this.networkController.getNetworkConfigurationByChainId.bind(this.networkController),setTokenNetworkFilter:e=>{const{tokenNetworkFilter:t}=this.preferencesController.getPreferences();e&&1===Object.keys(t).length&&this.preferencesController.setPreference("tokenNetworkFilter",{[e]:!0})},setEnabledNetworks:e=>{this.networkEnablementController.enableNetwork(e)},getEnabledNetworks:e=>this.networkEnablementController.state.enabledNetworkMap[e]||{},getCurrentChainIdForDomain:this.getCurrentChainIdForDomain.bind(this),getWeb3ShimUsageState:this.alertController.getWeb3ShimUsageState.bind(this.alertController),setWeb3ShimUsageRecorded:this.alertController.setWeb3ShimUsageRecorded.bind(this.alertController),rejectApprovalRequestsForOrigin:()=>this.rejectOriginPendingApprovals(e)}}setupProviderEngineEip1193({origin:e,subjectType:t,sender:r,tabId:n,mainFrameOrigin:i}){var o;const a=new s.JsonRpcEngine;a.push((0,We.default)({origin:e})),i&&a.push((0,Ye.default)({mainFrameOrigin:i})),a.push((0,P.createSelectedNetworkMiddleware)(this.controllerMessenger));const l=this.selectedNetworkController.getProviderAndBlockTracker(e),c=(0,h.default)(l),u=(0,m.default)(l);u.events.on("notification",e=>a.emit("notification",e)),n&&a.push((0,ze.default)({tabId:n})),a.push((0,qe.default)({origin:e})),a.push(this.permissionLogController.createMiddleware()),a.push((0,ht.default)()),a.push((0,mt.default)({getThrottledOriginState:this.appStateController.getThrottledOriginState.bind(this.appStateController),updateThrottledOriginState:this.appStateController.updateThrottledOriginState.bind(this.appStateController)})),a.push(this.eip7715BlockingMiddleware),a.push((0,Be.createPPOMMiddleware)(this.ppomController,this.preferencesController,this.networkController,this.appStateController,this.accountsController,this.updateSecurityAlertResponse.bind(this),this.getSecurityAlertsConfig.bind(this))),a.push((0,Ue.createDappSwapMiddleware)({fetchQuotes:this.controllerMessenger.call.bind(this.controllerMessenger,`${O.BRIDGE_CONTROLLER_NAME}:${O.BridgeBackgroundAction.FETCH_QUOTES}`),setDappSwapComparisonData:this.appStateController.setDappSwapComparisonData.bind(this.appStateController),getNetworkConfigurationByNetworkClientId:this.networkController.getNetworkConfigurationByNetworkClientId.bind(this.networkController),dappSwapMetricsFlag:null===(o=this.remoteFeatureFlagController)||void 0===o||null===(o=o.state)||void 0===o||null===(o=o.remoteFeatureFlags)||void 0===o?void 0:o.dappSwapMetrics})),a.push((0,Le.createTrustSignalsMiddleware)(this.networkController,this.appStateController,this.phishingController,this.preferencesController,this.getPermittedAccounts.bind(this)));const g=new A.Messenger({namespace:"SnapAndHardwareMessenger",parent:this.controllerMessenger});this.controllerMessenger.delegate({messenger:g,actions:["KeyringController:getKeyringForAccount","KeyringController:getState","SnapController:get","AccountsController:getSelectedAccount"]}),a.push((0,ot.default)({getAccountType:this.getAccountType.bind(this),getDeviceModel:this.getDeviceModel.bind(this),getHDEntropyIndex:this.getHDEntropyIndex.bind(this),getHardwareTypeForMetric:this.getHardwareTypeForMetric.bind(this),snapAndHardwareMessenger:g,appStateController:this.appStateController,metaMetricsController:this.metaMetricsController})),a.push((0,He.createUnsupportedMethodMiddleware)()),t===M.SubjectType.Snap&&(0,Ee.isSnapPreinstalled)(e)&&a.push((0,E.createPreinstalledSnapsMiddleware)({getPermissions:this.permissionController.getPermissions.bind(this.permissionController,e),getAllEvmAccounts:()=>this.controllerMessenger.call("AccountsController:listAccounts").map(e=>e.address),grantPermissions:t=>this.controllerMessenger.call("PermissionController:grantPermissions",{approvedPermissions:t,subject:{origin:e}})})),a.push((0,He.createEthAccountsMethodMiddleware)({getAccounts:this.getPermittedAccounts.bind(this,e)})),t!==M.SubjectType.Internal&&(a.push(this.permissionController.createPermissionMiddleware({origin:e})),a.push((0,nt.createDefiReferralMiddleware)((e,t,r)=>this.handleDefiReferral(e,t,r)))),t===M.SubjectType.Website&&a.push((0,Xe.default)({location:r.url,registerOnboarding:this.onboardingController.registerOnboarding}));const f=new A.Messenger({namespace:"EvmMethodsToNonEvmAccountFilterMessenger",parent:this.controllerMessenger});return this.controllerMessenger.delegate({messenger:f,actions:["AccountsController:getSelectedAccount"]}),a.push((0,ut.default)({messenger:f})),a.push((0,He.createEip1193MethodMiddleware)({...this.setupCommonMiddlewareHooks(e),metamaskState:this.getState(),sendMetrics:this.metaMetricsController.trackEvent.bind(this.metaMetricsController),getAccounts:this.getPermittedAccounts.bind(this,e),getCaip25PermissionFromLegacyPermissionsForOrigin:e=>(0,K.getCaip25PermissionFromLegacyPermissions)(e),getPermissionsForOrigin:this.permissionController.getPermissions.bind(this.permissionController,e),requestPermissionsForOrigin:t=>this.permissionController.requestPermissions({origin:e},t,{metadata:{isEip1193Request:!0}}),revokePermissionsForOrigin:t=>{try{this.permissionController.revokePermissions({[e]:t})}catch(e){console.log(e)}},updateCaveat:this.permissionController.updateCaveat.bind(this.permissionController,e),hasApprovalRequestsForOrigin:()=>this.approvalController.has({origin:e})})),a.push((0,E.createSnapsMethodMiddleware)(t===M.SubjectType.Snap,{clearSnapState:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:clearSnapState",e),getUnlockPromise:this.controllerMessenger.call.bind(this.controllerMessenger,"AppStateController:getUnlockPromise"),getSnaps:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:getPermitted",e),requestPermissions:async t=>await this.permissionController.requestPermissions({origin:e},t),getPermissions:this.permissionController.getPermissions.bind(this.permissionController,e),getSnapFile:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:getFile",e),getSnapState:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:getSnapState",e),updateSnapState:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:updateSnapState",e),installSnaps:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:install",e),invokeSnap:this.permissionController.executeRestrictedMethod.bind(this.permissionController,e,ee.RestrictedMethods.wallet_snap),getIsLocked:()=>{const{isUnlocked:e}=this.controllerMessenger.call("KeyringController:getState");return!e},getIsActive:()=>{const{isUnlocked:e}=this.controllerMessenger.call("KeyringController:getState");return Boolean(this._isClientOpen&&e)},getVersion:()=>"13.18.1",getInterfaceState:(...t)=>this.controllerMessenger.call("SnapInterfaceController:getInterface",e,...t).state,getInterfaceContext:(...t)=>this.controllerMessenger.call("SnapInterfaceController:getInterface",e,...t).context,createInterface:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapInterfaceController:createInterface",e),updateInterface:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapInterfaceController:updateInterface",e),resolveInterface:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapInterfaceController:resolveInterface",e),getSnap:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:get"),trackError:e=>{var t,r;return null===(t=global.sentry)||void 0===t||null===(r=t.captureException)||void 0===r?void 0:r.call(t,e)},trackEvent:this.metaMetricsController.trackEvent.bind(this.metaMetricsController),getAllSnaps:this.controllerMessenger.call.bind(this.controllerMessenger,"SnapController:getAll"),openWebSocket:this.controllerMessenger.call.bind(this.controllerMessenger,"WebSocketService:open",e),closeWebSocket:this.controllerMessenger.call.bind(this.controllerMessenger,"WebSocketService:close",e),getWebSockets:this.controllerMessenger.call.bind(this.controllerMessenger,"WebSocketService:getAll",e),sendWebSocketMessage:this.controllerMessenger.call.bind(this.controllerMessenger,"WebSocketService:sendMessage",e),getCurrencyRate:e=>{const t=this.multichainRatesController.state.rates[e],{fiatCurrency:r}=this.multichainRatesController.state;return t?{...t,currency:r}:undefined},getEntropySources:()=>this.controllerMessenger.call("KeyringController:getState").keyrings.map((e,t)=>e.type===p.KeyringTypes.hd?{id:e.metadata.id,name:e.metadata.name,type:"mnemonic",primary:0===t}:null).filter(Boolean),hasPermission:this.permissionController.hasPermission.bind(this.permissionController,e),scheduleBackgroundEvent:t=>this.controllerMessenger.call("CronjobController:schedule",{...t,snapId:e}),cancelBackgroundEvent:this.controllerMessenger.call.bind(this.controllerMessenger,"CronjobController:cancel",e),getBackgroundEvents:this.controllerMessenger.call.bind(this.controllerMessenger,"CronjobController:get",e),getNetworkConfigurationByChainId:this.controllerMessenger.call.bind(this.controllerMessenger,"NetworkController:getNetworkConfigurationByChainId"),getNetworkClientById:this.controllerMessenger.call.bind(this.controllerMessenger,"NetworkController:getNetworkClientById"),startTrace:e=>{const{_isStandaloneSpan:t,...r}=(0,ye.trace)(e);return r},endTrace:ye.endTrace,handleSnapRpcRequest:t=>this.handleSnapRequest({...t,origin:e}),getAllowedKeyringMethods:(0,De.keyringSnapPermissionsBuilder)(this.subjectMetadataController,e)})),a.push(c),a.push(u.middleware),a.push(this.metamaskMiddleware),a.push(this.eip5792Middleware),t===M.SubjectType.Snap&&(0,Ee.isSnapPreinstalled)(e)&&a.push(this.eip7702Middleware),a.push((0,d.providerAsMiddleware)(l.provider)),a}setupProviderEngineCaip({origin:e,sender:t,subjectType:r,tabId:n}){const i=new s.JsonRpcEngine;i.push((0,We.default)({origin:e})),n&&i.push((0,ze.default)({tabId:n})),i.push((0,qe.default)({origin:e})),i.push((t,r,n,i)=>{const o=(0,W.isSnapId)(e);return(!o||o&&this.permissionController.hasPermission(e,E.SnapEndowments.MultichainProvider))&&[re.MESSAGE_TYPE.WALLET_CREATE_SESSION,re.MESSAGE_TYPE.WALLET_INVOKE_METHOD,re.MESSAGE_TYPE.WALLET_GET_SESSION,re.MESSAGE_TYPE.WALLET_REVOKE_SESSION].includes(t.method)?n():i(g.rpcErrors.methodNotFound({data:{method:t.method}}))});const o=new A.Messenger({namespace:"SnapAndHardwareMessenger",parent:this.controllerMessenger});this.controllerMessenger.delegate({messenger:o,actions:["KeyringController:getKeyringForAccount","KeyringController:getState","SnapController:get","AccountsController:getSelectedAccount"]}),i.push((0,ot.default)({getAccountType:this.getAccountType.bind(this),getDeviceModel:this.getDeviceModel.bind(this),getHDEntropyIndex:this.getHDEntropyIndex.bind(this),getHardwareTypeForMetric:this.getHardwareTypeForMetric.bind(this),snapAndHardwareMessenger:o,appStateController:this.appStateController,metaMetricsController:this.metaMetricsController})),i.push(U.multichainMethodCallValidatorMiddleware);const a=(0,He.makeMethodMiddlewareMaker)([U.walletRevokeSession,U.walletGetSession,U.walletInvokeMethod,U.walletCreateSession]);i.push(a({findNetworkClientIdByChainId:this.networkController.findNetworkClientIdByChainId.bind(this.networkController),listAccounts:this.accountsController.listAccounts.bind(this.accountsController),requestPermissionsForOrigin:(t,r={})=>this.permissionController.requestPermissions({origin:e},t,r),getCaveatForOrigin:this.permissionController.getCaveat.bind(this.permissionController,e),updateCaveat:this.permissionController.updateCaveat.bind(this.permissionController,e),getSelectedNetworkClientId:()=>this.networkController.state.selectedNetworkClientId,revokePermissionForOrigin:this.permissionController.revokePermission.bind(this.permissionController,e),getNonEvmSupportedMethods:this.getNonEvmSupportedMethods.bind(this),isNonEvmScopeSupported:this.controllerMessenger.call.bind(this.controllerMessenger,"MultichainRouter:isSupportedScope"),handleNonEvmRequestForOrigin:t=>this.controllerMessenger.call("MultichainRouter:handleRequest",{...t,origin:e}),getNonEvmAccountAddresses:this.controllerMessenger.call.bind(this.controllerMessenger,"MultichainRouter:getSupportedAccounts"),trackSessionCreatedEvent:e=>this.metaMetricsController.trackEvent({event:ne.MetaMetricsEventName.PermissionsRequested,properties:{api_source:ne.MetaMetricsRequestedThrough.MultichainApi,method:re.MESSAGE_TYPE.WALLET_CREATE_SESSION,chain_id_list:(0,K.getAllScopesFromCaip25CaveatValue)(e)}})})),i.push((0,He.createUnsupportedMethodMiddleware)(new Set([...J.UNSUPPORTED_RPC_METHODS,"eth_requestAccounts","eth_accounts"]))),r===M.SubjectType.Website&&i.push((0,Xe.default)({location:t.url,registerOnboarding:this.onboardingController.registerOnboarding})),i.push((0,He.createMultichainMethodMiddleware)(this.setupCommonMiddlewareHooks(e))),i.push(this.metamaskMiddleware),i.push(this.eip5792Middleware);try{const t=this.permissionController.getCaveat(e,K.Caip25EndowmentPermissionName,K.Caip25CaveatType),r=(0,K.getSessionScopes)(t.value,{getNonEvmSupportedMethods:this.getNonEvmSupportedMethods.bind(this)});Object.entries(r).forEach(([t,r])=>{r.notifications.includes("eth_subscription")&&r.methods.includes("eth_subscribe")&&this.addMultichainApiEthSubscriptionMiddleware({scope:t,origin:e,tabId:n})})}catch(e){}return this.multichainSubscriptionManager.on("notification",(t,r,o)=>{e===t&&n===r&&i.emit("notification",o)}),i.push(this.multichainMiddlewareManager.generateMultichainMiddlewareForOriginAndTabId(e,n)),i.push(async(e,t,r,n)=>{const{provider:i}=this.networkController.getNetworkClientById(e.networkClientId);return t.result=await i.request(e),n()}),i}setupPublicConfig(e){const t=(0,c.storeAsStream)(this.publicConfigStore);(0,i.pipeline)(t,e,e=>{var r;t.destroy(),!e||null!==(r=e.message)&&void 0!==r&&r.match("Premature close")||y.default.error(e)})}addConnection(e,{tabId:t,apiType:r,engine:n}){if(e===re.ORIGIN_METAMASK)return null;this.connections[e]||(this.connections[e]={});const i=(0,T.nanoid)();return this.connections[e][i]={tabId:t,apiType:r,engine:n},i}removeConnection(e,t){const r=this.connections[e];r&&(delete r[t],0===Object.keys(r).length&&delete this.connections[e])}removeAllConnections(e){const t=this.connections[e];t&&Object.keys(t).forEach(t=>{this.removeConnection(e,t)})}notifyConnections(e,t,r){const n=this.connections[e];n&&Object.values(n).forEach(e=>{r&&e.apiType!==r||e.engine&&e.engine.emit("notification",t)})}notifyAllConnections(e,t){const r="function"==typeof e?t=>e(t):()=>e;Object.keys(this.connections).forEach(e=>{Object.values(this.connections[e]).forEach(async n=>{if(!t||n.apiType===t)try{this.notifyConnection(n,await r(e))}catch(e){console.error(e)}})})}notifyConnection(e,t){try{e.engine&&e.engine.emit("notification",t)}catch(e){console.error(e)}}_onUnlock(){this.unMarkPasswordForgotten(),this.emit("unlock")}_onLock(){this.emit("lock")}_onStateUpdate(e){this.isClientOpenAndUnlocked=e.isUnlocked&&this._isClientOpen,this._notifyChainChange()}_onAccountRemoved(e){this.removeAllAccountPermissions(e)}privateSendUpdate(){this.emit("update",this.getState())}isUnlocked(){return this.keyringController.state.isUnlocked}getExternalPendingTransactions(e){return this.smartTransactionsController.getTransactions({addressFrom:e,status:"pending"})}async initializeChainlist(){const e=`cachedFetch:${J.CHAIN_SPEC_URL}`,{cachedResponse:t}=await(0,ie.getStorageItem)(e)||{};t||await(0,ie.setStorageItem)(e,{cachedResponse:(0,w.rawChainData)(),cachedTime:0}),await(0,tt.initializeRpcProviderDomains)()}async getPendingNonce(e,t){const{nonceDetails:r,releaseLock:n}=await this.txController.getNonceLock(e,t),i=r.params.highestSuggested;return n(),i}async getNextNonce(e,t){const r=await this.txController.getNonceLock(e,t);return r.releaseLock(),r.nextNonce}throwTestError(e){setTimeout(()=>{const t=new Error(e);throw t.name="TestError",t})}captureTestError(e){setTimeout(()=>{const t=new Error(e);t.name="TestError",(0,X.captureException)(t)})}getTransactionMetricsRequest(){var e;const t={createEventFragment:this.controllerMessenger.call.bind(this.controllerMessenger,"MetaMetricsController:createEventFragment"),finalizeEventFragment:this.controllerMessenger.call.bind(this.controllerMessenger,"MetaMetricsController:finalizeEventFragment"),getEventFragmentById:this.controllerMessenger.call.bind(this.controllerMessenger,"MetaMetricsController:getEventFragmentById"),getParticipateInMetrics:()=>this.controllerMessenger.call("MetaMetricsController:getState").participateInMetaMetrics,trackEvent:this.controllerMessenger.call.bind(this.controllerMessenger,"MetaMetricsController:trackEvent"),updateEventFragment:this.controllerMessenger.call.bind(this.controllerMessenger,"MetaMetricsController:updateEventFragment"),getAccountBalance:(e,t)=>{var r;return null===(r=this.accountTrackerController.state.accountsByChainId)||void 0===r||null===(r=r[t])||void 0===r||null===(r=r[(0,Ie.toChecksumHexAddress)(e)])||void 0===r?void 0:r.balance},getAccountType:this.getAccountType.bind(this),getDeviceModel:this.getDeviceModel.bind(this),getHardwareTypeForMetric:this.getHardwareTypeForMetric.bind(this),getEIP1559GasFeeEstimates:(...e)=>this.gasFeeController.fetchGasFeeEstimates(...e),getSelectedAddress:()=>this.accountsController.getSelectedAccount().address,getTokenStandardAndDetails:this.getTokenStandardAndDetails.bind(this),getTransaction:e=>this.txController.state.transactions.find(t=>t.id===e),getIsSmartTransaction:e=>(0,he.getIsSmartTransaction)(this._getMetaMaskState(),e),getSmartTransactionByMinedTxHash:e=>this.smartTransactionsController.getSmartTransactionByMinedTxHash(e),getMethodData:e=>{if(!e)return null;const{knownMethodData:t,use4ByteResolution:r}=this.preferencesController.state,n=(0,tt.addHexPrefix)(e);return(0,tt.getMethodDataName)(t,r,n,this.preferencesController.addKnownMethodData.bind(this.preferencesController),this.provider)},getIsConfirmationAdvancedDetailsOpen:()=>this.preferencesController.state.preferences.showConfirmationAdvancedDetails,getHDEntropyIndex:this.getHDEntropyIndex.bind(this),getNetworkRpcUrl:e=>{try{var t;const n=this.networkController.findNetworkClientIdByChainId(e),i=this.networkController.getNetworkConfigurationByNetworkClientId(n);if(i.rpcUrl)return i.rpcUrl;if((null===(t=i.rpcEndpoints)||void 0===t?void 0:t.length)>0){var r;const e=i.defaultRpcEndpointIndex||0;return(null===(r=i.rpcEndpoints[e])||void 0===r?void 0:r.url)||i.rpcEndpoints[0].url}return"unknown"}catch(e){return console.error("Error getting RPC URL:",e),"unknown"}},getFeatureFlags:()=>{var e;return null===(e=this.remoteFeatureFlagController)||void 0===e||null===(e=e.state)||void 0===e?void 0:e.remoteFeatureFlags},getPna25Acknowledged:()=>{var e;return null===(e=this.appStateController)||void 0===e||null===(e=e.state)||void 0===e?void 0:e.pna25Acknowledged},getAddressSecurityAlertResponse:e=>{var t;return null===(t=this.appStateController)||void 0===t?void 0:t.getAddressSecurityAlertResponse(e)},getSecurityAlertsEnabled:()=>{var e;return null===(e=this.preferencesController)||void 0===e||null===(e=e.state)||void 0===e?void 0:e.securityAlertsEnabled}},r=new A.Messenger({namespace:"SnapAndHardwareMessenger",parent:this.controllerMessenger});return this.controllerMessenger.delegate({messenger:r,actions:["KeyringController:getKeyringForAccount","KeyringController:getState","SnapController:get","AccountsController:getSelectedAccount"]}),{...t,snapAndHardwareMessenger:r,provider:null===(e=this.controllerMessenger.call("NetworkController:getSelectedNetworkClient"))||void 0===e?void 0:e.provider}}toggleExternalServices(e){this.preferencesController.toggleExternalServices(e);const t=this.controllerMessenger.call("SubscriptionController:getState"),r=(0,Oe.getIsShieldSubscriptionActive)(t.subscriptions);e?(this.tokenDetectionController.enable(),this.gasFeeController.enableNonRPCGasFeeApis(),r&&this.shieldController.start()):(this.tokenDetectionController.disable(),this.gasFeeController.disableNonRPCGasFeeApis(),this.subscriptionController.stopAllPolling(),r&&this.shieldController.stop())}async setLedgerTransportPreference(e){const t=window.navigator.hid?Q.LedgerTransportTypes.webhid:Q.LedgerTransportTypes.u2f;return null!=e&&e.updateTransportMethod?e.updateTransportMethod(t).catch(e=>{throw e}):undefined}set isClientOpen(e){this._isClientOpen=e;const{isUnlocked:t}=this.controllerMessenger.call("KeyringController:getState");t&&this.controllerMessenger.call("SnapController:setClientActive",e),e?this.controllerMessenger.call("BackendWebSocketService:connect"):this.controllerMessenger.call("BackendWebSocketService:disconnect")}onClientClosed(){try{this.gasFeeController.stopAllPolling(),this.currencyRateController.stopAllPolling(),this.tokenRatesController.stopAllPolling(),this.tokenDetectionController.stopAllPolling(),this.tokenListController.stopAllPolling(),this.tokenBalancesController.stopAllPolling(),this.staticAssetsController.stopAllPolling(),this.appStateController.clearPollingTokens(),this.accountTrackerController.stopAllPolling(),this.deFiPositionsController.stopAllPolling(),this.subscriptionController.stopAllPolling()}catch(e){console.error(e)}}onEnvironmentTypeClosed(e){const t=re.POLLING_TOKEN_ENVIRONMENT_TYPES[e];this.appStateController.state[t].forEach(e=>{this.gasFeeController.stopPollingByPollingToken(e),this.currencyRateController.stopPollingByPollingToken(e),this.tokenRatesController.stopPollingByPollingToken(e),this.tokenDetectionController.stopPollingByPollingToken(e),this.tokenListController.stopPollingByPollingToken(e),this.tokenBalancesController.stopPollingByPollingToken(e),this.staticAssetsController.stopPollingByPollingToken(e),this.accountTrackerController.stopPollingByPollingToken(e),this.appStateController.removePollingToken(e,t)}),this.subscriptionController.stopAllPolling()}safelistPhishingDomain(e){return(0,tt.getPlatform)()===re.PLATFORM_FIREFOX||this.metaMetricsController.trackEvent({category:ne.MetaMetricsEventCategory.Phishing,event:ne.MetaMetricsEventName.ProceedAnywayClicked,properties:{url:e,referrer:{url:e}}},{excludeMetaMetricsId:!0}),this.phishingController.bypass(e)}async backToSafetyPhishingWarning(){this.metaMetricsController.trackEvent({category:ne.MetaMetricsEventCategory.Navigation,event:ne.MetaMetricsEventName.PortfolioLinkClicked,properties:{location:"phishing_page",text:"Back to safety"}}),await this.platform.switchToAnotherURL(undefined,"https://app.metamask.io/?metamaskEntry=phishing_page_portfolio_button")}async setLocked(e={skipSeedlessOperationLock:!1}){const{skipSeedlessOperationLock:t}=e,r=this.onboardingController.getIsSocialLoginFlow();let n;r&&!t&&(n=await this.seedlessOperationMutex.acquire());try{r&&await this.seedlessOnboardingController.setLocked(),await this.keyringController.setLocked(),this.subscriptionController.stopAllPolling();const{isSignedIn:e}=this.authenticationController.state;e&&this.authenticationController.performSignOut()}catch(e){throw y.default.error("Error setting locked state",e),e}finally{n&&n()}}rejectAllPendingApprovals(){(0,yt.rejectAllApprovals)({approvalController:this.approvalController,deleteInterface:e=>this.controllerMessenger.call("SnapInterfaceController:deleteInterface",e)})}async getCode(e,t){const{provider:r}=this.networkController.getNetworkClientById(t);return await r.request({method:"eth_getCode",params:[e]})}async _onAccountChange(e){const t=(0,it.getPermittedAccountsByOrigin)(this.permissionController.state);for(const[r,n]of t.entries())n.includes(e)&&this._notifyAccountsChange(r,n)}_notifyAccountsChange(e,t){this.notifyConnections(e,{method:it.NOTIFICATION_NAMES.accountsChanged,params:t.length<2?t:this.getPermittedAccounts(e)},Yr),this.permissionLogController.updateAccountsHistory(e,t)}async _notifyAuthorizationChange(e,t){this.notifyConnections(e,{method:U.MultichainApiNotifications.sessionChanged,params:{sessionScopes:(0,K.getSessionScopes)(t,{getNonEvmSupportedMethods:this.getNonEvmSupportedMethods.bind(this)})}},zr)}_getSelectedMultichainAccountAddress(e,t){var r;if(!e)return undefined;const n=(0,K.getPermittedAccountsForScopes)(e,t),i=(0,u.uniq)(n.map(e=>(0,x.parseCaipAccountId)(e).address));return null===(r=this.sortMultichainAccountsByLastSelected(i))||void 0===r?void 0:r[0]}async _notifyMultichainAccountChange(e,t,r){this.notifyConnections(e,{method:U.MultichainApiNotifications.walletNotify,params:{scope:r,notification:{method:it.NOTIFICATION_NAMES.accountsChanged,params:t}}},zr)}async _notifyChainChange(){this.notifyAllConnections(async e=>({method:it.NOTIFICATION_NAMES.chainChanged,params:await this.getProviderNetworkState({origin:e})}),Yr)}async _notifyChainChangeForConnection(e,t){this.notifyConnection(e,{method:it.NOTIFICATION_NAMES.chainChanged,params:await this.getProviderNetworkState({origin:t})})}async _onFinishedTransaction(e){if(![R.TransactionStatus.confirmed,R.TransactionStatus.failed].includes(e.status))return;const t=performance.now(),r=(0,ye.trace)({name:ye.TraceName.OnFinishedTransaction,startTime:performance.timeOrigin});(0,ye.trace)({name:ye.TraceName.OnFinishedTransaction,startTime:performance.timeOrigin,parentContext:r,data:{transactionMeta:e}}),await this._createTransactionNotifcation(e),await this._updateNFTOwnership(e),this._trackTransactionFailure(e),await this.tokenBalancesController.updateBalances({chainIds:[e.chainId]}),(0,ye.endTrace)({name:ye.TraceName.OnFinishedTransaction,timestamp:performance.timeOrigin+t})}async _createTransactionNotifcation(e){const{chainId:t}=e;let r={};if(t){var n,i;const e=null===(n=this.networkController.state.networkConfigurationsByChainId)||void 0===n?void 0:n[t];r={blockExplorerUrl:null==e||null===(i=e.blockExplorerUrls)||void 0===i?void 0:i[null==e?void 0:e.defaultBlockExplorerUrlIndex]}}try{await this.platform.showTransactionNotification(e,r)}catch(e){y.default.error("Failed to create transaction notification",e)}}async _updateNFTOwnership(e){var t,r;const{type:n,txParams:i,chainId:o,txReceipt:s}=e,a=this.accountsController.getSelectedAccount().address,{allNfts:l}=this.nftController.state,c=null==s?void 0:s.logs,d=n===R.TransactionType.contractInteraction&&c,u=(n===R.TransactionType.tokenMethodTransferFrom||n===R.TransactionType.tokenMethodSafeTransferFrom)&&i!==undefined;if(!d&&!u)return;const p=null===(t=this.networkController)||void 0===t||null===(t=t.state)||void 0===t||null===(t=t.networkConfigurationsByChainId)||void 0===t||null===(t=t[o])||void 0===t||null===(t=t.rpcEndpoints[null===(r=this.networkController)||void 0===r||null===(r=r.state)||void 0===r||null===(r=r.networkConfigurationsByChainId)||void 0===r||null===(r=r[o])||void 0===r?void 0:r.defaultRpcEndpointIndex])||void 0===t?void 0:t.networkClientId;if(u){var h;const{data:e,to:t,from:r}=i,n=(0,ae.parseStandardTokenTransactionData)(e),s=(0,oe.getTokenIdParam)(n)??(0,de.getTokenValueParam)(n),a=null==l||null===(h=l[r])||void 0===h||null===(h=h[o])||void 0===h?void 0:h.find(({address:e,tokenId:r})=>(0,se.isEqualCaseInsensitive)(e,t)&&r===s);a&&this.nftController.checkAndUpdateSingleNftOwnershipStatus(a,!1,p,{userAddress:r})}else{const e=c.map(e=>{const t=e.topics&&e.topics[0]===me.TRANSFER_SINFLE_LOG_TOPIC_HASH,r=e.topics&&e.topics[0]===me.TOKEN_TRANSFER_LOG_TOPIC_HASH;let n;return t&&(n=e.topics&&e.topics[3]&&e.topics[3].match(null==a?void 0:a.slice(2))),r&&(n=e.topics&&e.topics[2]&&e.topics[2].match(null==a?void 0:a.slice(2))),{isERC1155NftTransfer:t,isERC721NftTransfer:r,isTransferToSelectedAddress:n,...e}});if(0!==e.length){const t=[];e.forEach(e=>{if(e.isTransferToSelectedAddress&&(e.isERC1155NftTransfer||e.isERC721NftTransfer)){let r;r=e.isERC1155NftTransfer?new N.Interface(D.abiERC1155):new N.Interface(D.abiERC721);try{const n=r.parseLog({data:e.data,topics:e.topics});t.push({contract:e.address,...n})}catch(e){}}});const r=[],n=[];t.forEach(e=>{var t;const i=(0,oe.getTokenIdParam)(e),s=null==l||null===(t=l[a])||void 0===t||null===(t=t[o])||void 0===t?void 0:t.find(({address:t,tokenId:r})=>(0,se.isEqualCaseInsensitive)(t,e.contract)&&r===i);s?r.push(s):n.push({tokenId:i,...e})});const i=r.map(async e=>this.nftController.checkAndUpdateSingleNftOwnershipStatus(e,!1,p,{selectedAddress:a}));await Promise.allSettled(i);const s=n.map(async e=>this.nftController.addNft(e.contract,e.tokenId,p));await Promise.allSettled(s)}}}_trackTransactionFailure(e){var t,r;const{txReceipt:n}=e,i=this.getState(),{allTokens:o}=this.tokensController.state,s=this.accountsController.getSelectedAccount(),a=(null==o||null===(t=o[e.chainId])||void 0===t?void 0:t[s.address])||[];n&&"0x0"===n.status&&this.metaMetricsController.trackEvent({event:"Tx Status Update: On-Chain Failure",category:ne.MetaMetricsEventCategory.Background,properties:{action:"Transactions",errorMessage:null===(r=e.simulationFails)||void 0===r?void 0:r.reason,numberOfTokens:a.length,numberOfAccounts:Object.keys(i.accounts).length}},{matomoEvent:!0})}_getMetaMaskState(){return{metamask:this.getState()}}async checkDelegationDisabled(t,r,n){const{encodeDisabledDelegationsCheck:i,decodeDisabledDelegationsResult:o}=await Promise.resolve().then(()=>function(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=qr(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&{}.hasOwnProperty.call(e,o)){var s=i?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}(e("../../shared/lib/delegation/delegation"))),s=i({delegationHash:r}),a=this.networkController.getNetworkClientById(n);return o(await a.provider.request({method:"eth_call",params:[{to:t,data:s},"latest"]}))}async upgradeAccount(e,t,r){const n=this.networkController.findNetworkClientIdByChainId((0,I.toHex)(r));return(0,Y.createEIP7702UpgradeTransaction)({address:e,upgradeContractAddress:t,networkClientId:n},async(e,t)=>await(0,at.addTransaction)(this.getAddTransactionRequest({transactionParams:e,transactionOptions:{...t,origin:"metamask",requireApproval:!0},waitForSubmit:!0})))}async isEip7702Supported(e){const{address:t,chainId:r}=e,n=t,i=await this.txController.isAtomicBatchSupported({address:n,chainIds:[r]}),o=(0,V.findAtomicBatchSupportForChain)(i,r),{isSupported:s,upgradeContractAddress:a}=(0,V.checkEip7702Support)(o);return{isSupported:s,upgradeContractAddress:a}}}async function Qr(e,t){var r,n,i,o,s;const a=null===(r=this.opts.overrides)||void 0===r?void 0:r.keyrings;let l=null;switch(e.name){case Q.HardwareDeviceNames.trezor:l=(null==a||null===(n=a.trezor)||void 0===n?void 0:n.type)||C.TrezorKeyring.type;break;case Q.HardwareDeviceNames.oneKey:l=(null==a||null===(i=a.oneKey)||void 0===i?void 0:i.type)||(null===C.OneKeyKeyring||void 0===C.OneKeyKeyring?void 0:C.OneKeyKeyring.type);break;case Q.HardwareDeviceNames.ledger:l=(null==a||null===(o=a.ledger)||void 0===o?void 0:o.type)||b.LedgerKeyring.type;break;case Q.HardwareDeviceNames.qr:l=S.QrKeyring.type;break;case Q.HardwareDeviceNames.lattice:l=(null==a||null===(s=a.lattice)||void 0===s?void 0:s.type)||v.default.type;break;default:throw new Error("MetamaskController:#withKeyringForDevice - Unknown device")}return this.keyringController.withKeyring({type:l},async({keyring:r})=>{if(e.hdPath&&r.setHdPath&&r.setHdPath(e.hdPath),e.name===Q.HardwareDeviceNames.lattice&&(r.appName="MetaMask"),e.name===Q.HardwareDeviceNames.ledger&&await this.setLedgerTransportPreference(r),e.name===Q.HardwareDeviceNames.trezor||e.name===Q.HardwareDeviceNames.oneKey){const e=r.getModel();this.appStateController.setTrezorModel(e)}return r.network=(0,ge.getProviderConfig)({metamask:this.networkController.state}).type,await t(r)},{createIfMissing:!0})}function Zr(){const e=Vr(Xr,this,en).call(this);return this.networkController.getNetworkClientById(e).configuration.chainId}function en(){return this.networkController.state.selectedNetworkClientId}function tn({existingControllers:e,initFunctions:t,initState:r}){var n;const i={currentMigrationVersion:this.opts.currentMigrationVersion,encryptor:this.opts.encryptor,extension:this.extension,platform:this.platform,getCronjobControllerStorageManager:()=>this.opts.cronjobControllerStorageManager,getFlatState:this.getState.bind(this),getPermittedAccounts:this.getPermittedAccounts.bind(this),getTransactionMetricsRequest:this.getTransactionMetricsRequest.bind(this),getUIState:this.getState.bind(this),infuraProjectId:this.opts.infuraProjectId,initLangCode:this.opts.initLangCode,keyringOverrides:null===(n=this.opts.overrides)||void 0===n?void 0:n.keyrings,offscreenPromise:this.offscreenPromise,preinstalledSnaps:this.opts.preinstalledSnaps,persistedState:r,removeAccount:this.removeAccount.bind(this),removeAllConnections:this.removeAllConnections.bind(this),setupUntrustedCommunicationEip1193:this.setupUntrustedCommunicationEip1193.bind(this),setupUntrustedCommunicationCaip:this.setupUntrustedCommunicationCaip.bind(this),setLocked:this.setLocked.bind(this),showNotification:this.platform._showNotification,showUserConfirmation:this.opts.showUserConfirmation,getAccountType:this.getAccountType.bind(this),getDeviceModel:this.getDeviceModel.bind(this),getHardwareTypeForMetric:this.getHardwareTypeForMetric.bind(this),trace:ye.trace};return(0,At.initControllers)({baseControllerMessenger:this.controllerMessenger,existingControllers:e,initFunctions:t,initRequest:i})}r.default=Jr}).call(this)}).call(this,e("buffer").Buffer)}}},{package:"$root$",file:"app/scripts/metamask-controller.js"}],[382,{lodash:5239},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.default=void 0;var n=e("lodash");r.default={version:2,migrate(e){const t=(0,n.cloneDeep)(e);t.meta.version=2;try{"etherscan"===t.data.config.provider.type&&(t.data.config.provider.type="rpc",t.data.config.provider.rpcTarget="https://rpc.metamask.io/")}catch(e){}return Promise.resolve(t)}}}}},{package:"$root$",file:"app/scripts/migrations/002.js"}]],[],{});